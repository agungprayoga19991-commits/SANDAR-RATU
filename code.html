<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SANDARATU - Sistem Administrasi Kapal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fb;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: white;
      width: 800px; max-width: 95%;
      margin: 30px auto; padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #2c3e50; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .tab {
      flex: 1; padding: 12px;
      text-align: center; cursor: pointer;
      background: #eee; border-radius: 8px 8px 0 0;
      font-weight: bold;
    }
    .tab.active {
      background: linear-gradient(90deg,#4e73df,#7b4ee8);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 12px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input, textarea {
      width: 100%; padding: 8px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button {
      padding: 10px 16px; border: none;
      border-radius: 8px; cursor: pointer;
      background: #4e73df; color: white; font-weight: bold;
    }
    button:hover { background: #3a5ec7; }
    .document-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    .document-item a {
      margin-top: 5px; display: inline-block;
      color: #007bff; text-decoration: none;
    }
    #preview {
      margin-top: 15px; padding: 10px;
      border: 1px solid #ddd; border-radius: 8px;
      background: #f9f9f9;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
<div class="container">
  <h2>üö¢ SANDARATU - Sistem Administrasi Kapal</h2>
  
  <div class="tabs">
    <div class="tab active" onclick="openTab('generate')">Generate QR Code</div>
    <div class="tab" onclick="openTab('scan')">Scan QR Code</div>
    <div class="tab" onclick="openTab('library')">Library Dokumen</div>
  </div>
  
  <!-- Tab Generate -->
  <div id="generate" class="tab-content active">
    <div class="form-group">
      <label for="shipName">Nama Kapal:</label>
      <input type="text" id="shipName" placeholder="Masukkan nama kapal">
    </div>
    <div class="form-group">
      <label for="captainName">Nama Nahkoda:</label>
      <input type="text" id="captainName" placeholder="Masukkan nama nahkoda">
    </div>
    <div class="form-group">
      <label for="departureTime">Tanggal:</label>
      <input type="datetime-local" id="departureTime">
    </div>
    <div class="form-group">
      <label for="cargoType">GT:</label>
      <input type="text" id="cargoType" placeholder="GT">
    </div>

    <!-- Semua file diberi id unik -->
    <div class="form-group"><label>SPB:</label><input type="file" id="spbFile" accept=".pdf"></div>
    <div class="form-group"><label>Crew List:</label><input type="file" id="crewFile" accept=".pdf"></div>
    <div class="form-group"><label>SLO:</label><input type="file" id="sloFile" accept=".pdf"></div>
    <div class="form-group"><label>STBLKK:</label><input type="file" id="stblkkFile" accept=".pdf"></div>
    <div class="form-group"><label>Pernyataan Nahkoda:</label><input type="file" id="pernyataanFile" accept=".pdf"></div>
    <div class="form-group"><label>Perbekalan:</label><input type="file" id="perbekalanFile" accept=".pdf"></div>
    <div class="form-group"><label>Kwitansi Tambat Labuh:</label><input type="file" id="kwitansiFile" accept=".pdf"></div>
    <div class="form-group"><label>Permohonan Penerbitan SPB:</label><input type="file" id="permohonanFile" accept=".pdf"></div>
    <div class="form-group"><label>Daftar ABK dari Nahkoda:</label><input type="file" id="abkFile" accept=".pdf"></div>
    <div class="form-group"><label>Faktur BBM:</label><input type="file" id="bbmFile" accept=".pdf"></div>
    
    <button onclick="generateQRCode()">üö¢ Generate QR Code</button>
    
    <div id="barcodeContainer" style="display:none; margin-top:20px; text-align:center;">
      <div id="qrcode"></div>
      <p><b>ID Dokumen:</b> <span id="documentId"></span></p>
      <button onclick="downloadQRCode()">‚¨áÔ∏è Download QR Code</button>
    </div>
  </div>

  <!-- Tab Scan -->
  <div id="scan" class="tab-content">
    <h3>üì∑ Scan QR Code</h3>
    <div id="reader" style="width:100%; max-width:400px; margin:auto;"></div>
    <div id="preview"></div>
  </div>
  
  <!-- Tab Library -->
  <div id="library" class="tab-content">
    <h3>üìö Library Dokumen</h3>
    <div id="documentList"></div>
  </div>
</div>

<script>
  // === Auto tanggal ===
  function getCurrentDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    return now.toISOString().slice(0,16);
  }
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("departureTime").value = getCurrentDateTime();
  });
  // ====================

  let documents = JSON.parse(localStorage.getItem("sandaratu_docs") || "{}");

  function openTab(tab) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    document.querySelector(`[onclick="openTab('${tab}')"]`).classList.add("active");
    document.getElementById(tab).classList.add("active");
    if (tab === "library") updateDocumentLibrary();
    if (tab === "scan") startScanner();
  }

  // Baca file jadi base64
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function generateQRCode() {
    const shipName = document.getElementById('shipName').value;
    const captainName = document.getElementById('captainName').value;
    const departureTime = document.getElementById('departureTime').value;
    const cargoType = document.getElementById('cargoType').value;

    if (!shipName || !captainName) {
      alert("Nama Kapal dan Nahkoda wajib diisi!");
      return;
    }

    const docId = 'SANDARATU' + Date.now();

    // Ambil semua file upload
    const fileInputs = [
      "spbFile","crewFile","sloFile","stblkkFile","pernyataanFile",
      "perbekalanFile","kwitansiFile","permohonanFile","abkFile","bbmFile"
    ];

    let fileData = {};
    for (let id of fileInputs) {
      const input = document.getElementById(id);
      if (input.files.length > 0) {
        fileData[id] = await readFileAsDataURL(input.files[0]);
      }
    }

    saveDocument(docId, shipName, captainName, departureTime, cargoType, fileData);
  }

  function saveDocument(id, shipName, captainName, departureTime, cargoType, files) {
    const docData = {
      id, shipName, captainName,
      departureTime, cargoType,
      files,
      createdAt: new Date().toLocaleString()
    };

    documents[id] = docData;
    localStorage.setItem('sandaratu_docs', JSON.stringify(documents));

    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
      text: JSON.stringify({ id: id }),
      width: 200, height: 200
    });

    document.getElementById("documentId").textContent = id;
    document.getElementById("barcodeContainer").style.display = "block";
  }

  function updateDocumentLibrary() {
    const list = document.getElementById('documentList');
    list.innerHTML = "";
    Object.values(documents).forEach(doc => {
      let filesHTML = "";
      if (doc.files) {
        Object.entries(doc.files).forEach(([key, fileData]) => {
          filesHTML += `<a href="${fileData}" download="${doc.id}_${key}.pdf">üì• ${key}</a><br>`;
        });
      }

      list.innerHTML += `
        <div class="document-item">
          <b>${doc.shipName}</b> (Nahkoda: ${doc.captainName})<br>
          Berangkat: ${doc.departureTime} | GT: ${doc.cargoType}<br>
          ${filesHTML}
          <small>ID: ${doc.id} | Dibuat: ${doc.createdAt}</small>
        </div>`;
    });
  }

  function downloadQRCode() {
    const canvas = document.querySelector("#qrcode canvas");
    if (canvas) {
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = "qrcode.png";
      link.click();
    }
  }

  // QR Scanner
  let html5QrCode;
  function startScanner() {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("reader");
    }
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        try {
          const data = JSON.parse(decodedText);
          if (data.id && documents[data.id]) {
            const doc = documents[data.id];
            let previewHTML = `
              <b>${doc.shipName}</b> (Nahkoda: ${doc.captainName})<br>
              Berangkat: ${doc.departureTime} | GT: ${doc.cargoType}<br>
              <small>ID: ${doc.id} | Dibuat: ${doc.createdAt}</small><br><br>
            `;

            // Unduh otomatis semua file
            if (doc.files) {
              Object.entries(doc.files).forEach(([key, fileData]) => {
                const link = document.createElement("a");
                link.href = fileData;
                link.download = `${doc.id}_${key}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                previewHTML += `üìÑ ${key}<br>`;
              });
            }

            document.getElementById("preview").innerHTML = previewHTML;
          } else {
            document.getElementById("preview").innerHTML = "‚ùå Dokumen tidak ditemukan!";
          }
        } catch {
          document.getElementById("preview").innerHTML = "‚ùå QR tidak valid!";
        }
        html5QrCode.stop();
      },
      (err) => {}
    ).catch(err => console.error("Scan error:", err));
  }
</script>
</body>
</html>
