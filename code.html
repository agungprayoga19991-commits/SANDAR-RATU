<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f8f9fa;min-height:100vh;display:flex;justify-content:center;align-items:center;}

/* Login Styles */
.login-container{
  background:#fff;
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,0.15);
  max-width:420px;
  width:100%;
  overflow:hidden;
  animation:slideIn 0.6s ease-out;
}

@keyframes slideIn {
  from { opacity:0; transform:translateY(-30px); }
  to { opacity:1; transform:translateY(0); }
}

.logo-section{
  text-align:center;
  padding:40px 30px 20px;
  background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
  position:relative;
  overflow:hidden;
}

.logo-section::before {
  content:'';
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation:rotate 20s linear infinite;
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.logo{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:28px;
  font-weight:800;
  color:#fff;
  text-decoration:none;
  position:relative;
  z-index:2;
  text-shadow:2px 2px 4px rgba(0,0,0,0.3);
}

.logo-icon{
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.2);
  backdrop-filter:blur(10px);
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:20px;
  border:2px solid rgba(255,255,255,0.3);
  animation:pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.warning-section{
  background:linear-gradient(135deg, #fef9e7, #fefcf3);
  border:1px solid #f4d03f;
  margin:20px;
  border-radius:12px;
  padding:20px;
  text-align:center;
  box-shadow:inset 0 2px 10px rgba(244,208,63,0.1);
}

.warning-title{
  background:#fff;
  border:2px solid #f39c12;
  color:#d35400;
  padding:10px 20px;
  border-radius:25px;
  font-weight:700;
  margin-bottom:15px;
  display:inline-block;
  box-shadow:0 4px 15px rgba(243,156,18,0.2);
}

.warning-text{
  color:#8b4513;
  font-size:14px;
  line-height:1.6;
  margin-bottom:15px;
  font-weight:500;
}

.login-method-section{
  padding:25px;
  text-align:center;
}

.method-title{
  color:#6c757d;
  font-size:13px;
  margin-bottom:20px;
  font-style:italic;
  letter-spacing:0.5px;
}

.google-login-btn{
  width:100%;
  padding:15px 20px;
  border:2px solid #e0e0e0;
  background:#fff;
  border-radius:50px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  font-size:15px;
  font-weight:600;
  color:#5f6368;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  overflow:hidden;
  margin-bottom:15px;
}

.google-login-btn::before {
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  background:radial-gradient(circle, rgba(26,115,232,0.1) 0%, transparent 70%);
  border-radius:50%;
  transform:translate(-50%, -50%);
  transition:width 0.3s ease, height 0.3s ease;
}

.google-login-btn:hover::before {
  width:300px;
  height:300px;
}

.google-login-btn:hover{
  border-color:#1a73e8;
  box-shadow:0 8px 25px rgba(26,115,232,0.15);
  transform:translateY(-2px);
}

.google-login-btn:active {
  transform:translateY(0);
}

.google-login-btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none;
}

.google-icon{
  width:20px;
  height:20px;
}

.spinner {
  border: 2px solid #f3f3f3;
  border-top: 2px solid #1a73e8;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: none;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.gdrive-status {
  background: linear-gradient(135deg, #e8f5e8, #f0fdf0);
  border: 2px solid #22c55e;
  padding: 12px;
  border-radius: 12px;
  text-align: center;
  font-size: 13px;
  color: #15803d;
  font-weight: 600;
  margin-top: 10px;
}

.gdrive-status.disconnected {
  background: linear-gradient(135deg, #fef2f2, #fef7f7);
  border-color: #ef4444;
  color: #dc2626;
}

/* Dashboard Styles */
.dashboard{display:none;flex-direction:column;height:100vh;width:100%;background:#f8f9fa;}

.header{
  background:linear-gradient(135deg, #2c3e50, #34495e);
  color:white;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 25px;
  box-shadow:0 4px 20px rgba(0,0,0,0.1);
  position:relative;
}

.header::after {
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:3px;
  background:linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
}

.header .logo-icon{
  background:linear-gradient(135deg, #3498db, #2ecc71);
  width:42px;
  height:42px;
  border-radius:12px;
  display:flex;
  justify-content:center;
  align-items:center;
  margin-right:12px;
  box-shadow:0 4px 15px rgba(52,152,219,0.3);
}

.header .user-info{
  display:flex;
  align-items:center;
  gap:15px;
  background:rgba(255,255,255,0.1);
  padding:8px 15px;
  border-radius:25px;
  backdrop-filter:blur(10px);
}

.header .user-avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  border:3px solid #3498db;
  transition:transform 0.3s ease;
}

.header .user-avatar:hover {
  transform:scale(1.1);
}

.header .user-name {
  font-weight:600;
  font-size:14px;
}

.main-container{display:flex;flex:1;overflow:hidden;}

.sidebar{
  width:260px;
  background:linear-gradient(180deg, #3498db, #2980b9);
  color:white;
  padding-top:20px;
  box-shadow:4px 0 20px rgba(0,0,0,0.1);
  overflow-y:auto;
}

.sidebar div{
  padding:12px 25px;
  font-weight:700;
  opacity:0.9;
  font-size:13px;
  letter-spacing:0.5px;
  background:rgba(0,0,0,0.1);
  margin:5px 15px;
  border-radius:8px;
  text-transform:uppercase;
}

.sidebar a{
  display:flex;
  align-items:center;
  padding:15px 25px;
  color:white;
  text-decoration:none;
  transition:all 0.3s ease;
  cursor:pointer;
  position:relative;
  border-left:4px solid transparent;
}

.sidebar a::before {
  content:'';
  position:absolute;
  left:0;
  top:0;
  width:0;
  height:100%;
  background:rgba(255,255,255,0.1);
  transition:width 0.3s ease;
}

.sidebar a:hover::before {
  width:100%;
}

.sidebar a:hover{
  background:rgba(255,255,255,0.15);
  border-left-color:#fff;
  transform:translateX(5px);
}

.sidebar a.active{
  background:rgba(0,0,0,0.2);
  font-weight:bold;
  border-left-color:#f39c12;
  box-shadow:inset 0 0 20px rgba(0,0,0,0.2);
}

.sidebar a i {
  margin-right:12px;
  width:20px;
  text-align:center;
}

.content{
  flex:1;
  padding:30px;
  overflow-y:auto;
  background:#f8f9fa;
  position:relative;
}

.content h2{
  margin-bottom:25px;
  color:#2c3e50;
  font-size:28px;
  font-weight:700;
  position:relative;
  padding-bottom:10px;
}

.content h2::after {
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  width:50px;
  height:4px;
  background:linear-gradient(90deg, #3498db, #2ecc71);
  border-radius:2px;
}

.card{
  background:white;
  padding:30px;
  border-radius:15px;
  margin-bottom:25px;
  box-shadow:0 10px 40px rgba(0,0,0,0.08);
  border:1px solid #e9ecef;
  transition:transform 0.3s ease, box-shadow 0.3s ease;
  position:relative;
  overflow:hidden;
}

.card::before {
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:4px;
  background:linear-gradient(90deg, #667eea, #764ba2);
}

.card:hover {
  transform:translateY(-5px);
  box-shadow:0 15px 50px rgba(0,0,0,0.12);
}

.form-row{display:flex;gap:20px;margin-bottom:20px;}
.form-row .form-control{flex:1;}

.form-control{
  width:100%;
  padding:15px 18px;
  margin-bottom:20px;
  border:2px solid #e9ecef;
  border-radius:10px;
  font-size:14px;
  transition:all 0.3s ease;
  background:#fff;
}

.form-control:focus {
  outline:none;
  border-color:#3498db;
  box-shadow:0 0 20px rgba(52,152,219,0.1);
  transform:translateY(-2px);
}

.form-control::placeholder {
  color:#adb5bd;
}

.btn-generate{
  width:100%;
  padding:15px;
  background:linear-gradient(135deg, #2ecc71, #27ae60);
  border:none;
  color:white;
  border-radius:50px;
  font-weight:700;
  cursor:pointer;
  margin-bottom:15px;
  font-size:15px;
  transition:all 0.3s ease;
  box-shadow:0 6px 20px rgba(46,204,113,0.3);
  position:relative;
  overflow:hidden;
}

.btn-generate::before {
  content:'';
  position:absolute;
  top:50%;
  left:50%;
  width:0;
  height:0;
  background:rgba(255,255,255,0.2);
  border-radius:50%;
  transform:translate(-50%, -50%);
  transition:width 0.4s ease, height 0.4s ease;
}

.btn-generate:hover::before {
  width:300px;
  height:300px;
}

.btn-generate:hover{
  background:linear-gradient(135deg, #27ae60, #229954);
  transform:translateY(-3px);
  box-shadow:0 10px 30px rgba(46,204,113,0.4);
}

.btn-logout{
  background:linear-gradient(135deg, #e74c3c, #c0392b);
  color:#fff;
  border:none;
  padding:10px 20px;
  border-radius:25px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.3s ease;
  box-shadow:0 4px 15px rgba(231,76,60,0.3);
}

.btn-logout:hover {
  background:linear-gradient(135deg, #c0392b, #a93226);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(231,76,60,0.4);
}

.result-container{margin-top:20px;}

.preview-container{
  margin-top:15px;
  padding:20px;
  background:#f8f9fa;
  border:2px dashed #dee2e6;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:15px;
  transition:all 0.3s ease;
}

.preview-container:hover {
  border-color:#3498db;
  background:#f1f8ff;
}

.document-info{
  background:#fff;
  padding:15px;
  border-radius:8px;
  border-left:5px solid #3498db;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}

.document-info h4{
  color:#2c3e50;
  margin-bottom:8px;
  font-size:16px;
}

.document-info p{
  color:#7f8c8d;
  font-size:13px;
  line-height:1.4;
}

.preview-container embed,.preview-container img{
  width:100%;
  max-height:350px;
  border-radius:8px;
  object-fit:contain;
  border:2px solid #e9ecef;
  box-shadow:0 4px 15px rgba(0,0,0,0.1);
}

.preview-container a{
  align-self:flex-start;
  text-decoration:none;
  color:#fff;
  font-weight:600;
  padding:10px 20px;
  background:linear-gradient(135deg, #2980b9, #3498db);
  border-radius:25px;
  transition:all 0.3s ease;
  box-shadow:0 4px 15px rgba(52,152,219,0.3);
}

.preview-container a:hover {
  background:linear-gradient(135deg, #1f618d, #2980b9);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(52,152,219,0.4);
}

.qr-section{
  background:linear-gradient(135deg, #fff, #f8f9fa);
  padding:25px;
  border-radius:15px;
  text-align:center;
  border:3px solid #3498db;
  margin-bottom:20px;
  box-shadow:0 10px 30px rgba(52,152,219,0.1);
}

.qr-section h3{
  color:#2c3e50;
  margin-bottom:15px;
  font-size:20px;
  font-weight:700;
}

.qr-info{
  background:linear-gradient(135deg, #e8f6ff, #f0f9ff);
  padding:15px;
  border-radius:10px;
  margin-top:15px;
  border:2px solid #3498db;
  box-shadow:inset 0 2px 10px rgba(52,152,219,0.1);
}

.qr-info p{
  margin:5px 0;
  font-size:13px;
  color:#2c3e50;
  font-weight:500;
}

.qr-url{
  background:#fff;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  word-break:break-all;
  font-family:'Courier New', monospace;
  font-size:12px;
  border:2px solid #bdc3c7;
  max-height:80px;
  overflow-y:auto;
  box-shadow:inset 0 2px 5px rgba(0,0,0,0.1);
}

.document-summary{
  background:linear-gradient(135deg, #fff, #f8fffe);
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  border-left:5px solid #27ae60;
  box-shadow:0 6px 20px rgba(39,174,96,0.1);
}

.document-summary h3{
  color:#2c3e50;
  margin-bottom:15px;
  font-size:18px;
  font-weight:700;
}

.document-summary table{
  width:100%;
  border-collapse:collapse;
}

.document-summary table td{
  padding:8px 12px;
  border-bottom:1px solid #ecf0f1;
  vertical-align:top;
}

.document-summary table td:first-child{
  font-weight:700;
  width:35%;
  color:#34495e;
}

.form-type-indicator{
  background:linear-gradient(135deg, #e8f4f8, #d5edf5);
  border:3px solid #3498db;
  padding:15px;
  border-radius:12px;
  margin-bottom:20px;
  text-align:center;
  box-shadow:0 4px 15px rgba(52,152,219,0.1);
}

.form-type-indicator h3{
  color:#2c3e50;
  margin:0;
  font-size:18px;
  font-weight:700;
}

.test-qr-btn{
  background:linear-gradient(135deg, #e74c3c, #c0392b);
  color:white;
  border:none;
  padding:8px 15px;
  border-radius:20px;
  cursor:pointer;
  margin:5px;
  font-size:12px;
  font-weight:600;
  transition:all 0.3s ease;
  box-shadow:0 3px 10px rgba(231,76,60,0.3);
}

.test-qr-btn:hover{
  background:linear-gradient(135deg, #c0392b, #a93226);
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(231,76,60,0.4);
}

.content-page{display:none;}
.content-page.active{display:block;}

.document-label{
  display:block;
  margin-bottom:15px;
  font-weight:700;
  color:#2c3e50;
  font-size:14px;
}

.document-label input{
  margin-top:8px;
  border:2px dashed #bdc3c7;
  transition:all 0.3s ease;
}

.document-label input:hover {
  border-color:#3498db;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  border-left: 5px solid #4caf50;
  z-index: 10000;
  transform: translateX(400px);
  transition: transform 0.3s ease;
}

.notification.show {
  transform: translateX(0);
}

.notification.error {
  border-left-color: #f44336;
}

.notification.warning {
  border-left-color: #ff9800;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid #e9ecef;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.gdrive-section {
  background: linear-gradient(135deg, #f8faff, #e6f3ff);
  border: 2px solid #3498db;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  text-align: center;
}

.gdrive-section h4 {
  color: #2c3e50;
  margin-bottom: 15px;
  font-size: 16px;
}

.gdrive-btn {
  background: linear-gradient(135deg, #4285f4, #3367d6);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  margin: 5px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
}

.gdrive-btn:hover {
  background: linear-gradient(135deg, #3367d6, #2c5aa0);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
}

.gdrive-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.empty-form-notice {
  background: linear-gradient(135deg, #fff8e1, #fffbf0);
  border: 2px solid #ffc107;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  text-align: center;
  color: #f57c00;
  font-weight: 600;
}

/* Responsive Design */
@media (max-width: 768px) {
  .sidebar { width: 100%; height: auto; }
  .main-container { flex-direction: column; }
  .form-row { flex-direction: column; }
  .login-container { margin: 20px; }
  .content { padding: 20px; }
  .card { padding: 20px; }
}

.footer-login{
  text-align:center;
  padding:20px;
  color:#6c757d;
  font-size:12px;
  border-top:1px solid #e9ecef;
  background:#f8f9fa;
  font-weight:500;
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <div class="logo-section">
    <a href="#" class="logo">
      <div class="logo-icon">
        <i class="fas fa-anchor"></i>
      </div>
      SANDAR-RATU
    </a>
  </div>
  
  <div class="warning-section">
    <div class="warning-title">🔒 Peringatan Keamanan</div>
    <div class="warning-text">
      Halaman ini memerlukan autentikasi untuk mengakses sistem administrasi pelabuhan.<br>
      Silakan klik tombol login di bawah untuk melanjutkan.<br>
      <strong>Terima kasih atas kerja sama Anda.</strong>
    </div>
  </div>
  
  <div class="login-method-section">
    <div class="method-title">- pilih metode login -</div>
    <button id="loginBtn" class="google-login-btn">
      <div class="spinner" id="loginSpinner"></div>
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span id="loginBtnText">Login dengan Google Drive</span>
    </button>
    
    <button id="simulationBtn" class="google-login-btn" style="background: linear-gradient(135deg, #ffc107, #ffca28);">
      <i class="fas fa-flask"></i>
      <span>Login Simulasi (Tanpa Google Drive)</span>
    </button>
    
    <div id="gdriveStatus" class="gdrive-status disconnected">
      <i class="fas fa-cloud-upload-alt"></i> Google Drive: Belum Terhubung
    </div>
  </div>
  
  <div class="footer-login">Hak Cipta © 2025 Sandar-Ratu | PPN Palabuhanratu</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard">
  <div class="header">
    <div style="display:flex;align-items:center;">
      <div class="logo-icon"><i class="fas fa-anchor"></i></div>
      <strong>SANDAR-RATU</strong>
    </div>
    <div style="display:flex;align-items:center;gap:15px;">
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='%233498db'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="User">
        <div>
          <div class="user-name" id="userName">Demo User</div>
          <div style="font-size:11px;opacity:0.8;" id="userEmail">demo@sandar-ratu.com</div>
        </div>
      </div>
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Keluar
      </button>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar">
      <div>👨‍✈️ PETUGAS SYAHBANDAR</div>
      <a onclick="showPage('departurePetugas', this)" class="active">
        <i class="fas fa-ship"></i> Keberangkatan Kapal
      </a>
      <a onclick="showPage('arrivalPetugas', this)">
        <i class="fas fa-anchor"></i> Kedatangan Kapal
      </a>
      <div>🚢 IZIN NELAYAN</div>
      <a onclick="showPage('departureNelayan', this)">
        <i class="fas fa-fish"></i> Keberangkatan Nelayan
      </a>
      <a onclick="showPage('arrivalNelayan', this)">
        <i class="fas fa-water"></i> Kedatangan Nelayan
      </a>
      <div>📊 LAPORAN & DATA</div>
      <a onclick="showPage('reports', this)">
        <i class="fas fa-chart-bar"></i> Statistik & Laporan
      </a>
    </div>

    <div class="content" id="mainContent">
      <!-- Petugas Keberangkatan -->
      <div id="departurePetugas" class="content-page active">
        <h2>⚓ Petugas - Keberangkatan Kapal</h2>
        <div class="card">
          <div class="form-type-indicator">
            <h3>📋 Form Petugas - Keberangkatan</h3>
          </div>
          
          <div class="gdrive-section">
            <h4><i class="fab fa-google-drive"></i> Google Drive Integration</h4>
            <button id="connectGDrive" class="gdrive-btn" onclick="initializeGapi()">
              <i class="fab fa-google-drive"></i> Hubungkan Google Drive
            </button>
            <button id="uploadToGDrive" class="gdrive-btn" onclick="uploadAllToGDrive(this)" disabled>
              <i class="fas fa-cloud-upload-alt"></i> Upload ke Google Drive
            </button>
            <div id="gdriveStatusDashboard" style="margin-top:10px;font-size:13px;color:#7f8c8d;">
              Status: Belum terhubung
            </div>
          </div>
          
          <div class="empty-form-notice">
            <i class="fas fa-info-circle"></i> Form dapat digenerate meskipun kosong - sistem akan mengisi dengan data default
          </div>
          
          <form data-form-type="Petugas-Keberangkatan">
            <div class="form-row">
              <div style="flex:2;">
                <input type="text" class="form-control" placeholder="Nama Kapal (opsional)">
              </div>
              <div style="flex:1;">
                <input type="text" class="form-control" placeholder="IMO Number (opsional)">
              </div>
            </div>
            
            <div class="form-row">
              <input type="date" class="form-control">
              <input type="time" class="form-control">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Nama Nahkoda (opsional)">
              <input type="text" class="form-control" placeholder="GT (Gross Tonnage) (opsional)">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Pelabuhan Tujuan (opsional)">
              <select class="form-control">
                <option value="">Pilih Jenis Kapal (opsional)</option>
                <option value="Kapal Penumpang">Kapal Penumpang</option>
                <option value="Kapal Barang">Kapal Barang</option>
                <option value="Kapal Tanker">Kapal Tanker</option>
                <option value="Kapal Ikan">Kapal Ikan</option>
                <option value="Kapal Pesiar">Kapal Pesiar</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            
            <h4 style="margin:20px 0 15px;color:#2c3e50;">📎 Upload Dokumen (Opsional)</h4>
            <label class="document-label">SPB (Surat Persetujuan Berlayar): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Crew List (Daftar Awak Kapal): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Perbekalan: 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">SLO (Surat Laik Operasi): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Pernyataan Nahkoda:
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Kwitansi Tambat Labuh: 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            
            <div style="margin-top:30px;">
              <button type="button" class="btn-generate" onclick="generateAll(this)">
                <i class="fas fa-qrcode"></i> Generate QR & Preview Dokumen
              </button>
              <button type="button" class="btn-generate" onclick="downloadAll(this)" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                <i class="fas fa-download"></i> Download PDF Lengkap
              </button>
            </div>
          </form>
          <div class="result-container"></div>
        </div>
      </div>

      <!-- Petugas Kedatangan -->
      <div id="arrivalPetugas" class="content-page">
        <h2>⚓ Petugas - Kedatangan Kapal</h2>
        <div class="card">
          <div class="form-type-indicator">
            <h3>📋 Form Petugas - Kedatangan</h3>
          </div>
          
          <div class="gdrive-section">
            <h4><i class="fab fa-google-drive"></i> Google Drive Integration</h4>
            <button class="gdrive-btn" onclick="uploadAllToGDrive(this)" disabled>
              <i class="fas fa-cloud-upload-alt"></i> Upload ke Google Drive
            </button>
          </div>
          
          <div class="empty-form-notice">
            <i class="fas fa-info-circle"></i> Form dapat digenerate meskipun kosong - sistem akan mengisi dengan data default
          </div>
          
          <form data-form-type="Petugas-Kedatangan">
            <div class="form-row">
              <div style="flex:2;">
                <input type="text" class="form-control" placeholder="Nama Kapal (opsional)">
              </div>
              <div style="flex:1;">
                <input type="text" class="form-control" placeholder="IMO Number (opsional)">
              </div>
            </div>
            
            <div class="form-row">
              <input type="date" class="form-control">
              <input type="time" class="form-control">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Nama Nahkoda (opsional)">
              <input type="text" class="form-control" placeholder="GT (Gross Tonnage) (opsional)">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Pelabuhan Asal (opsional)">
              <select class="form-control">
                <option value="">Pilih Jenis Kapal (opsional)</option>
                <option value="Kapal Penumpang">Kapal Penumpang</option>
                <option value="Kapal Barang">Kapal Barang</option>
                <option value="Kapal Tanker">Kapal Tanker</option>
                <option value="Kapal Ikan">Kapal Ikan</option>
                <option value="Kapal Pesiar">Kapal Pesiar</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            
            <h4 style="margin:20px 0 15px;color:#2c3e50;">📎 Upload Dokumen (Opsional)</h4>
            <label class="document-label">STBLKK (Surat Tanda Bukti Lapor Kedatangan Kapal): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Rekomendasi Bongkar Muatan: 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">SPB Asal (Pelabuhan Asal): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Manifest Muatan:
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            
            <div style="margin-top:30px;">
              <button type="button" class="btn-generate" onclick="generateAll(this)">
                <i class="fas fa-qrcode"></i> Generate QR & Preview Dokumen
              </button>
              <button type="button" class="btn-generate" onclick="downloadAll(this)" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                <i class="fas fa-download"></i> Download PDF Lengkap
              </button>
            </div>
          </form>
          <div class="result-container"></div>
        </div>
      </div>

      <!-- Nelayan Keberangkatan -->
      <div id="departureNelayan" class="content-page">
        <h2>🚢 Nelayan - Keberangkatan</h2>
        <div class="card">
          <div class="form-type-indicator">
            <h3>📋 Form Nelayan - Keberangkatan</h3>
          </div>
          
          <div class="gdrive-section">
            <h4><i class="fab fa-google-drive"></i> Google Drive Integration</h4>
            <button class="gdrive-btn" onclick="uploadAllToGDrive(this)" disabled>
              <i class="fas fa-cloud-upload-alt"></i> Upload ke Google Drive
            </button>
          </div>
          
          <div class="empty-form-notice">
            <i class="fas fa-info-circle"></i> Form dapat digenerate meskipun kosong - sistem akan mengisi dengan data default
          </div>
          
          <form data-form-type="Nelayan-Keberangkatan">
            <div class="form-row">
              <div style="flex:2;">
                <input type="text" class="form-control" placeholder="Nama Kapal (opsional)">
              </div>
              <div style="flex:1;">
                <input type="text" class="form-control" placeholder="No. Registrasi (opsional)">
              </div>
            </div>
            
            <div class="form-row">
              <input type="date" class="form-control">
              <input type="time" class="form-control">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Nama Nahkoda (opsional)">
              <input type="text" class="form-control" placeholder="GT (Gross Tonnage) (opsional)">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Daerah Penangkapan Ikan (opsional)">
              <select class="form-control">
                <option value="">Pilih Jenis Kapal (opsional)</option>
                <option value="Kapal Penangkap Ikan">Kapal Penangkap Ikan</option>
                <option value="Kapal Pengangkut Ikan">Kapal Pengangkut Ikan</option>
                <option value="Kapal Pendukung">Kapal Pendukung</option>
              </select>
            </div>
            
            <h4 style="margin:20px 0 15px;color:#2c3e50;">📎 Upload Dokumen (Opsional)</h4>
            <label class="document-label">SPB (Surat Persetujuan Berlayar): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">SIPI (Surat Izin Penangkapan Ikan): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">SIKPI (Surat Izin Kapal Penangkap Ikan): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Crew List (Daftar ABK): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            
            <div style="margin-top:30px;">
              <button type="button" class="btn-generate" onclick="generateAll(this)">
                <i class="fas fa-qrcode"></i> Generate QR & Preview Dokumen
              </button>
              <button type="button" class="btn-generate" onclick="downloadAll(this)" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                <i class="fas fa-download"></i> Download PDF Lengkap
              </button>
            </div>
          </form>
          <div class="result-container"></div>
        </div>
      </div>

      <!-- Nelayan Kedatangan -->
      <div id="arrivalNelayan" class="content-page">
        <h2>🚢 Nelayan - Kedatangan</h2>
        <div class="card">
          <div class="form-type-indicator">
            <h3>📋 Form Nelayan - Kedatangan</h3>
          </div>
          
          <div class="gdrive-section">
            <h4><i class="fab fa-google-drive"></i> Google Drive Integration</h4>
            <button class="gdrive-btn" onclick="uploadAllToGDrive(this)" disabled>
              <i class="fas fa-cloud-upload-alt"></i> Upload ke Google Drive
            </button>
          </div>
          
          <div class="empty-form-notice">
            <i class="fas fa-info-circle"></i> Form dapat digenerate meskipun kosong - sistem akan mengisi dengan data default
          </div>
          
          <form data-form-type="Nelayan-Kedatangan">
            <div class="form-row">
              <div style="flex:2;">
                <input type="text" class="form-control" placeholder="Nama Kapal (opsional)">
              </div>
              <div style="flex:1;">
                <input type="text" class="form-control" placeholder="No. Registrasi (opsional)">
              </div>
            </div>
            
            <div class="form-row">
              <input type="date" class="form-control">
              <input type="time" class="form-control">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Nama Nahkoda (opsional)">
              <input type="text" class="form-control" placeholder="GT (Gross Tonnage) (opsional)">
            </div>
            
            <div class="form-row">
              <input type="text" class="form-control" placeholder="Hasil Tangkapan (opsional)">
              <input type="text" class="form-control" placeholder="Tonnase Hasil Tangkapan (opsional)">
            </div>
            
            <h4 style="margin:20px 0 15px;color:#2c3e50;">📎 Upload Dokumen (Opsional)</h4>
            <label class="document-label">STBLKK (Surat Tanda Bukti Lapor Kedatangan Kapal): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">Laporan Hasil Tangkapan: 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            <label class="document-label">SPB Asal (Pelabuhan Asal): 
              <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </label>
            
            <div style="margin-top:30px;">
              <button type="button" class="btn-generate" onclick="generateAll(this)">
                <i class="fas fa-qrcode"></i> Generate QR & Preview Dokumen
              </button>
              <button type="button" class="btn-generate" onclick="downloadAll(this)" style="background:linear-gradient(135deg, #f39c12, #e67e22);">
                <i class="fas fa-download"></i> Download PDF Lengkap
              </button>
            </div>
          </form>
          <div class="result-container"></div>
        </div>
      </div>

      <!-- Reports -->
      <div id="reports" class="content-page">
        <h2>📊 Statistik & Laporan</h2>
        <div class="card">
          <h3>📊 Statistik Sesi Saat Ini</h3>
          <div class="document-summary">
            <table>
              <tr><td>Sesi Login:</td><td><span id="sessionTime">-</span></td></tr>
              <tr><td>Dokumen Dibuat:</td><td><span id="docsGenerated">0</span></td></tr>
              <tr><td>User Aktif:</td><td><span id="reportUserName">Demo User</span></td></tr>
              <tr><td>Email:</td><td><span id="reportUserEmail">demo@sandar-ratu.com</span></td></tr>
              <tr><td>Google Drive:</td><td><span id="reportGDriveStatus">Tidak Terhubung</span></td></tr>
            </table>
          </div>
        </div>
        
        <div class="card">
          <h3>📈 Informasi Sistem</h3>
          <div class="document-summary">
            <table>
              <tr><td>Versi Sistem:</td><td>SANDAR-RATU v2.2.0</td></tr>
              <tr><td>Status:</td><td><span style="color: #27ae60;">Aktif</span></td></tr>
              <tr><td>Browser:</td><td id="browserInfo">-</td></tr>
              <tr><td>Waktu Server:</td><td id="serverTime">-</td></tr>
              <tr><td>Google Drive API:</td><td><span id="apiStatus">Standby</span></td></tr>
            </table>
          </div>
        </div>
        
        <div class="card">
          <h3>☁️ Google Drive Management</h3>
          <div class="gdrive-section">
            <button class="gdrive-btn" onclick="testGDriveConnection()" id="testConnection" disabled>
              <i class="fas fa-plug"></i> Test Koneksi
            </button>
            <button class="gdrive-btn" onclick="showGDriveFolder()">
              <i class="fas fa-folder-open"></i> Buka Folder Drive
            </button>
            <button class="gdrive-btn" onclick="disconnectGDrive()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
              <i class="fas fa-unlink"></i> Disconnect Drive
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables
let sessionStats = {
  documentsGenerated: 0,
  sessionStart: new Date()
};

// Google Drive API Configuration
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const API_KEY = 'YOUR_API_KEY_HERE'; // Replace with your API key
const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // Replace with your client ID
const GDRIVE_FOLDER_ID = '1HdCdk1K0ubn6bZKVy7Jj0S7e8rrdEke9'; // The provided folder ID

let gapi;
let tokenClient;
let gapiInited = false;
let gisInited = false;
let isGDriveConnected = false;

// Initialize Google API
async function initializeGapi() {
  if (!window.gapi) {
    showNotification('Google API tidak tersedia. Menggunakan mode simulasi.', 'warning');
    simulateGDriveConnection();
    return;
  }

  showLoading(true);
  
  try {
    await gapi.load('client', initializeGapiClient);
    await gapi.load('client:auth2', initializeGis);
  } catch (error) {
    console.error('Error loading Google API:', error);
    showNotification('Gagal upload ke Google Drive. Menggunakan download lokal.', 'error');
    await simulateGDriveUpload(form);
  } finally {
    showLoading(false);
  }
}

async function simulateGDriveUpload(form) {
  const formType = form.getAttribute('data-form-type');
  let uploadCount = 0;
  
  // Download PDF
  await downloadAll(form.querySelector('.btn-generate[onclick*="downloadAll"]'));
  uploadCount++;
  
  // Download individual files with renamed format
  const fileInputs = form.querySelectorAll('input[type="file"]');
  fileInputs.forEach(fileInput => {
    if (fileInput.files[0]) {
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0].trim();
      const fileName = `[${formType}]_${label}_${file.name}`;
      
      // Create download link
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
      uploadCount++;
    }
  });
  
  showNotification(`Mode simulasi: ${uploadCount} file telah di-download lokal`, 'success');
}

async function uploadFileToGDrive(file, fileName, mimeType) {
  const metadata = {
    name: fileName,
    parents: [GDRIVE_FOLDER_ID]
  };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
  form.append('file', file);

  const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    method: 'POST',
    headers: new Headers({
      'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
    }),
    body: form
  });

  if (!response.ok) {
    throw new Error(`Upload failed: ${response.statusText}`);
  }

  return await response.json();
}

async function generatePDFBlob(form) {
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    // Get form data with defaults
    const formInputs = form.querySelectorAll('input[type="text"], select');
    const formType = form.getAttribute('data-form-type');
    const shipName = formInputs[0] ? (formInputs[0].value || "KAPAL_DEFAULT") : "KAPAL_DEFAULT";
    const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
    const time = form.querySelector('input[type="time"]').value || "00:00";
    const captain = formInputs[2] ? (formInputs[2].value || "NAHKODA_DEFAULT") : "NAHKODA_DEFAULT";
    
    // Generate PDF content (simplified version)
    let yOffset = 20;
    
    pdf.setFontSize(20);
    pdf.setFont(undefined, 'bold');
    pdf.text('SANDAR-RATU', 105, yOffset, { align: 'center' });
    yOffset += 15;
    
    pdf.setFontSize(16);
    pdf.text('FORM: ' + formType, 105, yOffset, { align: 'center' });
    yOffset += 20;
    
    pdf.setFontSize(12);
    pdf.text('Nama Kapal: ' + shipName, 20, yOffset);
    pdf.text('Tanggal: ' + date, 20, yOffset + 8);
    pdf.text('Nahkoda: ' + captain, 20, yOffset + 16);
    pdf.text('Generated: ' + new Date().toLocaleString('id-ID'), 20, yOffset + 24);
    
    return pdf.output('blob');
  } catch (error) {
    console.error('Error generating PDF blob:', error);
    return null;
  }
}

function testGDriveConnection() {
  if (isGDriveConnected) {
    showNotification('Google Drive terhubung dengan baik!', 'success');
  } else {
    showNotification('Menjalankan test simulasi - OK', 'warning');
  }
}

function showGDriveFolder() {
  const url = `https://drive.google.com/drive/folders/${GDRIVE_FOLDER_ID}`;
  window.open(url, '_blank');
}

function disconnectGDrive() {
  if (confirm('Apakah Anda yakin ingin memutus koneksi Google Drive?')) {
    isGDriveConnected = false;
    updateGDriveStatus(false);
    
    const uploadBtns = document.querySelectorAll('.gdrive-btn[onclick*="upload"]');
    uploadBtns.forEach(btn => {
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload ke Google Drive';
    });
    
    document.getElementById('connectGDrive').disabled = false;
    document.getElementById('connectGDrive').textContent = 'Hubungkan Google Drive';
    document.getElementById('connectGDrive').style.background = 'linear-gradient(135deg, #4285f4, #3367d6)';
    document.getElementById('testConnection').disabled = true;
    
    showNotification('Google Drive berhasil diputus', 'success');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Set default dates and times
  setDefaultDateTime();
  
  // Update system info
  updateSystemInfo();
  
  // Start session timer
  updateSessionTime();
  setInterval(updateSessionTime, 1000);
});

// Login handlers
document.getElementById('loginBtn').addEventListener('click', function() {
  this.disabled = true;
  document.getElementById('loginBtnText').textContent = 'Connecting to Google...';
  document.getElementById('loginSpinner').style.display = 'inline-block';
  
  setTimeout(() => {
    initializeGapi().then(() => {
      showDashboard();
      showNotification('Selamat datang di SANDAR-RATU dengan Google Drive!', 'success');
    });
  }, 1500);
});

document.getElementById('simulationBtn').addEventListener('click', function() {
  this.disabled = true;
  this.innerHTML = '<div class="spinner" style="display:inline-block;"></div> Loading...';
  
  setTimeout(() => {
    showDashboard();
    simulateGDriveConnection();
    showNotification('Mode simulasi aktif - SANDAR-RATU siap digunakan!', 'success');
  }, 1000);
});

function showDashboard() {
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("dashboard").style.display = "flex";
  document.body.style.background = "white";
  sessionStats.sessionStart = new Date();
}

function logout() {
  if (confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("loginPage").style.display = "block";
    document.body.style.background = "#f8f9fa";
    
    // Reset login buttons
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = false;
    document.getElementById('loginBtnText').textContent = 'Login dengan Google Drive';
    document.getElementById('loginSpinner').style.display = 'none';
    
    const simBtn = document.getElementById('simulationBtn');
    simBtn.disabled = false;
    simBtn.innerHTML = '<i class="fas fa-flask"></i> <span>Login Simulasi (Tanpa Google Drive)</span>';
    
    // Reset Google Drive connection
    isGDriveConnected = false;
    updateGDriveStatus(false);
    
    // Reset stats
    sessionStats = {
      documentsGenerated: 0,
      sessionStart: new Date()
    };
    
    // Clear results
    document.querySelectorAll('.result-container').forEach(container => {
      container.innerHTML = '';
    });
    
    showNotification('Berhasil keluar dari sistem', 'success');
  }
}

function showPage(pageId, el) {
  // Hide all pages
  document.querySelectorAll(".content-page").forEach(p => {
    p.style.display = "none";
    p.classList.remove("active");
  });
  
  // Show selected page
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
    targetPage.style.display = "block";
    targetPage.classList.add("active");
  }
  
  // Update active menu
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  if (el) {
    el.classList.add("active");
  }
}

function setDefaultDateTime() {
  const today = new Date().toISOString().split("T")[0];
  const now = new Date().toTimeString().slice(0, 5);
  
  document.querySelectorAll('input[type="date"]').forEach(input => {
    input.value = today;
  });
  
  document.querySelectorAll('input[type="time"]').forEach(input => {
    input.value = now;
  });
}

function updateSystemInfo() {
  // Update browser info
  const browserInfo = navigator.userAgent.split(' ').slice(-1)[0];
  const browserElement = document.getElementById('browserInfo');
  if (browserElement) {
    browserElement.textContent = browserInfo;
  }
  
  // Update server time
  updateServerTime();
  setInterval(updateServerTime, 1000);
}

function updateServerTime() {
  const serverTimeElement = document.getElementById('serverTime');
  if (serverTimeElement) {
    serverTimeElement.textContent = new Date().toLocaleString('id-ID');
  }
}

function updateSessionTime() {
  const sessionTimeElement = document.getElementById('sessionTime');
  if (sessionTimeElement && sessionStats.sessionStart) {
    const now = new Date();
    const diff = Math.floor((now - sessionStats.sessionStart) / 1000);
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    
    sessionTimeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
}

function generateDocumentCode(shipName, date, time) {
  const cleanShipName = shipName.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
  const formattedDate = date.replace(/-/g, '');
  const formattedTime = time.replace(':', '');
  return `SANDAR-${cleanShipName}-${formattedDate}-${formattedTime}`;
}

function formatFileSize(bytes) {
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  if (bytes === 0) return '0 Bytes';
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function generateAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  
  resultBox.innerHTML = "";

  // Get form data with defaults for empty fields
  const formInputs = form.querySelectorAll('input[type="text"], select');
  const shipName = formInputs[0] ? (formInputs[0].value || "KAPAL_DEFAULT") : "KAPAL_DEFAULT";
  const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
  const time = form.querySelector('input[type="time"]').value || "00:00";
  const captain = formInputs[2] ? (formInputs[2].value || "NAHKODA_DEFAULT") : "NAHKODA_DEFAULT";
  
  const code = generateDocumentCode(shipName, date, time);

  // Document summary
  const summaryDiv = document.createElement("div");
  summaryDiv.className = "document-summary";
  summaryDiv.innerHTML = `
    <h3>📋 Ringkasan Dokumen</h3>
    <table>
      <tr><td>Jenis Form:</td><td><strong>${formType}</strong></td></tr>
      <tr><td>Kode Dokumen:</td><td><strong>${code}</strong></td></tr>
      <tr><td>Nama Kapal:</td><td>${shipName}</td></tr>
      <tr><td>Tanggal:</td><td>${new Date(date).toLocaleDateString('id-ID')}</td></tr>
      <tr><td>Waktu:</td><td>${time}</td></tr>
      <tr><td>Nahkoda:</td><td>${captain}</td></tr>
      <tr><td>Petugas:</td><td><strong>Demo User</strong></td></tr>
      <tr><td>Dibuat:</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
    </table>
  `;
  resultBox.appendChild(summaryDiv);

  // QR Code section
  const qrSection = document.createElement("div");
  qrSection.className = "qr-section";
  qrSection.innerHTML = `<h3>🔲 QR Code Verifikasi Dokumen</h3>`;
  
  const qrDiv = document.createElement("div");
  qrDiv.id = `qrcode-${Date.now()}`;
  qrSection.appendChild(qrDiv);
  
  // Create QR URL
  const qrUrl = `https://sandar-ratu.com/verify?code=${code}&type=${formType}&ship=${encodeURIComponent(shipName)}&date=${date}&time=${time}&captain=${encodeURIComponent(captain)}&timestamp=${new Date().getTime()}`;
  
  // QR Info
  const qrInfo = document.createElement("div");
  qrInfo.className = "qr-info";
  qrInfo.innerHTML = `
    <p><strong>🔗 URL QR Code:</strong></p>
    <div class="qr-url">${qrUrl}</div>
    <p><strong>📏 Panjang URL:</strong> ${qrUrl.length} karakter</p>
    <p><strong>📊 Error Correction:</strong> High (30%)</p>
    <p><strong>📁 Form:</strong> ${formType}</p>
    <p><strong>👤 Petugas:</strong> Demo User</p>
    <div style="margin-top:15px;">
      <button class="test-qr-btn" onclick="copyToClipboard('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
        <i class="fas fa-copy"></i> Copy URL
      </button>
      <button class="test-qr-btn" onclick="openUrl('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
        <i class="fas fa-external-link-alt"></i> Test URL
      </button>
      <button class="test-qr-btn" onclick="downloadQR('${qrDiv.id}', '${code}')">
        <i class="fas fa-download"></i> Download QR
      </button>
    </div>
  `;
  qrSection.appendChild(qrInfo);
  resultBox.appendChild(qrSection);
  
  // Generate QR Code
  try {
    new QRCode(qrDiv, {
      text: qrUrl,
      width: 300,
      height: 300,
      colorDark: "#2c3e50",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  } catch (error) {
    console.error('Error generating QR code:', error);
    qrDiv.innerHTML = '<p style="color: red; padding: 50px; text-align: center;">Error generating QR code</p>';
  }

  // Document preview
  let docCount = 0;
  const fileInputs = form.querySelectorAll('input[type="file"]');
  
  fileInputs.forEach((fileInput, index) => {
    if (fileInput.files[0]) {
      docCount++;
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewContainer = document.createElement("div");
        previewContainer.className = "preview-container";
        
        // Document info
        const docInfo = document.createElement("div");
        docInfo.className = "document-info";
        docInfo.innerHTML = `
          <h4>📄 ${label}</h4>
          <p><strong>File:</strong> ${file.name}<br>
          <strong>Ukuran:</strong> ${formatFileSize(file.size)}<br>
          <strong>Tipe:</strong> ${file.type || 'Unknown'}<br>
          <strong>Upload:</strong> ${new Date().toLocaleString('id-ID')}<br>
          <strong>Form:</strong> ${formType} | <strong>Petugas:</strong> Demo User</p>
        `;
        previewContainer.appendChild(docInfo);
        
        // Preview element
        let previewEl;
        if (file.type.includes("pdf")) {
          previewEl = document.createElement("embed");
          previewEl.src = e.target.result;
          previewEl.type = "application/pdf";
        } else if (file.type.includes("image")) {
          previewEl = document.createElement("img");
          previewEl.src = e.target.result;
          previewEl.alt = file.name;
        } else {
          previewEl = document.createElement("div");
          previewEl.innerHTML = `
            <div style="text-align:center;padding:50px;color:#7f8c8d;border:2px dashed #bdc3c7;border-radius:8px;">
              <i class="fas fa-file-alt" style="font-size:48px;margin-bottom:15px;"></i><br>
              <strong>${file.name}</strong><br>
              <small>Preview tidak tersedia untuk tipe file ini</small><br>
              <small>Ukuran: ${formatFileSize(file.size)}</small>
            </div>
          `;
        }
        previewContainer.appendChild(previewEl);

        // Download link
        const downloadLink = document.createElement("a");
        downloadLink.href = e.target.result;
        downloadLink.download = `[${formType}]_${code}_${label.replace(/[^a-zA-Z0-9]/g, '_')}_${file.name}`;
        downloadLink.innerHTML = `<i class="fas fa-download"></i> Download ${label}`;
        previewContainer.appendChild(downloadLink);

        resultBox.appendChild(previewContainer);
      };
      reader.readAsDataURL(file);
    }
  });
  
  // Update session stats
  sessionStats.documentsGenerated++;
  const docsElement = document.getElementById('docsGenerated');
  if (docsElement) {
    docsElement.textContent = sessionStats.documentsGenerated;
  }
  
  const message = docCount > 0 ? 
    `Berhasil generate QR Code untuk ${docCount} dokumen` : 
    'QR Code berhasil digenerate untuk form kosong';
  showNotification(message, 'success');
}

// Download all documents as PDF
async function downloadAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  
  if (!resultBox.innerHTML.trim()) {
    showNotification('Generate QR & Preview terlebih dahulu!', 'warning');
    return;
  }

  try {
    showLoading(true);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    let yOffset = 20;
    
    // Get form data with defaults
    const formInputs = form.querySelectorAll('input[type="text"], select');
    const shipName = formInputs[0] ? (formInputs[0].value || "KAPAL_DEFAULT") : "KAPAL_DEFAULT";
    const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
    const time = form.querySelector('input[type="time"]').value || "00:00";
    const captain = formInputs[2] ? (formInputs[2].value || "NAHKODA_DEFAULT") : "NAHKODA_DEFAULT";
    
    // PDF Header
    pdf.setFontSize(20);
    pdf.setFont(undefined, 'bold');
    pdf.text('SANDAR-RATU', 105, yOffset, { align: 'center' });
    yOffset += 8;
    
    pdf.setFontSize(14);
    pdf.text('Sistem Administrasi & Dokumen Kesyahbandaran', 105, yOffset, { align: 'center' });
    yOffset += 5;
    pdf.text('PPN Palabuhanratu', 105, yOffset, { align: 'center' });
    yOffset += 20;
    
    // Form Type Header
    pdf.setFontSize(16);
    pdf.setFont(undefined, 'bold');
    pdf.text('FORM: ' + formType, 105, yOffset, { align: 'center' });
    yOffset += 20;
    
    // Document info
    pdf.setFontSize(12);
    pdf.setFont(undefined, 'bold');
    pdf.text('INFORMASI DOKUMEN', 20, yOffset);
    yOffset += 10;
    
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    
    pdf.text('Nama Kapal: ' + shipName, 20, yOffset);
    pdf.text('Tanggal: ' + new Date(date).toLocaleDateString('id-ID'), 20, yOffset + 6);
    pdf.text('Waktu: ' + time, 20, yOffset + 12);
    pdf.text('Nahkoda: ' + captain, 20, yOffset + 18);
    pdf.text('Petugas: Demo User', 20, yOffset + 24);
    
    yOffset += 40;

    // QR Code
    const qrCanvas = resultBox.querySelector('canvas');
    if (qrCanvas) {
      pdf.setFontSize(14);
      pdf.setFont(undefined, 'bold');
      pdf.text('QR CODE VERIFIKASI DOKUMEN', 105, yOffset, { align: 'center' });
      yOffset += 10;
      
      const imgData = qrCanvas.toDataURL('image/png');
      const qrSize = 60;
      pdf.addImage(imgData, 'PNG', (210-qrSize)/2, yOffset, qrSize, qrSize);
      yOffset += qrSize + 15;
    }

    // Document list
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.text('DOKUMEN TERLAMPIR:', 20, yOffset);
    yOffset += 12;
    
    let docNumber = 1;
    const fileInputs = form.querySelectorAll('input[type="file"]');
    
    let hasFiles = false;
    fileInputs.forEach((fileInput) => {
      if (fileInput.files[0]) {
        hasFiles = true;
        const file = fileInput.files[0];
        const label = fileInput.parentElement.textContent.split(':')[0];
        
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text(docNumber + '. ' + label, 20, yOffset);
        
        pdf.setFontSize(9);
        pdf.setFont(undefined, 'normal');
        const fileInfo = file.name + ' | ' + formatFileSize(file.size);
        pdf.text(fileInfo, 25, yOffset + 6);
        
        yOffset += 15;
        docNumber++;
        
        // Add new page if needed
        if (yOffset > 250) {
          pdf.addPage();
          yOffset = 20;
        }
      }
    });
    
    if (!hasFiles) {
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'italic');
      pdf.text('Tidak ada dokumen yang di-upload (form kosong)', 25, yOffset);
      pdf.text('Dokumen ini dibuat sebagai template atau placeholder', 25, yOffset + 8);
    }
    
    // Footer
    const totalPages = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i);
      pdf.setFontSize(8);
      pdf.text('SANDAR-RATU © 2025', 20, 285);
      pdf.text('Halaman ' + i + ' dari ' + totalPages, 105, 285, { align: 'center' });
      pdf.text('Dicetak: ' + new Date().toLocaleString('id-ID'), 190, 285, { align: 'right' });
    }
    
    // Save PDF
    const fileName = `[${formType}]_SANDAR_RATU_${shipName.replace(/\s+/g,'_')}_${date.replace(/-/g,'')}.pdf`;
    pdf.save(fileName);
    
    showNotification(`Dokumen PDF berhasil di-download: ${fileName}`, 'success');
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    showNotification('Terjadi error saat membuat PDF. Silakan coba lagi.', 'error');
  } finally {
    showLoading(false);
  }
}

// Helper functions for QR Code
function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showNotification('URL berhasil disalin ke clipboard!', 'success');
    }).catch(err => {
      console.error('Gagal menyalin: ', err);
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-999999px";
  textArea.style.top = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    showNotification('URL berhasil disalin ke clipboard!', 'success');
  } catch (err) {
    console.error('Fallback copy failed: ', err);
    showNotification('Gagal menyalin URL', 'error');
  }
  document.body.removeChild(textArea);
}

function openUrl(url) {
  window.open(url, '_blank');
}

function downloadQR(qrDivId, fileName) {
  const qrDiv = document.getElementById(qrDivId);
  const canvas = qrDiv.querySelector('canvas');
  
  if (canvas) {
    const link = document.createElement('a');
    link.download = `QR_${fileName}.png`;
    link.href = canvas.toDataURL();
    link.click();
    showNotification('QR Code berhasil didownload', 'success');
  } else {
    showNotification('QR Code belum dibuat', 'error');
  }
}

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.classList.add('show'), 100);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => document.body.removeChild(notification), 300);
  }, 4000);
}

function showLoading(show = true) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = show ? 'flex' : 'none';
}
</script>

</body>
</html>
