<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SANDARATU - Sistem Informasi</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; background: #f4f8fb; color: #333; }
    header { background: linear-gradient(90deg, #003366, #0055a5); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    header h1 { margin: 0; font-size: 28px; }
    header p { margin: 5px 0 0; font-size: 14px; opacity: 0.8; }
    .container { max-width: 900px; margin: 30px auto; padding: 20px; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .card h3 { margin-top: 0; color: #0055a5; }
    input, select { width: 100%; padding: 10px; margin: 8px 0 16px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    button { padding: 10px 15px; background: #0055a5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 10px; }
    button:hover { background: #003f7f; }
    .logout { background: crimson; margin-top: 20px; }
    .doc-card { background: white; border-radius: 12px; padding: 15px; margin: 15px 0; box-shadow: 0 3px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .doc-info { flex: 1; }
    .doc-info b { font-size: 16px; color: #0055a5; }
    .qrcode { margin-left: 20px; border: 1px solid #eee; padding: 5px; border-radius: 8px; background: #fafafa; }
    .hidden { display: none; }
    #reader, #readerNelayan { width: 100%; }

    /* Tab Login */
    .tab-container { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
    .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: bold; color: #555; }
    .tab.active { border-bottom: 3px solid #0055a5; color: #0055a5; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Kemenhub" style="height:80px; display:block; margin:0 auto 10px;">
    <h1>ðŸ“‘ SANDAR-RATU</h1>
    <p>Sistem Administrasi & Dokumen Kesyahbandaran PPN Pelabuhan Ratu</p>
  </header>

  <div class="container">
    <!-- Login -->
    <div class="card" id="loginBox">
      <h3>ðŸ”‘ Login</h3>

      <!-- Tabs -->
      <div class="tab-container">
        <div class="tab active" id="tabPetugas">Petugas</div>
        <div class="tab" id="tabNelayan">Nelayan</div>
      </div>

      <!-- Form Petugas -->
      <form id="loginFormPetugas">
        <label>Username Petugas:</label>
        <input type="text" id="usernamePetugas" required>
        <label>Password:</label>
        <input type="password" id="passwordPetugas" required>
        <button type="submit">Login Petugas</button>
      </form>

      <!-- Google Login Petugas -->
      <div id="googleLoginPetugas"></div>

      <!-- Form Nelayan -->
      <form id="loginFormNelayan" class="hidden">
        <label>Nama Nelayan:</label>
        <input type="text" id="usernameNelayan" required>
        <button type="submit">Login Nelayan</button>
      </form>

      <!-- Google Login Nelayan -->
      <div id="googleLoginNelayan" class="hidden"></div>
    </div>

    <!-- Petugas Section -->
    <div id="petugasSection" class="hidden">
      <div class="card">
        <h3>âž• Input Data Dokumen</h3>
        <form id="uploadForm">
          <label>Jenis Dokumen:</label>
          <select id="docType" required>
            <option value="Keberangkatan">Keberangkatan</option>
            <option value="Kepulangan">Kepulangan</option>
          </select>
          <label>Nama Nelayan:</label>
          <input type="text" id="nelayanName" required>
          <label>Nama Kapal:</label>
          <input type="text" id="shipName" required>
          <label>Tujuan:</label>
          <input type="text" id="destination" required>
          <label>Tanggal:</label>
          <input type="date" id="date" required>
          <label>Upload Dokumen (PDF):</label>
          <input type="file" id="fileInput" accept="application/pdf" required>
          <button type="submit">ðŸ“¤ Simpan & Generate QR</button>
        </form>
      </div>

      <div class="card">
        <h3>ðŸ“‚ Daftar Dokumen</h3>
        <div id="docList"></div>
      </div>

      <div class="card">
        <h3>ðŸ“· Scan Barcode</h3>
        <div id="reader"></div>
        <p id="scanResult"></p>
      </div>

      <button class="logout" onclick="logout()">ðŸšª Logout</button>
    </div>

    <!-- Nelayan Section -->
    <div id="nelayanSection" class="hidden">
      <div class="card">
        <h3>ðŸ“‚ Barcode Dokumen Saya</h3>
        <div id="nelayanDocs"></div>
      </div>
      <div class="card">
        <h3>ðŸ“· Scan Barcode Saya</h3>
        <div id="readerNelayan"></div>
        <p id="scanResultNelayan"></p>
      </div>
      <button class="logout" onclick="logout()">ðŸšª Logout</button>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    const loginBox = document.getElementById("loginBox");
    const petugasSection = document.getElementById("petugasSection");
    const nelayanSection = document.getElementById("nelayanSection");
    const docList = document.getElementById("docList");
    const nelayanDocs = document.getElementById("nelayanDocs");
    const uploadForm = document.getElementById("uploadForm");
    const scanResult = document.getElementById("scanResult");
    const scanResultNelayan = document.getElementById("scanResultNelayan");

    let role = "";
    let currentUser = "";
    let documents = JSON.parse(localStorage.getItem("sandDocs")) || [];

    function saveDocs() {
      localStorage.setItem("sandDocs", JSON.stringify(documents));
    }

    // Tabs switch
    document.getElementById("tabPetugas").onclick = () => {
      document.getElementById("tabPetugas").classList.add("active");
      document.getElementById("tabNelayan").classList.remove("active");
      document.getElementById("loginFormPetugas").classList.remove("hidden");
      document.getElementById("loginFormNelayan").classList.add("hidden");
      document.getElementById("googleLoginPetugas").classList.remove("hidden");
      document.getElementById("googleLoginNelayan").classList.add("hidden");
      role = "petugas";
    };
    document.getElementById("tabNelayan").onclick = () => {
      document.getElementById("tabNelayan").classList.add("active");
      document.getElementById("tabPetugas").classList.remove("active");
      document.getElementById("loginFormNelayan").classList.remove("hidden");
      document.getElementById("loginFormPetugas").classList.add("hidden");
      document.getElementById("googleLoginNelayan").classList.remove("hidden");
      document.getElementById("googleLoginPetugas").classList.add("hidden");
      role = "nelayan";
    };

    // Login Petugas (manual)
    document.getElementById("loginFormPetugas").addEventListener("submit", function(e) {
      e.preventDefault();
      role = "petugas";
      currentUser = document.getElementById("usernamePetugas").value;
      masukPetugas();
    });

    // Login Nelayan (manual)
    document.getElementById("loginFormNelayan").addEventListener("submit", function(e) {
      e.preventDefault();
      role = "nelayan";
      currentUser = document.getElementById("usernameNelayan").value;
      masukNelayan();
    });

    function masukPetugas() {
      loginBox.classList.add("hidden");
      petugasSection.classList.remove("hidden");
      renderDocs();
      startScanner();
    }
    function masukNelayan() {
      loginBox.classList.add("hidden");
      nelayanSection.classList.remove("hidden");
      renderNelayanDocs();
      startScannerNelayan();
    }
    function logout() {
      role = "";
      currentUser = "";
      loginBox.classList.remove("hidden");
      petugasSection.classList.add("hidden");
      nelayanSection.classList.add("hidden");
    }

    // Google Login callback
    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      currentUser = data.name || data.email;

      if (role === "petugas") {
        masukPetugas();
      } else if (role === "nelayan") {
        masukNelayan();
      } else {
        alert("Pilih tab login (Petugas atau Nelayan) terlebih dahulu!");
      }
    }
    function parseJwt(token) {
      let base64Url = token.split('.')[1];
      let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "180722419885-tgptv8houl6ockqsjk0gqjus8cj4a6ue.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });

      google.accounts.id.renderButton(
        document.getElementById("googleLoginPetugas"),
        { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
      );
      google.accounts.id.renderButton(
        document.getElementById("googleLoginNelayan"),
        { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
      );

      // default buka tab Petugas
      document.getElementById("tabPetugas").click();
    };

    // Upload Dokumen Petugas
    uploadForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const docType = document.getElementById("docType").value;
      const nelayanName = document.getElementById("nelayanName").value;
      const shipName = document.getElementById("shipName").value;
      const destination = document.getElementById("destination").value;
      const date = document.getElementById("date").value;
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pilih file PDF terlebih dahulu!");
      const fileURL = URL.createObjectURL(file);
      const docId = "DOC-" + Date.now();

      const docData = { docId, docType, nelayanName, shipName, destination, date, fileName: file.name, fileURL };
      documents.push(docData);
      saveDocs();

      renderDocs();
      uploadForm.reset();
    });

    // Render Dokumen Petugas
    function renderDocs() {
      docList.innerHTML = "";
      documents.forEach(doc => {
        const card = document.createElement("div");
        card.className = "doc-card";
        card.innerHTML = `
          <div class="doc-info">
            <b>${doc.docType}</b><br>
            Nelayan: ${doc.nelayanName}<br>
            Kapal: ${doc.shipName}<br>
            Tujuan: ${doc.destination}<br>
            Tanggal: ${doc.date}<br>
            File: <a href="${doc.fileURL}" target="_blank">${doc.fileName}</a><br>
            ID: ${doc.docId}
          </div>
          <div class="qrcode" id="qrcode-${doc.docId}"></div>
        `;
        docList.appendChild(card);
        new QRCode(document.getElementById("qrcode-" + doc.docId), { text: doc.docId, width: 100, height: 100 });
      });
    }

    // Render Dokumen Nelayan (tampilkan juga link PDF yang diupload petugas)
function renderNelayanDocs() {
  nelayanDocs.innerHTML = "";
  const myDocs = documents.filter(
    doc => doc.nelayanName.toLowerCase() === currentUser.toLowerCase()
  );

  if (myDocs.length === 0) {
    nelayanDocs.innerHTML = "<p>Belum ada dokumen.</p>";
  } else {
    myDocs.forEach(doc => {
      const div = document.createElement("div");
      div.className = "doc-card";
      div.id = "docCard-" + doc.docId;

      div.innerHTML = `
        <div class="doc-info">
          <b>${doc.docType}</b><br>
          Kapal: ${doc.shipName}<br>
          Tujuan: ${doc.destination}<br>
          Tanggal: ${doc.date}<br>
          File: <a href="${doc.fileURL}" target="_blank">${doc.fileName}</a><br>
          ID: ${doc.docId}<br>
        </div>
        <div class="qrcode" id="nelayanQR-${doc.docId}"></div>
      `;

      nelayanDocs.appendChild(div);

      // Generate QR berisi docId
      new QRCode(document.getElementById("nelayanQR-" + doc.docId), {
        text: doc.docId,
        width: 120,
        height: 120
      });
    });
  }
}


    // Scanner Petugas
    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          scanResult.innerText = "âœ… Hasil Scan: " + qrCodeMessage;
          const found = documents.find(doc => doc.docId === qrCodeMessage);
          if (found) {
            scanResult.innerText += `\nðŸ“„ Dokumen: ${found.nelayanName}, Kapal ${found.shipName}, Tujuan ${found.destination}`;
          }
        }).catch(err => { scanResult.innerText = "Gagal akses kamera: " + err; });
    }

    // Scanner Nelayan
    function startScannerNelayan() {
      const html5QrCode = new Html5Qrcode("readerNelayan");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          scanResultNelayan.innerText = "âœ… Hasil Scan: " + qrCodeMessage;
          const found = documents.find(doc => doc.docId === qrCodeMessage);
          if (found) {
            scanResultNelayan.innerText += `\nðŸ“„ Kapal ${found.shipName}, Tujuan ${found.destination}, Tanggal ${found.date}`;
          }
        }).catch(err => { scanResultNelayan.innerText = "Gagal akses kamera: " + err; });
    }
  </script>
</body>
</html>
