<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Login Styles */
        .login-container {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }

        .logo-section {
            text-align: center;
            padding: 40px 30px 20px;
            background: linear-gradient(135deg, #3498db, #1a73e8);
        }

        .logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3498db;
        }

        .warning-section {
            background: #feffd6;
            border: 1px solid #fff4ce;
            margin: 20px;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .warning-title {
            background: #ffffff;
            border: 1px solid #ffeaa7;
            color: #000000;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 15px;
            display: inline-block;
        }

        .warning-text {
            color: #000000;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .login-method-section {
            padding: 20px;
            text-align: center;
        }

        .method-title {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .google-login-btn {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            background: #fff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .google-login-btn:hover:not(:disabled) {
            border-color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .google-login-btn:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .header {
            background: #2c3e50;
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header .logo-icon {
            background: #3498db;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #3498db;
        }

        .main-container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 240px;
            background: #3498db;
            color: white;
            padding-top: 20px;
        }

        .sidebar div {
            padding: 8px 20px;
            font-weight: 600;
            opacity: 0.8;
            font-size: 13px;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: 0.3s;
            cursor: pointer;
        }

        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar a.active {
            background: rgba(0, 0, 0, 0.25);
            font-weight: bold;
        }

        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .form-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-generate {
            width: 100%;
            padding: 12px;
            background: #2ecc71;
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.2s ease;
        }

        .btn-generate:hover:not(:disabled) {
            background: #27ae60;
        }

        .btn-generate:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-upload-drive {
            width: 100%;
            padding: 12px;
            background: #1a73e8;
            border: none;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.2s ease;
        }

        .btn-upload-drive:hover:not(:disabled) {
            background: #1557b0;
        }

        .btn-upload-drive:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-logout {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .form-type-indicator {
            background: #e8f4f8;
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-type-indicator h3 {
            color: #2c3e50;
            margin: 0;
        }

        .content-page {
            display: none;
        }

        .content-page.active {
            display: block;
        }

        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .footer-login {
            text-align: center;
            padding: 15px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }

        /* Loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .download-link {
            display: inline-block;
            margin: 10px 0;
            padding: 8px 16px;
            background: #2980b9;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
        }

        .download-link:hover {
            background: #21618c;
        }
    </style>
</head>
<body>

<div id="loginPage" class="login-container">
    <div class="logo-section">
        <a href="#" class="logo">
            <div class="logo-icon">
                <i class="fas fa-anchor"></i>
            </div>
            SANDAR-RATU
        </a>
    </div>

    <div class="warning-section">
        <div class="warning-title">Peringatan</div>
        <div class="warning-text">
            Halaman ini memerlukan autentikasi.<br>
            Silahkan klik tombol login di bawah untuk melanjutkan.<br>
            Terima kasih.
        </div>
    </div>

    <div class="login-method-section">
        <div class="method-title">- pilih metode login -</div>
        <button id="googleLoginBtn" class="google-login-btn">
            <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            <span>Log in with Google</span>
        </button>
    </div>

    <div class="footer-login">Hak Cipta ¬© 2025 Sandar-Ratu</div>
</div>

<div id="dashboard" class="dashboard">
    <div class="header">
        <div style="display:flex;align-items:center;">
            <div class="logo-icon"><i class="fas fa-anchor"></i></div>
            <strong>SANDAR-RATU</strong>
        </div>
        <div style="display:flex;align-items:center;gap:15px;">
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="User">
                <span id="userName">User</span>
            </div>
            <button class="btn-logout" onclick="logout()">Keluar</button>
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div>üë®‚Äç‚úàÔ∏è Petugas</div>
            <a onclick="showPage('departurePetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Keberangkatan</a>
            <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-ship"></i>&nbsp; Kedatangan</a>
            <div>üö¢ Nelayan</div>
            <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
            <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
        </div>

        <div class="content" id="mainContent">
        </div>
    </div>
</div>

<script>
    // Configuration
    const CLIENT_ID = "180722419885-1u9s23e55gjirb60igrv8uq5dfk7ltsn.apps.googleusercontent.com";
    const API_KEY = "AIzaSyAWrUdv79vEKgd3YVkYsHvfwS3-vKev_lk";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    const FOLDER_MAP = {
        "Petugas-Keberangkatan": "1OtloxktgdBBSFLwh1CUqYsYk25l2fsBH",
        "Petugas-Kedatangan": "1Z6fEANltfHjUsRnluXs6j6RE31rCczIk",
        "Nelayan-Keberangkatan": "1jBtsh2mj2oF2oyiJMu_subw_qo-C1FRv",
        "Nelayan-Kedatangan": "1AYPXMwl47Uj0p8SfxlVz7VmMVUP4l521"
    };

    // Global state
    let currentUser = null;
    let accessToken = null;
    let tokenClient = null;
    let isGapiLoaded = false;

    // Utility functions
    function showStatus(containerId, message, type = 'info') {
        const container = document.getElementById(containerId);
        const statusEl = container.querySelector('.status-message') || document.createElement('div');
        statusEl.className = `status-message status-${type}`;
        statusEl.innerHTML = message;
        statusEl.style.display = 'block';
        
        if (!container.querySelector('.status-message')) {
            container.appendChild(statusEl);
        }
    }

    function hideStatus(containerId) {
        const container = document.getElementById(containerId);
        const statusEl = container.querySelector('.status-message');
        if (statusEl) {
            statusEl.style.display = 'none';
        }
    }

    function setButtonsState(disabled) {
        document.querySelectorAll('.btn-generate, .btn-upload-drive').forEach(btn => {
            btn.disabled = disabled;
        });
    }

    // Initialize Google APIs
    function initializeGoogleAPIs() {
        console.log('Starting Google APIs initialization...');

        // Initialize Google Identity Services
        if (typeof google !== 'undefined' && google.accounts) {
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleSignInWithGoogle,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });
                console.log('‚úì Google Identity Services initialized');
            } catch (error) {
                console.error('‚úó Failed to initialize Google Identity Services:', error);
                updateLoginButton('Google Identity tidak tersedia', true);
                return;
            }
        } else {
            console.error('‚úó Google Identity Services not available');
            updateLoginButton('Google Identity tidak tersedia', true);
            return;
        }

        // Initialize Google API client
        if (typeof gapi !== 'undefined') {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });

                    // Initialize OAuth2 token client
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: handleTokenResponse
                    });

                    isGapiLoaded = true;
                    console.log('‚úì Google API client and OAuth2 initialized');
                    updateLoginButton('Log in with Google', false);
                    
                } catch (error) {
                    console.error('‚úó Failed to initialize Google API client:', error);
                    updateLoginButton('Google API tidak tersedia', true);
                }
            });
        } else {
            console.error('‚úó Google API client not available');
            updateLoginButton('Google API tidak tersedia', true);
        }
    }

    function updateLoginButton(text, disabled) {
        const btn = document.getElementById('googleLoginBtn');
        const span = btn.querySelector('span');
        if (span) {
            span.textContent = text;
        }
        btn.disabled = disabled;
    }

    function handleSignInWithGoogle(response) {
        try {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            currentUser = {
                id: payload.sub,
                name: payload.name || 'User',
                email: payload.email || '',
                picture: payload.picture || ''
            };
            console.log('‚úì User signed in:', currentUser.name);
            showDashboard();
        } catch (error) {
            console.error('‚úó Failed to handle sign-in:', error);
            alert('Login gagal. Silakan coba lagi.');
        }
    }

    function handleTokenResponse(response) {
        if (response.error !== undefined) {
            console.error('‚úó Token error:', response);
            return;
        }
        accessToken = response.access_token;
        console.log('‚úì Access token obtained');
    }

    // Login button handler
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
        if (!currentUser) {
            // Trigger sign-in flow
            try {
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        console.log('Prompt not displayed, using fallback');
                        // Fallback to direct token request
                        if (tokenClient) {
                            tokenClient.requestAccessToken();
                        }
                    }
                });
            } catch (error) {
                console.error('‚úó Sign-in error:', error);
                alert('Login gagal. Silakan coba lagi.');
            }
        }
    });

    function showDashboard() {
        if (!currentUser) {
            console.error('‚úó No user data available');
            return;
        }

        // Update UI
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userAvatar').src = currentUser.picture;

        // Show dashboard
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        document.body.style.background = 'white';

        // Initialize pages
        initializePages();
        showPage('departurePetugas', document.querySelector('.sidebar a'));

        console.log('‚úì Dashboard shown');
    }

    function logout() {
        // Clear user data
        currentUser = null;
        accessToken = null;

        // Revoke token if exists
        if (accessToken && google.accounts.oauth2) {
            google.accounts.oauth2.revoke(accessToken, () => {
                console.log('‚úì Token revoked');
            });
        }

        // Show login page
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('loginPage').style.display = 'block';
        document.body.style.background = '#f8f9fa';

        console.log('‚úì User logged out');
    }

    // Request Drive access when needed
    async function requestDriveAccess() {
        if (accessToken) {
            return true;
        }

        if (!tokenClient) {
            throw new Error('OAuth2 belum diinisialisasi');
        }

        return new Promise((resolve, reject) => {
            const originalCallback = tokenClient.callback;
            tokenClient.callback = (response) => {
                tokenClient.callback = originalCallback;
                if (response.error !== undefined) {
                    reject(new Error('Gagal mendapatkan akses Google Drive'));
                } else {
                    accessToken = response.access_token;
                    resolve(true);
                }
            };
            tokenClient.requestAccessToken();
        });
    }

    // Upload file to Google Drive
    async function uploadToGoogleDrive(file, folderType, statusContainerId) {
        try {
            showStatus(statusContainerId, '<span class="loading-spinner"></span>Meminta akses Google Drive...', 'info');
            
            await requestDriveAccess();
            
            const folderId = FOLDER_MAP[folderType];
            if (!folderId) {
                throw new Error('Folder tidak ditemukan');
            }

            showStatus(statusContainerId, '<span class="loading-spinner"></span>Mengupload ke Google Drive...', 'info');

            const metadata = {
                name: file.name,
                parents: [folderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {
                type: 'application/json'
            }));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: form
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Upload gagal: ${errorData.error?.message || response.statusText}`);
            }

            const result = await response.json();
            showStatus(statusContainerId, `<i class="fas fa-check-circle"></i> Berhasil diupload ke Google Drive!<br>File ID: ${result.id}`, 'success');
            
            return result;

        } catch (error) {
            console.error('‚úó Upload error:', error);
            showStatus(statusContainerId, `<i class="fas fa-exclamation-triangle"></i> Upload gagal: ${error.message}`, 'error');
            throw error;
        }
    }

    // Generate PDF document
    function generatePDF(data, type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        
        if (type === 'departure') {
            doc.text('PERSETUJUAN BERLAYAR', 105, 20, { align: 'center' });
        } else {
            doc.text('LAPORAN KEDATANGAN', 105, 20, { align: 'center' });
        }
        
        // Subtitle
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('PPN Palabuhanratu', 105, 30, { align: 'center' });
        
        // Content
        doc.setFontSize(11);
        let yPos = 50;
        
        for (const [key, value] of Object.entries(data)) {
            doc.text(`${key}: ${value}`, 20, yPos);
            yPos += 10;
        }
        
        // Footer
        doc.setFontSize(9);
        doc.text(`Dicetak: ${new Date().toLocaleString('id-ID')}`, 20, 280);
        doc.text(`Petugas: ${currentUser ? currentUser.name : 'Unknown'}`, 20, 290);
        
        return doc;
    }

    // Form handlers
    function handleDepartureForm(formData, statusContainerId) {
        try {
            const data = {
                'Nama Kapal': formData.get('namaKapal'),
                'Nakhoda': formData.get('nakhoda'),
                'Tanggal Bertolak': formData.get('tanggal'),
                'Jam Bertolak': formData.get('jam'),
                'Tujuan': formData.get('tujuan')
            };

            // Validate required fields
            for (const [key, value] of Object.entries(data)) {
                if (!value || value.trim() === '') {
                    throw new Error(`${key} harus diisi`);
                }
            }

            const doc = generatePDF(data, 'departure');
            const pdfBlob = doc.output('blob');
            const fileName = `Persetujuan_Berlayar_${data['Nama Kapal'].replace(/\s+/g, '_')}_${data['Tanggal Bertolak']}.pdf`;
            
            // Create download link
            const downloadUrl = URL.createObjectURL(pdfBlob);
            const downloadLink = `<a href="${downloadUrl}" download="${fileName}" class="download-link">
                <i class="fas fa-download"></i> Download PDF
            </a>`;
            
            showStatus(statusContainerId, `
                <i class="fas fa-check-circle"></i> Dokumen berhasil dibuat!<br>
                ${downloadLink}
            `, 'success');

            // Setup upload functionality
            const uploadBtn = document.querySelector(`#${statusContainerId.replace('Status', '')} .btn-upload-drive`);
            if (uploadBtn) {
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                uploadBtn.onclick = () => uploadToGoogleDrive(file, 'Petugas-Keberangkatan', statusContainerId);
                uploadBtn.disabled = false;
            }

        } catch (error) {
            console.error('‚úó Form error:', error);
            showStatus(statusContainerId, `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'error');
        }
    }

    function handleArrivalForm(formData, statusContainerId) {
        try {
            const data = {
                'Nama Kapal': formData.get('namaKapal'),
                'Nakhoda': formData.get('nakhoda'),
                'Tanggal Tiba': formData.get('tanggal'),
                'Jam Tiba': formData.get('jam'),
                'Asal': formData.get('asal')
            };

            // Validate required fields
            for (const [key, value] of Object.entries(data)) {
                if (!value || value.trim() === '') {
                    throw new Error(`${key} harus diisi`);
                }
            }

            const doc = generatePDF(data, 'arrival');
            const pdfBlob = doc.output('blob');
            const fileName = `Laporan_Kedatangan_${data['Nama Kapal'].replace(/\s+/g, '_')}_${data['Tanggal Tiba']}.pdf`;
            
            // Create download link
            const downloadUrl = URL.createObjectURL(pdfBlob);
            const downloadLink = `<a href="${downloadUrl}" download="${fileName}" class="download-link">
                <i class="fas fa-download"></i> Download PDF
            </a>`;
            
            showStatus(statusContainerId, `
                <i class="fas fa-check-circle"></i> Dokumen berhasil dibuat!<br>
                ${downloadLink}
            `, 'success');

            // Setup upload functionality
            const uploadBtn = document.querySelector(`#${statusContainerId.replace('Status', '')} .btn-upload-drive`);
            if (uploadBtn) {
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                uploadBtn.onclick = () => uploadToGoogleDrive(file, 'Petugas-Kedatangan', statusContainerId);
                uploadBtn.disabled = false;
            }

        } catch (error) {
            console.error('‚úó Form error:', error);
            showStatus(statusContainerId, `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'error');
        }
    }

    // Initialize pages
    function initializePages() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <!-- Petugas Keberangkatan -->
            <div id="departurePetugas" class="content-page">
                <div class="form-type-indicator">
                    <h3>üìã Formulir Persetujuan Berlayar - Petugas</h3>
                </div>
                <div class="card">
                    <h2>Cetak Persetujuan Berlayar</h2>
                    <form id="formDeparturePetugas">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapal1">Nama Kapal Perikanan *</label>
                                <input type="text" id="namaKapal1" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhoda1">Nakhoda *</label>
                                <input type="text" id="nakhoda1" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggal1">Tanggal Bertolak *</label>
                                <input type="date" id="tanggal1" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="jam1">Jam Bertolak *</label>
                                <input type="time" id="jam1" name="jam" required>
                            </div>
                        </div>
                        <div class="form-control">
                            <label for="tujuan1">Tujuan *</label>
                            <input type="text" id="tujuan1" name="tujuan" required>
                        </div>
                        <button type="submit" class="btn-generate">
                            <i class="fas fa-file-pdf"></i> Buat & Download Dokumen
                        </button>
                        <button type="button" class="btn-upload-drive" disabled>
                            <i class="fab fa-google-drive"></i> Upload ke Google Drive
                        </button>
                    </form>
                    <div id="departurePetugasStatus"></div>
                </div>
            </div>

            <!-- Petugas Kedatangan -->
            <div id="arrivalPetugas" class="content-page">
                <div class="form-type-indicator">
                    <h3>üìã Formulir Laporan Kedatangan - Petugas</h3>
                </div>
                <div class="card">
                    <h2>Cetak Laporan Kedatangan</h2>
                    <form id="formArrivalPetugas">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapal2">Nama Kapal Perikanan *</label>
                                <input type="text" id="namaKapal2" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="nakhoda2">Nakhoda *</label>
                                <input type="text" id="nakhoda2" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggal2">Tanggal Tiba *</label>
                                <input type="date" id="tanggal2" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="jam2">Jam Tiba *</label>
                                <input type="time" id="jam2" name="jam" required>
                            </div>
                        </div>
                        <div class="form-control">
                            <label for="asal2">Asal Keberangkatan *</label>
                            <input type="text" id="asal2" name="asal" required>
                        </div>
                        <button type="submit" class="btn-generate">
                            <i class="fas fa-file-pdf"></i> Buat & Download Dokumen
                        </button>
                        <button type="button" class="btn-upload-drive" disabled>
                            <i class="fab fa-google-drive"></i> Upload ke Google Drive
                        </button>
                    </form>
                    <div id="arrivalPetugasStatus"></div>
                </div>
            </div>

            <!-- Nelayan Keberangkatan -->
            <div id="departureNelayan" class="content-page">
                <div class="form-type-indicator">
                    <h3>üìã Formulir Keberangkatan - Nelayan</h3>
                </div>
                <div class="card">
                    <h2>Cetak Surat Pernyataan Keberangkatan</h2>
                    <form id="formDepartureNelayan">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapal3">Nama Kapal *</label>
                                <input type="text" id="namaKapal3" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="pemilik3">Pemilik/Nahkoda *</label>
                                <input type="text" id="pemilik3" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggal3">Tanggal Berangkat *</label>
                                <input type="date" id="tanggal3" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="jam3">Jam Berangkat *</label>
                                <input type="time" id="jam3" name="jam" required>
                            </div>
                        </div>
                        <div class="form-control">
                            <label for="tujuan3">Daerah Penangkapan *</label>
                            <input type="text" id="tujuan3" name="tujuan" required>
                        </div>
                        <button type="submit" class="btn-generate">
                            <i class="fas fa-file-pdf"></i> Buat & Download Dokumen
                        </button>
                        <button type="button" class="btn-upload-drive" disabled>
                            <i class="fab fa-google-drive"></i> Upload ke Google Drive
                        </button>
                    </form>
                    <div id="departureNelayanStatus"></div>
                </div>
            </div>

            <!-- Nelayan Kedatangan -->
            <div id="arrivalNelayan" class="content-page">
                <div class="form-type-indicator">
                    <h3>üìã Formulir Kedatangan - Nelayan</h3>
                </div>
                <div class="card">
                    <h2>Cetak Surat Pernyataan Kedatangan</h2>
                    <form id="formArrivalNelayan">
                        <div class="form-row">
                            <div class="form-control">
                                <label for="namaKapal4">Nama Kapal *</label>
                                <input type="text" id="namaKapal4" name="namaKapal" required>
                            </div>
                            <div class="form-control">
                                <label for="pemilik4">Pemilik/Nahkoda *</label>
                                <input type="text" id="pemilik4" name="nakhoda" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-control">
                                <label for="tanggal4">Tanggal Tiba *</label>
                                <input type="date" id="tanggal4" name="tanggal" required>
                            </div>
                            <div class="form-control">
                                <label for="jam4">Jam Tiba *</label>
                                <input type="time" id="jam4" name="jam" required>
                            </div>
                        </div>
                        <div class="form-control">
                            <label for="asal4">Asal Penangkapan *</label>
                            <input type="text" id="asal4" name="asal" required>
                        </div>
                        <button type="submit" class="btn-generate">
                            <i class="fas fa-file-pdf"></i> Buat & Download Dokumen
                        </button>
                        <button type="button" class="btn-upload-drive" disabled>
                            <i class="fab fa-google-drive"></i> Upload ke Google Drive
                        </button>
                    </form>
                    <div id="arrivalNelayanStatus"></div>
                </div>
            </div>
        `;

        // Set default date and time
        const today = new Date().toISOString().split('T')[0];
        const now = new Date().toTimeString().slice(0, 5);
        
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.value = today;
        });
        
        document.querySelectorAll('input[type="time"]').forEach(input => {
            input.value = now;
        });

        // Add event listeners
        setupFormHandlers();
    }

    function setupFormHandlers() {
        // Departure Petugas form
        document.getElementById('formDeparturePetugas').addEventListener('submit', (e) => {
            e.preventDefault();
            setButtonsState(true);
            const formData = new FormData(e.target);
            handleDepartureForm(formData, 'departurePetugasStatus');
            setButtonsState(false);
        });

        // Arrival Petugas form
        document.getElementById('formArrivalPetugas').addEventListener('submit', (e) => {
            e.preventDefault();
            setButtonsState(true);
            const formData = new FormData(e.target);
            handleArrivalForm(formData, 'arrivalPetugasStatus');
            setButtonsState(false);
        });

        // Departure Nelayan form
        document.getElementById('formDepartureNelayan').addEventListener('submit', (e) => {
            e.preventDefault();
            setButtonsState(true);
            const formData = new FormData(e.target);
            
            try {
                const data = {
                    'Nama Kapal': formData.get('namaKapal'),
                    'Pemilik/Nahkoda': formData.get('nakhoda'),
                    'Tanggal Berangkat': formData.get('tanggal'),
                    'Jam Berangkat': formData.get('jam'),
                    'Daerah Penangkapan': formData.get('tujuan')
                };

                for (const [key, value] of Object.entries(data)) {
                    if (!value || value.trim() === '') {
                        throw new Error(`${key} harus diisi`);
                    }
                }

                const doc = generatePDF(data, 'departure');
                doc.text('SURAT PERNYATAAN KEBERANGKATAN NELAYAN', 105, 20, { align: 'center' });
                
                const pdfBlob = doc.output('blob');
                const fileName = `Surat_Keberangkatan_Nelayan_${data['Nama Kapal'].replace(/\s+/g, '_')}_${data['Tanggal Berangkat']}.pdf`;
                
                const downloadUrl = URL.createObjectURL(pdfBlob);
                const downloadLink = `<a href="${downloadUrl}" download="${fileName}" class="download-link">
                    <i class="fas fa-download"></i> Download PDF
                </a>`;
                
                showStatus('departureNelayanStatus', `
                    <i class="fas fa-check-circle"></i> Dokumen berhasil dibuat!<br>
                    ${downloadLink}
                `, 'success');

                const uploadBtn = document.querySelector('#departureNelayan .btn-upload-drive');
                if (uploadBtn) {
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                    uploadBtn.onclick = () => uploadToGoogleDrive(file, 'Nelayan-Keberangkatan', 'departureNelayanStatus');
                    uploadBtn.disabled = false;
                }

            } catch (error) {
                console.error('‚úó Form error:', error);
                showStatus('departureNelayanStatus', `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'error');
            }
            
            setButtonsState(false);
        });

        // Arrival Nelayan form
        document.getElementById('formArrivalNelayan').addEventListener('submit', (e) => {
            e.preventDefault();
            setButtonsState(true);
            const formData = new FormData(e.target);
            
            try {
                const data = {
                    'Nama Kapal': formData.get('namaKapal'),
                    'Pemilik/Nahkoda': formData.get('nakhoda'),
                    'Tanggal Tiba': formData.get('tanggal'),
                    'Jam Tiba': formData.get('jam'),
                    'Asal Penangkapan': formData.get('asal')
                };

                for (const [key, value] of Object.entries(data)) {
                    if (!value || value.trim() === '') {
                        throw new Error(`${key} harus diisi`);
                    }
                }

                const doc = generatePDF(data, 'arrival');
                doc.text('SURAT PERNYATAAN KEDATANGAN NELAYAN', 105, 20, { align: 'center' });
                
                const pdfBlob = doc.output('blob');
                const fileName = `Surat_Kedatangan_Nelayan_${data['Nama Kapal'].replace(/\s+/g, '_')}_${data['Tanggal Tiba']}.pdf`;
                
                const downloadUrl = URL.createObjectURL(pdfBlob);
                const downloadLink = `<a href="${downloadUrl}" download="${fileName}" class="download-link">
                    <i class="fas fa-download"></i> Download PDF
                </a>`;
                
                showStatus('arrivalNelayanStatus', `
                    <i class="fas fa-check-circle"></i> Dokumen berhasil dibuat!<br>
                    ${downloadLink}
                `, 'success');

                const uploadBtn = document.querySelector('#arrivalNelayan .btn-upload-drive');
                if (uploadBtn) {
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                    uploadBtn.onclick = () => uploadToGoogleDrive(file, 'Nelayan-Kedatangan', 'arrivalNelayanStatus');
                    uploadBtn.disabled = false;
                }

            } catch (error) {
                console.error('‚úó Form error:', error);
                showStatus('arrivalNelayanStatus', `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`, 'error');
            }
            
            setButtonsState(false);
        });
    }

    function showPage(pageId, element) {
        // Hide all pages
        document.querySelectorAll('.content-page').forEach(page => {
            page.style.display = 'none';
        });
        
        // Show selected page
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.style.display = 'block';
        }
        
        // Update active sidebar item
        document.querySelectorAll('.sidebar a').forEach(a => {
            a.classList.remove('active');
        });
        if (element) {
            element.classList.add('active');
        }
    }

    // Initialize when DOM and scripts are ready
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ SANDAR-RATU initializing...');
        
        // Wait for Google APIs to load
        let attempts = 0;
        const maxAttempts = 50;
        
        const checkGoogleAPIs = () => {
            attempts++;
            
            if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
                console.log('‚úì Google APIs loaded');
                initializeGoogleAPIs();
            } else if (attempts < maxAttempts) {
                console.log(`‚è≥ Waiting for Google APIs... (${attempts}/${maxAttempts})`);
                setTimeout(checkGoogleAPIs, 100);
            } else {
                console.error('‚úó Google APIs failed to load');
                updateLoginButton('Google APIs tidak tersedia', true);
            }
        };
        
        checkGoogleAPIs();
    });

    // Global error handler
    window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
    });

    // Global promise rejection handler
    window.addEventListener('unhandledrejection', (e) => {
        console.error('Unhandled promise rejection:', e.reason);
    });

</script>
</body>
</html>f
