<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Integrasi Google Drive Upload</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #dashboard { display: none; }
    .status { margin-top: 10px; padding: 5px; border-radius: 4px; }
    .status.connected { background: #d4edda; color: #155724; }
    .status.disconnected { background: #f8d7da; color: #721c24; }
    .status.error { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h1>Demo Upload ke Google Drive</h1>

  <!-- LOGIN AREA -->
  <div id="login-page">
    <button id="googleLoginBtn">Login dengan Google</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <button id="logoutBtn">Logout</button>
    <div id="status-indicator" class="status disconnected">Belum login ke Google Drive</div>

    <h3>Upload Dokumen</h3>
    <form id="uploadForm">
      <label>SPB: <input type="file" name="spb"></label><br>
      <label>Crew List: <input type="file" name="crew_list"></label><br>
      <label>Perbekalan: <input type="file" name="perbekalan"></label><br>
      <button type="submit">Upload</button>
    </form>
    <div id="status"></div>
  </div>

  <!-- Load Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    // Konfigurasi OAuth2
    const CLIENT_ID = "YOUR_CLIENT_ID.apps.googleusercontent.com";
    const API_KEY = "YOUR_API_KEY";
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let googleAuth;

    // Mapping folder di Google Drive
    const folderMapping = {
      spb: "FOLDER_ID_SPB",
      crew_list: "FOLDER_ID_CREW_LIST",
      perbekalan: "FOLDER_ID_PERBEKALAN"
    };

    /** Inisialisasi Google API client */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: [DISCOVERY_DOC],
        scope: SCOPES
      }).then(() => {
        googleAuth = gapi.auth2.getAuthInstance();
        googleAuth.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(googleAuth.isSignedIn.get());
      });
    }

    /** Update UI sesuai status login */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById("login-page").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        updateGoogleDriveStatus(true);
      } else {
        document.getElementById("login-page").style.display = "block";
        document.getElementById("dashboard").style.display = "none";
        updateGoogleDriveStatus(false);
      }
    }

    /** Tombol login */
    async function googleLogin() {
      try {
        await googleAuth.signIn();
      } catch (err) {
        showStatus("Error login Google: " + err.message, "error");
      }
    }

    /** Logout */
    function logout() {
      if (googleAuth && googleAuth.isSignedIn.get()) {
        googleAuth.signOut();
      }
      updateSigninStatus(false);
    }

    /** Status Google Drive */
    function updateGoogleDriveStatus(isConnected) {
      const el = document.getElementById("status-indicator");
      if (isConnected) {
        el.textContent = "Terhubung dengan Google Drive";
        el.className = "status connected";
      } else {
        el.textContent = "Belum login ke Google Drive";
        el.className = "status disconnected";
      }
    }

    /** Upload form handler */
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!googleAuth.isSignedIn.get()) {
        showStatus("Silakan login ke Google dulu.", "error");
        return;
      }

      const files = e.target.elements;
      let success = 0, failed = 0;

      for (let name in folderMapping) {
        const fileInput = files[name];
        if (fileInput && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const folderId = folderMapping[name];
          const fileName = `${name}_${Date.now()}_${file.name}`;
          try {
            await uploadFileToGoogleDrive(file, folderId, fileName);
            success++;
          } catch (err) {
            console.error(err);
            failed++;
          }
        }
      }

      if (failed === 0) {
        showStatus(`Semua file berhasil diupload (${success}).`, "success");
      } else {
        showStatus(`Upload selesai: ${success} berhasil, ${failed} gagal.`, "error");
      }
    });

    /** Fungsi upload ke Google Drive */
    async function uploadFileToGoogleDrive(file, folderId, fileName) {
      const boundary = "-------314159265358979323846";
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const contentType = file.type || "application/octet-stream";
          const metadata = {
            name: fileName,
            mimeType: contentType,
            parents: [folderId]
          };

          const base64Data = btoa(e.target.result);
          const multipartRequestBody =
            delimiter +
            "Content-Type: application/json\r\n\r\n" +
            JSON.stringify(metadata) +
            delimiter +
            "Content-Type: " + contentType + "\r\n" +
            "Content-Transfer-Encoding: base64\r\n\r\n" +
            base64Data +
            close_delim;

          try {
            const response = await gapi.client.request({
              path: "/upload/drive/v3/files",
              method: "POST",
              params: { uploadType: "multipart" },
              headers: { "Content-Type": "multipart/related; boundary=" + boundary },
              body: multipartRequestBody
            });
            resolve(response.result);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsBinaryString(file);
      });
    }

    /** Status message */
    function showStatus(message, type) {
      const el = document.getElementById("status");
      el.textContent = message;
      el.className = "status " + (type || "");
    }

    /** Load Google API client */
    gapi.load("client:auth2", initClient);

    /** Event listeners */
    document.getElementById("googleLoginBtn").addEventListener("click", googleLogin);
    document.getElementById("logoutBtn").addEventListener("click", logout);
  </script>
</body>
</html>
