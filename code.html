<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
    header { background: #007bff; color: white; padding: 15px; text-align: center; font-size: 20px; }
    .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px;
      border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    .hidden { display: none; }
    .button { padding: 10px 20px; background: #007bff; color: white; border: none;
      border-radius: 5px; cursor: pointer; margin: 5px; }
    .button:hover { background: #0056b3; }
    nav { display: flex; justify-content: space-around; margin-bottom: 20px; }
    nav button { flex: 1; margin: 5px; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc;
      border-radius: 5px; }
    .actions { margin-top: 15px; }
    .result-container { margin-top: 20px; padding: 10px; border: 1px solid #ddd;
      border-radius: 5px; background: #fafafa; }
    .qr-section { margin: 15px 0; }
    .preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .preview-container img, .preview-container embed { width: 150px; height: auto;
      border: 1px solid #ddd; border-radius: 5px; }
    .document-summary table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .document-summary td { padding: 6px; border: 1px solid #ccc; }
  </style>
</head>
<body>
<header>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</header>
<div class="container">
  <div id="login-section">
    <h2>Login dengan Google</h2>
    <button id="login-btn" class="button"><i class="fab fa-google"></i> Login dengan Google</button>
    <p id="login-status"></p>
  </div>

  <div id="dashboard" class="hidden">
    <h2>Dashboard</h2>
    <p>Selamat datang, <span id="user-name"></span>!</p>
    <button class="button" onclick="logout()">Logout</button>
    <p id="drive-status"></p>

    <nav>
      <button class="button" onclick="showSection('petugas-keberangkatan')">Petugas - Keberangkatan</button>
      <button class="button" onclick="showSection('petugas-kedatangan')">Petugas - Kedatangan</button>
      <button class="button" onclick="showSection('nelayan-keberangkatan')">Nelayan - Keberangkatan</button>
      <button class="button" onclick="showSection('nelayan-kedatangan')">Nelayan - Kedatangan</button>
    </nav>

    <div id="forms">
      <!-- Form Example -->
      <div id="petugas-keberangkatan" class="form-section">
        <h3>Petugas - Keberangkatan</h3>
        <form data-form-type="petugas-keberangkatan">
          <label>Nama Kapal</label>
          <input type="text" required>
          <label>Tanggal</label>
          <input type="date" required>
          <label>Jam</label>
          <input type="time" required>
          <label>Nama Nahkoda</label>
          <input type="text" required>
          <label>Upload Dokumen</label>
          <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png">
          <div class="actions">
            <button type="button" class="button" onclick="uploadToGoogleDrive(this)">Upload ke Google Drive</button>
            <button type="button" class="button" onclick="generateAll(this)">Generate QR & Preview</button>
            <button type="button" class="button" onclick="downloadAll(this)">Download PDF</button>
          </div>
        </form>
        <div class="result-container"></div>
      </div>

      <!-- Tambahkan form lain sesuai kebutuhan -->
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = "YOUR_CLIENT_ID.apps.googleusercontent.com";
  const API_KEY = "YOUR_API_KEY";
  const SCOPES = "https://www.googleapis.com/auth/drive.file";

  let tokenClient;
  let currentUser = null;
  let currentAccessToken = null;

  const folderMapping = {
    "petugas-keberangkatan": "FOLDER_ID_1",
    "petugas-kedatangan": "FOLDER_ID_2",
    "nelayan-keberangkatan": "FOLDER_ID_3",
    "nelayan-kedatangan": "FOLDER_ID_4"
  };

  function gapiLoaded() { gapi.load("client:picker", initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        if (tokenResponse && tokenResponse.access_token) {
          currentAccessToken = tokenResponse.access_token;
          updateGoogleDriveStatus();
        }
      }
    });
  }

  document.getElementById("login-btn").onclick = () => {
    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: (response) => {
        const payload = parseJwt(response.credential);
        currentUser = payload;
        document.getElementById("user-name").innerText = payload.name;
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        tokenClient.requestAccessToken({ prompt: "consent" });
      }
    });
    google.accounts.id.prompt();
  };

  function logout() {
    if (currentAccessToken) google.accounts.oauth2.revoke(currentAccessToken);
    currentUser = null; currentAccessToken = null;
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("login-section").classList.remove("hidden");
  }

  function updateGoogleDriveStatus() {
    document.getElementById("drive-status").innerText = currentAccessToken ? "Google Drive: Terhubung ✅" : "Google Drive: Tidak terhubung ❌";
  }

  function showSection(id) {
    document.querySelectorAll(".form-section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  async function uploadToGoogleDrive(btn) {
    const form = btn.closest("form");
    const formType = form.getAttribute("data-form-type");
    const folderId = folderMapping[formType];
    const files = form.querySelector('input[type="file"]').files;
    if (!files.length) { alert("Pilih file untuk diupload."); return; }
    if (!currentAccessToken) { tokenClient.requestAccessToken({ prompt: "" }); return; }
    for (let file of files) {
      let metadata = { name: file.name, parents: [folderId] };
      let formData = new FormData();
      formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      formData.append("file", file);
      await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST", headers: { Authorization: "Bearer " + currentAccessToken }, body: formData
      });
    }
    alert("Upload selesai!");
  }

  function parseJwt(token) {
    var base64Url = token.split(".")[1];
    var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
    return JSON.parse(decodeURIComponent(atob(base64).split("").map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("")));
  }

  // --- Generate QR & Preview ---
  async function generateAll(btn) {
    const form = btn.closest("form");
    const formType = form.getAttribute('data-form-type');
    const resultContainer = form.parentElement.querySelector(".result-container");
    resultContainer.innerHTML = "";

    const shipName = form.querySelectorAll('input[type="text"]')[0].value || "KAPAL";
    const date = form.querySelector('input[type="date"]').value;
    const time = form.querySelector('input[type="time"]').value;
    const captain = form.querySelectorAll('input[type="text"]')[1].value || "Nahkoda";

    const files = Array.from(form.querySelectorAll('input[type="file"]')).filter(input => input.files.length > 0);
    if (files.length === 0) { alert("Pilih minimal satu file untuk preview + QR!"); return; }

    let qrDiv = document.createElement("div");
    qrDiv.className = "qr-section";
    qrDiv.innerHTML = `<h3>QR Code Dokumen</h3><div id="qrcode"></div>`;
    resultContainer.appendChild(qrDiv);

    new QRCode(qrDiv.querySelector("#qrcode"), {
      text: "https://drive.google.com/drive/folders/" + folderMapping[formType],
      width: 128, height: 128
    });

    let summary = document.createElement("div");
    summary.className = "document-summary";
    summary.innerHTML = `
      <h3>Ringkasan Dokumen</h3>
      <table>
        <tr><td>Nama Kapal</td><td>${shipName}</td></tr>
        <tr><td>Tanggal</td><td>${date} ${time}</td></tr>
        <tr><td>Nama Nahkoda</td><td>${captain}</td></tr>
        <tr><td>Jumlah Dokumen</td><td>${files.length}</td></tr>
      </table>`;
    resultContainer.appendChild(summary);

    let preview = document.createElement("div");
    preview.className = "preview-container";
    preview.innerHTML = "<h4>Preview Dokumen</h4>";
    files.forEach(f => {
      const file = f.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        let el;
        if (file.type.includes("image")) {
          el = document.createElement("img"); el.src = e.target.result;
        } else { el = document.createElement("embed"); el.src = e.target.result; el.type = file.type; }
        preview.appendChild(el);
      };
      reader.readAsDataURL(file);
    });
    resultContainer.appendChild(preview);
  }

  async function downloadAll(btn) {
    const form = btn.closest("form");
    const resultContainer = form.parentElement.querySelector(".result-container");
    if (!resultContainer.innerHTML.trim()) { alert("Generate QR & Preview dulu sebelum download!"); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16); doc.text("Ringkasan Dokumen Kapal", 10, 20);
    let y = 40;
    resultContainer.querySelectorAll(".document-summary table tr").forEach(tr => {
      const cols = tr.querySelectorAll("td");
      doc.setFontSize(12); doc.text(`${cols[0].innerText}: ${cols[1].innerText}`, 10, y); y += 8;
    });

    const qrCanvas = resultContainer.querySelector("canvas");
    if (qrCanvas) {
      const qrImg = qrCanvas.toDataURL("image/png");
      doc.addImage(qrImg, "PNG", 150, 20, 40, 40);
    }
    doc.save("Dokumen-Kapal.pdf");
  }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
