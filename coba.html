<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINPELKES-PPSK 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: white;
      background: #0d5f8a;
      padding: 12px 24px;
      border-radius: 10px;
      margin: 0;
      display: inline-block;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .kb-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .kb-controls button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .kb-controls button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40,167,69,0.4);
    }
    .kb-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .kb-controls button.btn-refresh {
      background: #007bff;
    }
    .kb-controls button.btn-refresh:hover {
      background: #0056b3;
    }
    .auto-refresh-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      font-size: 13px;
      color: #155724;
    }
    .auto-refresh-status.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    .auto-refresh-status.inactive {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      animation: pulse 2s infinite;
    }
    .status-indicator.inactive {
      background: #dc3545;
      animation: none;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading, .error {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d5f8a;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .kb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .kb-table thead {
      background: #0d5f8a;
      color: white;
      position: sticky;
      top: 0;
    }
    .kb-table th, .kb-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    .kb-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .kb-table tbody tr:hover {
      background: #e9ecef;
    }
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Sistem Informasi Pelayanan Kesyahbandaran PPS Kendar 2025</h2>
      <div class="kb-controls">
        <button id="btn-load-gsheets">Muat Data Manual</button>
        <button id="btn-toggle-auto" class="btn-refresh">Auto-Refresh: ON</button>
        <div class="auto-refresh-status active">
          <span class="status-indicator"></span>
          <span id="refresh-text">Auto-refresh setiap 30 detik</span>
        </div>
      </div>
    </div>

    <div id="loading-indicator" class="loading" style="display:none;">Memuat data dari Google Sheets...</div>
    <div id="error-message" class="error" style="display:none;"></div>
    <div id="success-message" class="success" style="display:none;"></div>

    <!-- Grid Layout 3 kolom untuk baris pertama -->
    <div class="grid-3">
      <!-- Aktivitas Kapal -->
      <div class="chart-container">
        <div class="chart-title">Aktivitas Kapal</div>
        <canvas id="chart-aktivitas-kapal" style="max-height:220px;"></canvas>
      </div>

      <!-- Perizinan Kapal (Izin Daerah vs Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Perizinan Kapal (Daerah vs Pusat)</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-kapal"></canvas>
        </div>
      </div>

      <!-- Perizinan Kapal (Detail Izin Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Detail Perizinan Pusat</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-detail"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Layout 3 kolom untuk baris kedua -->
    <div class="grid-3">
      <!-- Top 10 Alat Tangkap -->
      <div class="chart-container">
        <div class="chart-title">Top 10 Alat Tangkap</div>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;">Sebaran GT Kapal</div>
        <canvas id="chart-alat-tangkap" style="max-height:280px;"></canvas>
      </div>

      <!-- Jumlah SKKP Diterbitkan -->
      <div class="chart-container">
        <div class="chart-title">Jumlah SKKP Diterbitkan</div>
        <canvas id="chart-skkp" style="max-height:280px;"></canvas>
      </div>

      <!-- Masa Berlaku Izin Akan Habis -->
      <div class="chart-container">
        <div class="chart-title">Masa Berlaku Izin Akan Habis</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table class="kb-table" id="table-izin-habis">
            <thead>
              <tr>
                <th>Nama Kapal</th>
                <th>Nomor Izin</th>
                <th>Tanggal Akhir</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center; color:#999;">Belum ada data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tabel Detail PKL (Full width di bawah) -->
    <div class="chart-container" style="margin-top:16px;">
      <div class="chart-title">Tabel Data PKL</div>
      <div style="max-height:360px; overflow:auto;">
        <table class="kb-table" id="kb-table">
          <thead>
            <tr>
              <th>No.</th><th>NOMOR PKL</th><th>TANGGAL PKL</th><th>NAMA KAPAL</th><th>GT</th><th>NAMA PEMILIK</th><th>NAMA AWAK</th><th>JABATAN</th><th>JENIS PENGUPAHAN</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center; color:#999;">Belum ada data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = '1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254';
    const SHEETS = {
      aktivitas: '1397215787',
      perizinan: '698992828',
      alatTangkap: '1309011826',
      skkp: '566117585',
      izinHabis: '583377591',
      pkl: '264793408',
      perizinanDetail: '2099648587'
    };

    let charts = {};
    let autoRefreshInterval = null;
    let isAutoRefreshEnabled = true;
    const REFRESH_INTERVAL = 30000; // 30 detik

    // Fungsi untuk mengambil data dari Google Sheets
    async function fetchSheetData(gid) {
      try {
        // Tambahkan timestamp untuk menghindari cache
        const timestamp = new Date().getTime();
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}&_=${timestamp}`;
        const response = await fetch(url, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csv = await response.text();
        console.log(`Data dari GID ${gid} (${new Date().toLocaleTimeString()}):`, csv.substring(0, 200));
        return parseCSV(csv);
      } catch (error) {
        console.error(`Error fetching GID ${gid}:`, error);
        throw error;
      }
    }

    // Parse CSV
    function parseCSV(csv) {
      const lines = csv.trim().split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length > 0) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          data.push(row);
        }
      }
      
      console.log('Parsed data:', data.slice(0, 3));
      return data;
    }

    // Parse single CSV line
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    // Chart Aktivitas Kapal
    function createAktivitasChart(data) {
      const ctx = document.getElementById('chart-aktivitas-kapal').getContext('2d');
      
      if (charts.aktivitas) {
        charts.aktivitas.destroy();
      }
      
      console.log('Aktivitas Data:', data);
      
      if (data.length === 0) {
        charts.aktivitas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
            datasets: [
              {
                label: 'Kapal Masuk',
                data: [45, 52, 48, 55, 60, 58],
                backgroundColor: '#36a2eb',
                borderColor: '#2589d6',
                borderWidth: 1
              },
              {
                label: 'Kapal Keluar',
                data: [42, 50, 46, 53, 58, 56],
                backgroundColor: '#ff6384',
                borderColor: '#e5506e',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 10 }
                }
              },
              y: { 
                beginAtZero: true,
                ticks: {
                  font: { size: 10 }
                }
              }
            }
          }
        });
        return;
      }
      
      const labels = [];
      const masuk = [];
      const keluar = [];
      
      data.forEach(row => {
        const values = Object.values(row);
        
        if (values[0] && values[0].toString().trim() !== '') {
          let labelText = values[0].toString().trim();
          
          const dateMatch = labelText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
          if (dateMatch) {
            const [, day, month, year] = dateMatch;
            labelText = `${day}/${month}/${year.substring(2)}`;
          }
          
          labels.push(labelText);
          
          const masukVal = Math.round(parseFloat(values[1]) || 0);
          masuk.push(masukVal);
          
          const keluarVal = Math.round(parseFloat(values[2]) || 0);
          keluar.push(keluarVal);
        }
      });
      
      console.log('Aktivitas Chart - Labels:', labels);
      console.log('Aktivitas Chart - Masuk:', masuk);
      console.log('Aktivitas Chart - Keluar:', keluar);
      
      charts.aktivitas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Kapal Masuk',
              data: masuk,
              backgroundColor: '#36a2eb',
              borderColor: '#2589d6',
              borderWidth: 1
            },
            {
              label: 'Kapal Keluar',
              data: keluar,
              backgroundColor: '#ff6384',
              borderColor: '#e5506e',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' kapal';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: { size: 9 }
              }
            },
            y: { 
              beginAtZero: true,
              ticks: {
                font: { size: 10 },
                callback: function(value) {
                  return value;
                }
              }
            }
          }
        }
      });
    }

    // Chart Perizinan Kapal
    function createPerizinanChart(data) {
      const ctx = document.getElementById('chart-perizinan-kapal').getContext('2d');
      
      if (charts.perizinan) {
        charts.perizinan.destroy();
      }
      
      let daerah = 0;
      let pusat = 0;
      
      data.forEach(row => {
        const jenis = Object.values(row).join(' ').toLowerCase();
        if (jenis.includes('daerah')) daerah++;
        if (jenis.includes('pusat')) pusat++;
      });
      
      if (daerah === 0 && pusat === 0) {
        daerah = 150;
        pusat = 250;
      }
      
      console.log('Perizinan Chart - Daerah:', daerah, 'Pusat:', pusat);
      
      charts.perizinan = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Izin Daerah', 'Izin Pusat'],
          datasets: [{
            data: [daerah, pusat],
            backgroundColor: ['#4bc0c0', '#ff9f40'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Chart Detail Perizinan Pusat
    function createPerizinanDetailChart(data) {
      const ctx = document.getElementById('chart-perizinan-detail').getContext('2d');
      
      if (charts.perizinanDetail) {
        charts.perizinanDetail.destroy();
      }
      
      const counts = {};
      
      data.forEach(row => {
        const jenis = Object.values(row)[0] || 'Lainnya';
        counts[jenis] = (counts[jenis] || 0) + 1;
      });
      
      let labels = Object.keys(counts);
      let values = Object.values(counts);
      
      if (labels.length === 0) {
        labels = ['SIUP', 'SIPI', 'SIKPI', 'Lainnya'];
        values = [120, 80, 50, 30];
      }
      
      console.log('Perizinan Detail - Labels:', labels, 'Values:', values);
      
      charts.perizinanDetail = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { font: { size: 10 } }
            }
          }
        }
      });
    }

    // Chart Alat Tangkap - DIPERBARUI untuk menggunakan KEDUA data (perizinan + izinHabis)
    function createAlatTangkapChart(dataPerizinan, dataIzinHabis) {
      const ctx = document.getElementById('chart-alat-tangkap').getContext('2d');
      
      if (charts.alatTangkap) {
        charts.alatTangkap.destroy();
      }
      
      console.log('ðŸ“Š Alat Tangkap - Data Perizinan:', dataPerizinan.length, 'baris');
      console.log('ðŸ“Š Alat Tangkap - Data Izin Habis:', dataIzinHabis.length, 'baris');
      
      const grouped = {};
      
      // Process data dari KEDUA sheet
      const processData = (data, sourceLabel) => {
        const headers = Object.keys(data[0] || {});
        
        let alatTangkapCol = null;
        let gtCol = null;
        
        headers.forEach((header) => {
          const lowerHeader = header.toLowerCase();
          if (lowerHeader.includes('alat tangkap')) {
            alatTangkapCol = header;
          }
          if (lowerHeader === 'gt kapal' || lowerHeader === 'gt') {
            gtCol = header;
          }
        });
        
        let validDataCount = 0;
        data.forEach(row => {
          if (alatTangkapCol && gtCol) {
            const alatTangkap = row[alatTangkapCol] ? row[alatTangkapCol].toString().trim() : '';
            const gt = parseFloat(row[gtCol]) || 0;
            
            if (alatTangkap && alatTangkap.length > 0 && gt > 0) {
              grouped[alatTangkap] = (grouped[alatTangkap] || 0) + gt;
              validDataCount++;
            }
          }
        });
        
        console.log(`âœ… ${sourceLabel}: ${validDataCount} data valid diproses`);
        return validDataCount;
      };
      
      const perizinanCount = processData(dataPerizinan, 'Sheet Perizinan (SPB)');
      const izinHabisCount = processData(dataIzinHabis, 'Sheet Izin Habis');
      
      console.log('ðŸ”— Total data dari kedua sheet:', perizinanCount + izinHabisCount);
      console.log('ðŸ“ˆ Grouped data:', grouped);
      
      const sorted = Object.entries(grouped)
        .filter(([k, v]) => v > 0)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      let labels = sorted.map(x => x[0]);
      let values = sorted.map(x => x[1]);
      
      // Jika data kosong atau terlalu sedikit, tampilkan pesan dan gunakan dummy
      const isPlaceholder = labels.length === 0;
      if (isPlaceholder) {
        console.warn('âš ï¸ Tidak ada data alat tangkap yang valid! Menampilkan data placeholder.');
        labels = ['Purse Seine', 'Gillnet', 'Pancing', 'Jaring Insang', 'Bubu', 'Payang', 'Trammel Net', 'Rawai', 'Bagan', 'Sero'];
        values = [1500, 1200, 800, 600, 450, 400, 350, 300, 250, 200];
      }
      
      console.log('ðŸ“Š Alat Tangkap Chart - Labels:', labels, 'Values:', values);
      console.log('ðŸ“Š Status:', isPlaceholder ? 'âŒ PLACEHOLDER' : 'âœ… REAL DATA');
      
      charts.alatTangkap = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total GT',
            data: values,
            backgroundColor: isPlaceholder ? '#cccccc' : '#9966ff',
            borderColor: isPlaceholder ? '#999999' : '#8855ee',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  if (isPlaceholder) {
                    return '(Data Placeholder - Silakan isi data di kedua sheet)';
                  }
                  return `(${perizinanCount} dari Perizinan + ${izinHabisCount} dari Izin Habis)`;
                }
              }
            }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    // Fungsi untuk chart SKKP
    function createSKKPChart(data){
      const ctx=document.getElementById('chart-skkp').getContext('2d');
      if(charts.skkp)charts.skkp.destroy();
      console.log('SKKP Data:',data);
      
      let labels=[],values=[];
      
      const validData=data.filter(row=>{
        const rowValues=Object.values(row);
        return rowValues[0]&&rowValues[0].toString().trim()!==''&&parseFloat(rowValues[1])>0;
      }).slice(0,6);
      
      if(validData.length===0){
        labels=['Jan','Feb','Mar','Apr','Mei','Jun'];
        values=[85,92,88,95,100,98];
      }else{
        validData.forEach(row=>{
          const rowValues=Object.values(row);
          labels.push(rowValues[0].toString().trim());
          const skkpVal=parseFloat(rowValues[1])||0;
          values.push(skkpVal);
        });
      }
      
      console.log('SKKP Chart - Labels:',labels,'Values:',values);
      charts.skkp=new Chart(ctx,{
        type:'line',
        data:{
          labels:labels,
          datasets:[{
            label:'SKKP Diterbitkan',
            data:values,
            backgroundColor:'rgba(255, 182, 193, 0.5)',
            borderColor:'#ff6b9d',
            borderWidth:2,
            fill:true,
            tension:0.4,
            pointBackgroundColor:'#ff6b9d',
            pointBorderColor:'#fff',
            pointBorderWidth:2,
            pointRadius:5,
            pointHoverRadius:7
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{position:'bottom',labels:{font:{size:11},boxWidth:40,padding:10}},
            tooltip:{callbacks:{label:function(context){return'SKKP Diterbitkan: '+context.parsed.y}}}
          },
          scales:{
            x:{
              grid:{display:true,color:'rgba(0, 0, 0, 0.05)'},
              ticks:{font:{size:11},maxRotation:45,minRotation:0}
            },
            y:{
              beginAtZero:true,
              grid:{display:true,color:'rgba(0, 0, 0, 0.05)'},
              ticks:{font:{size:11},stepSize:10}
            }
          }
        }
      });
    }

    // Tabel Izin Habis
    function fillIzinHabisTable(data) {
      const tbody = document.querySelector('#table-izin-habis tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      const displayData = data.slice(0, 10);
      
      displayData.forEach(row => {
        const headers = Object.keys(row);
        
        const findValue = (keywords) => {
          for (let keyword of keywords) {
            for (let header of headers) {
              if (header.toLowerCase().includes(keyword.toLowerCase())) {
                return row[header] || '-';
              }
            }
          }
          return '-';
        };
        
        const namaKapal = findValue(['nama kapal', 'kapal', 'nama']);
        const nomorIzin = findValue(['nomor izin', 'izin', 'no', 'nomor']);
        const tanggalAkhir = findValue(['tanggal akhir', 'akhir', 'expired', 'tanggal']);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${namaKapal}</td>
          <td>${nomorIzin}</td>
          <td>${tanggalAkhir}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Tabel PKL
    function fillPKLTable(data) {
      const tbody = document.querySelector('#kb-table tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      data.forEach((row, idx) => {
        const headers = Object.keys(row);
        
        const findValue = (keywords) => {
          for (let keyword of keywords) {
            for (let header of headers) {
              if (header.toLowerCase().includes(keyword.toLowerCase())) {
                return row[header] || '-';
              }
            }
          }
          return '-';
        };
        
        const nomorPKL = findValue(['nomor pkl', 'nomor', 'no pkl']);
        const tanggalPKL = findValue(['tanggal pkl', 'tanggal', 'tgl']);
        const namaKapal = findValue(['nama kapal', 'kapal']);
        const gt = findValue(['gt']);
        const namaPemilik = findValue(['nama pemilik', 'pemilik']);
        const namaAwak = findValue(['nama awak', 'awak']);
        const jabatan = findValue(['jabatan']);
        const jenisPengupahan = findValue(['jenis pengupahan', 'pengupahan', 'upah']);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${nomorPKL}</td>
          <td>${tanggalPKL}</td>
          <td>${namaKapal}</td>
          <td>${gt}</td>
          <td>${namaPemilik}</td>
          <td>${namaAwak}</td>
          <td>${jabatan}</td>
          <td>${jenisPengupahan}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Load semua data
    async function loadAllData(isAutoRefresh = false) {
      const loadingEl = document.getElementById('loading-indicator');
      const errorEl = document.getElementById('error-message');
      const successEl = document.getElementById('success-message');
      const btn = document.getElementById('btn-load-gsheets');
      
      if (!isAutoRefresh) {
        loadingEl.style.display = 'block';
        btn.disabled = true;
      }
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      try {
        console.log('Memulai fetch data...', new Date().toLocaleTimeString());
        
        const results = await Promise.allSettled([
          fetchSheetData(SHEETS.aktivitas),
          fetchSheetData(SHEETS.perizinan),
          fetchSheetData(SHEETS.alatTangkap),
          fetchSheetData(SHEETS.skkp),
          fetchSheetData(SHEETS.izinHabis),
          fetchSheetData(SHEETS.pkl),
          fetchSheetData(SHEETS.perizinanDetail)
        ]);
        
        const [aktivitas, perizinan, alatTangkap, skkp, izinHabis, pkl, perizinanDetail] = results.map((r) => {
          if (r.status === 'fulfilled' && r.value.length > 0) {
            return r.value;
          } else {
            return [];
          }
        });
        
        createAktivitasChart(aktivitas);
        createPerizinanChart(perizinan);
        createPerizinanDetailChart(perizinanDetail);
        // PERUBAHAN: Gunakan KEDUA data perizinan + izinHabis untuk chart alat tangkap
        createAlatTangkapChart(perizinan, izinHabis);
        createSKKPChart(skkp);
        fillIzinHabisTable(izinHabis);
        fillPKLTable(pkl);
        
        if (!isAutoRefresh) {
          loadingEl.style.display = 'none';
          successEl.textContent = 'Data berhasil dimuat dari Google Sheets!';
          successEl.style.display = 'block';
          
          setTimeout(() => {
            successEl.style.display = 'none';
          }, 3000);
        } else {
          console.log('Auto-refresh berhasil:', new Date().toLocaleTimeString());
        }
        
      } catch (error) {
        console.error('Error:', error);
        if (!isAutoRefresh) {
          loadingEl.style.display = 'none';
          errorEl.textContent = 'Gagal memuat data: ' + error.message;
          errorEl.style.display = 'block';
        }
      } finally {
        if (!isAutoRefresh) {
          btn.disabled = false;
        }
      }
    }

    // Fungsi toggle auto-refresh
    function toggleAutoRefresh() {
      const btn = document.getElementById('btn-toggle-auto');
      const statusEl = document.querySelector('.auto-refresh-status');
      const statusIndicator = document.querySelector('.status-indicator');
      const refreshText = document.getElementById('refresh-text');
      
      isAutoRefreshEnabled = !isAutoRefreshEnabled;
      
      if (isAutoRefreshEnabled) {
        // Aktifkan auto-refresh
        btn.textContent = 'Auto-Refresh: ON';
        btn.style.background = '#007bff';
        statusEl.classList.remove('inactive');
        statusEl.classList.add('active');
        statusIndicator.classList.remove('inactive');
        refreshText.textContent = 'Auto-refresh setiap 30 detik';
        
        // Start interval
        autoRefreshInterval = setInterval(() => {
          loadAllData(true);
        }, REFRESH_INTERVAL);
        
        console.log('Auto-refresh diaktifkan');
      } else {
        // Nonaktifkan auto-refresh
        btn.textContent = 'Auto-Refresh: OFF';
        btn.style.background = '#6c757d';
        statusEl.classList.remove('active');
        statusEl.classList.add('inactive');
        statusIndicator.classList.add('inactive');
        refreshText.textContent = 'Auto-refresh dinonaktifkan';
        
        // Clear interval
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        
        console.log('Auto-refresh dinonaktifkan');
      }
    }

    // Event listener
    document.getElementById('btn-load-gsheets').addEventListener('click', () => loadAllData(false));
    document.getElementById('btn-toggle-auto').addEventListener('click', toggleAutoRefresh);
    
    // Auto load saat halaman dibuka
    window.addEventListener('load', () => {
      setTimeout(() => {
        loadAllData(false);
        
        // Start auto-refresh interval
        if (isAutoRefreshEnabled) {
          autoRefreshInterval = setInterval(() => {
            loadAllData(true);
          }, REFRESH_INTERVAL);
        }
      }, 500);
    });
    
    // Cleanup saat halaman ditutup
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
