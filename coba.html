<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINPELKES-PPSK 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: white;
      background: #0d5f8a;
      padding: 12px 24px;
      border-radius: 10px;
      margin: 0;
      display: inline-block;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .kb-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .kb-controls button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .kb-controls button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40,167,69,0.4);
    }
    .kb-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .kb-controls button.btn-refresh {
      background: #007bff;
    }
    .kb-controls button.btn-refresh:hover {
      background: #0056b3;
    }
    .auto-refresh-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      font-size: 13px;
      color: #155724;
    }
    .auto-refresh-status.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    .auto-refresh-status.inactive {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
      animation: pulse 2s infinite;
    }
    .status-indicator.inactive {
      background: #dc3545;
      animation: none;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading, .error {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d5f8a;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .kb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .kb-table thead {
      background: #0d5f8a;
      color: white;
      position: sticky;
      top: 0;
    }
    .kb-table th, .kb-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    .kb-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .kb-table tbody tr:hover {
      background: #e9ecef;
    }
    .debug-info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      color: #333;
      margin-top: 10px;
      max-height: 100px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Sistem Informasi Pelayanan Kesyahbandaran PPS Kendar 2025</h2>
      <div class="kb-controls">
        <button id="btn-load-gsheets">Muat Data Manual</button>
        <button id="btn-toggle-auto" class="btn-refresh">Auto-Refresh: ON</button>
        <div class="auto-refresh-status active">
          <span class="status-indicator"></span>
          <span id="refresh-text">Auto-refresh setiap 30 detik</span>
        </div>
      </div>
    </div>

    <div id="loading-indicator" class="loading" style="display:none;">Memuat data dari Google Sheets...</div>
    <div id="error-message" class="error" style="display:none;"></div>
    <div id="success-message" class="success" style="display:none;"></div>

    <!-- Grid Layout 3 kolom untuk baris pertama -->
    <div class="grid-3">
      <!-- Aktivitas Kapal -->
      <div class="chart-container">
        <div class="chart-title">Aktivitas Kapal</div>
        <canvas id="chart-aktivitas-kapal" style="max-height:220px;"></canvas>
        <div class="debug-info" id="debug-aktivitas"></div>
      </div>

      <!-- Perizinan Kapal (Izin Daerah vs Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Perizinan Kapal (Daerah vs Pusat)</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-kapal"></canvas>
        </div>
        <div class="debug-info" id="debug-perizinan"></div>
      </div>

      <!-- Perizinan Kapal (Detail Izin Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Detail Perizinan Pusat</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-detail"></canvas>
        </div>
        <div class="debug-info" id="debug-perizinan-detail"></div>
      </div>
    </div>

    <!-- Grid Layout 3 kolom untuk baris kedua -->
    <div class="grid-3">
      <!-- Top 10 Alat Tangkap -->
      <div class="chart-container">
        <div class="chart-title">Top 10 Alat Tangkap</div>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;">Sebaran GT Kapal</div>
        <canvas id="chart-alat-tangkap" style="max-height:280px;"></canvas>
        <div class="debug-info" id="debug-alat-tangkap"></div>
      </div>

      <!-- Jumlah SKKP Diterbitkan -->
      <div class="chart-container">
        <div class="chart-title">Jumlah SKKP Diterbitkan</div>
        <canvas id="chart-skkp" style="max-height:280px;"></canvas>
        <div class="debug-info" id="debug-skkp"></div>
      </div>

      <!-- Masa Berlaku Izin Akan Habis -->
      <div class="chart-container">
        <div class="chart-title">Masa Berlaku Izin Akan Habis</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table class="kb-table" id="table-izin-habis">
            <thead>
              <tr>
                <th>Nama Kapal</th>
                <th>Nomor Izin</th>
                <th>Tanggal Akhir</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center; color:#999;">Belum ada data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tabel Detail PKL (Full width di bawah) -->
    <div class="chart-container" style="margin-top:16px;">
      <div class="chart-title">Tabel Data PKL</div>
      <div style="max-height:360px; overflow:auto;">
        <table class="kb-table" id="kb-table">
          <thead>
            <tr>
              <th>No.</th><th>NOMOR PKL</th><th>TANGGAL PKL</th><th>NAMA KAPAL</th><th>GT</th><th>NAMA PEMILIK</th><th>NAMA AWAK</th><th>JABATAN</th><th>JENIS PENGUPAHAN</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center; color:#999;">Belum ada data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = '1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254';
    const SHEETS = {
      aktivitas: '1397215787',
      perizinan: '698992828',
      alatTangkap: '1309011826',
      skkp: '566117585',
      izinHabis: '583377591',
      pkl: '264793408',
      perizinanDetail: '2099648587'
    };

    let charts = {};
    let autoRefreshInterval = null;
    let isAutoRefreshEnabled = true;
    const REFRESH_INTERVAL = 30000;

    // Improved CSV Parser
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function parseCSV(csv) {
      const lines = csv.trim().split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.some(v => v !== '')) { // Only add rows with at least one non-empty value
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          data.push(row);
        }
      }
      
      return data;
    }

    async function fetchSheetData(gid) {
      try {
        const timestamp = new Date().getTime();
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}&_=${timestamp}`;
        const response = await fetch(url, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csv = await response.text();
        return parseCSV(csv);
      } catch (error) {
        console.error(`Error fetching GID ${gid}:`, error);
        throw error;
      }
    }

    // Helper: Find column by name (case-insensitive, flexible match)
    function findColumn(headers, keywords) {
      for (let keyword of keywords) {
        const found = headers.find(h => h.toLowerCase().includes(keyword.toLowerCase()));
        if (found) return found;
      }
      return null;
    }

    function updateDebugInfo(elementId, text) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = text;
      }
    }

    // Chart Aktivitas Kapal
    function createAktivitasChart(data) {
      const ctx = document.getElementById('chart-aktivitas-kapal').getContext('2d');
      
      if (charts.aktivitas) {
        charts.aktivitas.destroy();
      }
      
      if (data.length === 0) {
        charts.aktivitas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
            datasets: [
              {
                label: 'Kapal Masuk',
                data: [45, 52, 48, 55, 60, 58],
                backgroundColor: '#36a2eb'
              },
              {
                label: 'Kapal Keluar',
                data: [42, 50, 46, 53, 58, 56],
                backgroundColor: '#ff6384'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
        updateDebugInfo('debug-aktivitas', 'âš ï¸ No data');
        return;
      }
      
      const headers = Object.keys(data[0]);
      const tanggalCol = findColumn(headers, ['tanggal', 'tgl', 'date']);
      const masukCol = findColumn(headers, ['masuk', 'kedatangan', 'arrival']);
      const keluarCol = findColumn(headers, ['keluar', 'keberangkatan', 'departure']);
      
      const labels = [];
      const masuk = [];
      const keluar = [];
      
      data.forEach(row => {
        if (tanggalCol && masukCol && keluarCol) {
          labels.push(row[tanggalCol] || '');
          masuk.push(Math.round(parseFloat(row[masukCol]) || 0));
          keluar.push(Math.round(parseFloat(row[keluarCol]) || 0));
        }
      });
      
      charts.aktivitas = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Kapal Masuk',
              data: masuk,
              backgroundColor: '#36a2eb'
            },
            {
              label: 'Kapal Keluar',
              data: keluar,
              backgroundColor: '#ff6384'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
      
      updateDebugInfo('debug-aktivitas', `âœ… ${data.length} rows | Tanggal: ${tanggalCol} | Masuk: ${masukCol} | Keluar: ${keluarCol}`);
    }

    // Chart Perizinan
    function createPerizinanChart(data) {
      const ctx = document.getElementById('chart-perizinan-kapal').getContext('2d');
      if (charts.perizinan) charts.perizinan.destroy();
      
      let daerah = 0, pusat = 0;
      
      data.forEach(row => {
        const allValues = Object.values(row).join(' ').toLowerCase();
        if (allValues.includes('daerah')) daerah++;
        if (allValues.includes('pusat')) pusat++;
      });
      
      if (daerah === 0 && pusat === 0) {
        daerah = 150;
        pusat = 250;
      }
      
      charts.perizinan = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Izin Daerah', 'Izin Pusat'],
          datasets: [{
            data: [daerah, pusat],
            backgroundColor: ['#4bc0c0', '#ff9f40']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
      
      updateDebugInfo('debug-perizinan', `âœ… ${data.length} rows | Daerah: ${daerah} | Pusat: ${pusat}`);
    }

    // Chart Perizinan Detail
    function createPerizinanDetailChart(data) {
      const ctx = document.getElementById('chart-perizinan-detail').getContext('2d');
      if (charts.perizinanDetail) charts.perizinanDetail.destroy();
      
      const counts = {};
      data.forEach(row => {
        const jenis = Object.values(row)[0] || 'Lainnya';
        counts[jenis] = (counts[jenis] || 0) + 1;
      });
      
      let labels = Object.keys(counts);
      let values = Object.values(counts);
      
      if (labels.length === 0) {
        labels = ['SIUP', 'SIPI', 'SIKPI', 'Lainnya'];
        values = [120, 80, 50, 30];
      }
      
      charts.perizinanDetail = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
      
      updateDebugInfo('debug-perizinan-detail', `âœ… ${data.length} rows | Jenis: ${labels.length}`);
    }

    // Chart Alat Tangkap - IMPROVED
    function createAlatTangkapChart(dataPerizinan, dataIzinHabis) {
      const ctx = document.getElementById('chart-alat-tangkap').getContext('2d');
      if (charts.alatTangkap) charts.alatTangkap.destroy();
      
      const grouped = {};
      let processedCount = 0;
      
      // Process Perizinan
      if (dataPerizinan.length > 0) {
        const headers = Object.keys(dataPerizinan[0]);
        const alatCol = findColumn(headers, ['alat tangkap', 'alat', 'jenis alat']);
        const gtCol = findColumn(headers, ['gt kapal', 'gt']);
        
        dataPerizinan.forEach(row => {
          if (alatCol && gtCol) {
            const alat = (row[alatCol] || '').toString().trim();
            const gt = parseFloat(row[gtCol]) || 0;
            if (alat && gt > 0) {
              grouped[alat] = (grouped[alat] || 0) + gt;
              processedCount++;
            }
          }
        });
        updateDebugInfo('debug-alat-tangkap', `Perizinan: ${processedCount} rows | Alat: ${alatCol} | GT: ${gtCol}\n`);
      }
      
      // Process Izin Habis
      if (dataIzinHabis.length > 0) {
        const headers = Object.keys(dataIzinHabis[0]);
        const alatCol = findColumn(headers, ['alat tangkap', 'alat', 'jenis alat']);
        const gtCol = findColumn(headers, ['gt']);
        
        let izinHabisCount = 0;
        dataIzinHabis.forEach(row => {
          if (alatCol && gtCol) {
            const alat = (row[alatCol] || '').toString().trim();
            const gt = parseFloat(row[gtCol]) || 0;
            if (alat && gt > 0) {
              grouped[alat] = (grouped[alat] || 0) + gt;
              izinHabisCount++;
            }
          }
        });
        updateDebugInfo('debug-alat-tangkap', document.getElementById('debug-alat-tangkap').textContent + `IzinHabis: ${izinHabisCount} rows\n`);
      }
      
      const sorted = Object.entries(grouped)
        .filter(([k, v]) => v > 0)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      let labels = sorted.map(x => x[0]);
      let values = sorted.map(x => x[1]);
      
      const isPlaceholder = labels.length === 0;
      if (isPlaceholder) {
        labels = ['Purse Seine', 'Gillnet', 'Pancing', 'Jaring Insang', 'Bubu', 'Payang', 'Trammel Net', 'Rawai', 'Bagan', 'Sero'];
        values = [1500, 1200, 800, 600, 450, 400, 350, 300, 250, 200];
        updateDebugInfo('debug-alat-tangkap', document.getElementById('debug-alat-tangkap').textContent + `âŒ NO DATA - Placeholder`);
      } else {
        updateDebugInfo('debug-alat-tangkap', document.getElementById('debug-alat-tangkap').textContent + `âœ… ${labels.length} unique alat tangkap`);
      }
      
      charts.alatTangkap = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total GT',
            data: values,
            backgroundColor: isPlaceholder ? '#cccccc' : '#9966ff'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }

    // Chart SKKP
    function createSKKPChart(data) {
      const ctx = document.getElementById('chart-skkp').getContext('2d');
      if (charts.skkp) charts.skkp.destroy();
      
      if (data.length === 0) {
        const labels = ['Jan','Feb','Mar','Apr','Mei','Jun'];
        const values = [85,92,88,95,100,98];
        charts.skkp = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'SKKP Diterbitkan',
              data: values,
              backgroundColor: 'rgba(255, 182, 193, 0.5)',
              borderColor: '#ff6b9d',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
        updateDebugInfo('debug-skkp', 'âš ï¸ No data');
        return;
      }
      
      const headers = Object.keys(data[0]);
      const tanggalCol = findColumn(headers, ['tanggal', 'tgl', 'date']);
      const jumlahCol = findColumn(headers, ['skkp', 'jumlah', 'berat', 'kg']);
      
      const labels = [];
      const values = [];
      
      data.slice(0, 6).forEach(row => {
        if (tanggalCol && jumlahCol) {
          labels.push(row[tanggalCol] || '');
          values.push(Math.round(parseFloat(row[jumlahCol]) || 0));
        }
      });
      
      charts.skkp = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'SKKP Diterbitkan',
            data: values,
            backgroundColor: 'rgba(255, 182, 193, 0.5)',
            borderColor: '#ff6b9d',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
      
      updateDebugInfo('debug-skkp', `âœ… ${data.length} rows | Tanggal: ${tanggalCol} | Jumlah: ${jumlahCol}`);
    }

    // Fill Tabel Izin Habis
    function fillIzinHabisTable(data) {
      const tbody = document.querySelector('#table-izin-habis tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      data.slice(0, 10).forEach(row => {
        const headers = Object.keys(row);
        const namaKapal = findColumn(headers, ['nama kapal', 'kapal']) || 'nama';
        const nomorIzin = findColumn(headers, ['nomor izin', 'izin']) || 'nomor izin';
        const tanggalAkhir = findColumn(headers, ['tanggal akhir', 'akhir', 'expired']) || 'tanggal akhir';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row[namaKapal] || '-'}</td>
          <td>${row[nomorIzin] || '-'}</td>
          <td>${row[tanggalAkhir] || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Fill Tabel PKL
    function fillPKLTable(data) {
      const tbody = document.querySelector('#kb-table tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      data.forEach((row, idx) => {
        const headers = Object.keys(row);
        const nomorPKL = findColumn(headers, ['nomor pkl', 'nomor', 'no pkl']) || headers[0];
        const tanggalPKL = findColumn(headers, ['tanggal pkl', 'tanggal', 'tgl']) || headers[1];
        const namaKapal = findColumn(headers, ['nama kapal', 'kapal']) || headers[3];
        const gt = findColumn(headers, ['gt']) || headers[4];
        const namaPemilik = findColumn(headers, ['nama pemilik', 'pemilik']) || headers[5];
        const namaAwak = findColumn(headers, ['nama awak', 'awak']) || headers[6];
        const jabatan = findColumn(headers, ['jabatan']) || headers[7];
        const jenisPengupahan = findColumn(headers, ['jenis pengupahan', 'pengupahan', 'upah']) || headers[8];
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${row[nomorPKL] || '-'}</td>
          <td>${row[tanggalPKL] || '-'}</td>
          <td>${row[namaKapal] || '-'}</td>
          <td>${row[gt] || '-'}</td>
          <td>${row[namaPemilik] || '-'}</td>
          <td>${row[namaAwak] || '-'}</td>
          <td>${row[jabatan] || '-'}</td>
          <td>${row[jenisPengupahan] || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Load all data
    async function loadAllData(isAutoRefresh = false) {
      const loadingEl = document.getElementById('loading-indicator');
      const errorEl = document.getElementById('error-message');
      const successEl = document.getElementById('success-message');
      const btn = document.getElementById('btn-load-gsheets');
      
      if (!isAutoRefresh) {
        loadingEl.style.display = 'block';
        btn.disabled = true;
      }
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      try {
        console.log('ðŸ”„ Memulai fetch data...', new Date().toLocaleTimeString());
        
        const results = await Promise.allSettled([
          fetchSheetData(SHEETS.aktivitas),
          fetchSheetData(SHEETS.perizinan),
          fetchSheetData(SHEETS.alatTangkap),
          fetchSheetData(SHEETS.skkp),
          fetchSheetData(SHEETS.izinHabis),
          fetchSheetData(SHEETS.pkl),
          fetchSheetData(SHEETS.perizinanDetail)
        ]);
        
        const [aktivitas, perizinan, alatTangkap, skkp, izinHabis, pkl, perizinanDetail] = results.map((r) => {
          if (r.status === 'fulfilled' && r.value.length > 0) {
            return r.value;
          } else {
            return [];
          }
        });
        
        console.log('ðŸ“Š Data berhasil dimuat:');
        console.log(`  â€¢ Aktivitas: ${aktivitas.length} rows`);
        console.log(`  â€¢ Perizinan: ${perizinan.length} rows`);
        console.log(`  â€¢ Alat Tangkap: ${alatTangkap.length} rows`);
        console.log(`  â€¢ SKKP: ${skkp.length} rows`);
        console.log(`  â€¢ Izin Habis: ${izinHabis.length} rows`);
        console.log(`  â€¢ PKL: ${pkl.length} rows`);
        console.log(`  â€¢ Perizinan Detail: ${perizinanDetail.length} rows`);
        
        createAktivitasChart(aktivitas);
        createPerizinanChart(perizinan);
        createPerizinanDetailChart(perizinanDetail);
        createAlatTangkapChart(perizinan, izinHabis);
        createSKKPChart(skkp);
        fillIzinHabisTable(izinHabis);
        fillPKLTable(pkl);
        
        if (!isAutoRefresh) {
          loadingEl.style.display = 'none';
          successEl.textContent = 'âœ… Data berhasil dimuat dari Google Sheets!';
          successEl.style.display = 'block';
          
          setTimeout(() => {
            successEl.style.display = 'none';
          }, 3000);
        } else {
          console.log('ðŸ”„ Auto-refresh berhasil:', new Date().toLocaleTimeString());
        }
        
      } catch (error) {
        console.error('âŒ Error:', error);
        if (!isAutoRefresh) {
          loadingEl.style.display = 'none';
          errorEl.textContent = 'âŒ Gagal memuat data: ' + error.message;
          errorEl.style.display = 'block';
        }
      } finally {
        if (!isAutoRefresh) {
          btn.disabled = false;
        }
      }
    }

    // Toggle auto-refresh
    function toggleAutoRefresh() {
      const btn = document.getElementById('btn-toggle-auto');
      const statusEl = document.querySelector('.auto-refresh-status');
      const statusIndicator = document.querySelector('.status-indicator');
      const refreshText = document.getElementById('refresh-text');
      
      isAutoRefreshEnabled = !isAutoRefreshEnabled;
      
      if (isAutoRefreshEnabled) {
        btn.textContent = 'Auto-Refresh: ON';
        btn.style.background = '#007bff';
        statusEl.classList.remove('inactive');
        statusEl.classList.add('active');
        statusIndicator.classList.remove('inactive');
        refreshText.textContent = 'Auto-refresh setiap 30 detik';
        
        autoRefreshInterval = setInterval(() => {
          loadAllData(true);
        }, REFRESH_INTERVAL);
        
        console.log('âœ… Auto-refresh diaktifkan');
      } else {
        btn.textContent = 'Auto-Refresh: OFF';
        btn.style.background = '#6c757d';
        statusEl.classList.remove('active');
        statusEl.classList.add('inactive');
        statusIndicator.classList.add('inactive');
        refreshText.textContent = 'Auto-refresh dinonaktifkan';
        
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        
        console.log('âŒ Auto-refresh dinonaktifkan');
      }
    }

    // Event listeners
    document.getElementById('btn-load-gsheets').addEventListener('click', () => loadAllData(false));
    document.getElementById('btn-toggle-auto').addEventListener('click', toggleAutoRefresh);
    
    // Auto load on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        loadAllData(false);
        
        if (isAutoRefreshEnabled) {
          autoRefreshInterval = setInterval(() => {
            loadAllData(true);
          }, REFRESH_INTERVAL);
        }
      }, 500);
    });
    
    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
