<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kesyahbandaran 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: white;
      background: #0d5f8a;
      padding: 12px 24px;
      border-radius: 10px;
      margin: 0;
      display: inline-block;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .loading, .error {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
      position: relative;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d5f8a;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .kb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .kb-table thead {
      background: #0d5f8a;
      color: white;
      position: sticky;
      top: 0;
    }
    .kb-table th, .kb-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    .kb-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .kb-table tbody tr:hover {
      background: #e9ecef;
    }
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Kinerja Kesyahbandaran 2025</h2>
    </div>

    <div id="global-loading" class="loading" style="display:block;">Memuat data dari Google Sheets...</div>
    <div id="global-error" class="error" style="display:none;"></div>

    <!-- Grid Layout 3 kolom untuk baris pertama -->
    <div class="grid-3">
      <!-- Aktivitas Kapal -->
      <div class="chart-container">
        <div class="chart-title">Aktivitas Kapal</div>
        <canvas id="chart-aktivitas-kapal" style="max-height:220px;"></canvas>
      </div>

      <!-- Perizinan Kapal (Izin Daerah vs Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Perizinan Kapal (Daerah vs Pusat)</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-kapal"></canvas>
        </div>
      </div>

      <!-- Perizinan Kapal (Detail Izin Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Detail Perizinan Pusat</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-detail"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Layout 3 kolom untuk baris kedua -->
    <div class="grid-3">
      <!-- Top 10 Alat Tangkap -->
      <div class="chart-container">
        <div class="chart-title">Top 10 Alat Tangkap</div>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;">Sebaran GT Kapal</div>
        <canvas id="chart-alat-tangkap" style="max-height:280px;"></canvas>
      </div>

      <!-- Jumlah SKKP Diterbitkan -->
      <div class="chart-container">
        <div class="chart-title">Jumlah SKKP Diterbitkan</div>
        <canvas id="chart-skkp" style="max-height:280px;"></canvas>
      </div>

      <!-- Masa Berlaku Izin Akan Habis -->
      <div class="chart-container">
        <div class="chart-title">Masa Berlaku Izin Akan Habis</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table class="kb-table" id="table-izin-habis">
            <thead>
              <tr>
                <th>Nama Kapal</th>
                <th>Nomor Izin</th>
                <th>Tanggal Akhir</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center; color:#999;">Memuat...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tabel Detail PKL (Full width di bawah) -->
    <div class="chart-container" style="margin-top:16px;">
      <div class="chart-title">Tabel Data PKL</div>
      <div style="max-height:360px; overflow:auto;">
        <table class="kb-table" id="kb-table">
          <thead>
            <tr>
              <th>No.</th><th>NOMOR PKL</th><th>TANGGAL PKL</th><th>NAMA KAPAL</th><th>GT</th><th>NAMA PEMILIK</th><th>NAMA AWAK</th><th>JABATAN</th><th>JENIS PENGUPAHAN</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center; color:#999;">Memuat data PKL...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Konfigurasi Sheet ID dan GID
    const SHEET_ID = "1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254";
    const GIDS = {
      STBLKK: "1397215787",   // Aktivitas Kapal
      PERIZINAN_DAERAH: "583377591",
      PERIZINAN_PUSAT: "264793408",
      SHTI: "566117585",      // Alat Tangkap
      SKKP: "1309011826",
      PKL: "2099648587"
    };

    // Fungsi fetch data dari Google Sheets (format gviz)
    async function fetchSheetData(gid) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
      const response = await fetch(url);
      const text = await response.text();
      // Parse JSON dari respons Google
      const jsonStr = text.substring(47, text.length - 2);
      const data = JSON.parse(jsonStr);
      
      const headers = data.table.cols.map(col => col.label);
      const rows = data.table.rows.map(row => {
        const obj = {};
        row.c.forEach((cell, i) => {
          obj[headers[i]] = cell ? cell.v : '';
        });
        return obj;
      });
      return rows;
    }

    // Helper: cari kolom mirip
    function findValue(row, keywords) {
      for (let key in row) {
        if (keywords.some(kw => key.toLowerCase().includes(kw.toLowerCase()))) {
          return row[key];
        }
      }
      return '';
    }

    // Inisialisasi chart
    let charts = {};

    // === 1. Aktivitas Kapal (STBLKK) ===
    async function loadAktivitasKapal() {
      try {
        const data = await fetchSheetData(GIDS.STBLKK);
        const labels = [];
        const masuk = [];
        const keluar = [];

        data.forEach(row => {
          const bulan = findValue(row, ['bulan', 'month', 'periode']);
          labels.push(bulan || 'Bulan');
          masuk.push(parseInt(findValue(row, ['masuk', 'in', 'datang']) || 0));
          keluar.push(parseInt(findValue(row, ['keluar', 'out', 'berangkat']) || 0));
        });

        const ctx = document.getElementById('chart-aktivitas-kapal').getContext('2d');
        if (charts.aktivitas) charts.aktivitas.destroy();
        charts.aktivitas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels.length ? labels : ['Jan', 'Feb', 'Mar'],
            datasets: [
              { label: 'Kapal Masuk', data: masuk, backgroundColor: '#36a2eb' },
              { label: 'Kapal Keluar', data: keluar, backgroundColor: '#ff6384' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } catch (e) { console.error('Aktivitas Kapal error:', e); }
    }

    // === 2. Perizinan Daerah vs Pusat ===
    async function loadPerizinanKapal() {
      try {
        const daerahData = await fetchSheetData(GIDS.PERIZINAN_DAERAH);
        const pusatData = await fetchSheetData(GIDS.PERIZINAN_PUSAT);
        const daerahCount = daerahData.length;
        const pusatCount = pusatData.length;

        const ctx = document.getElementById('chart-perizinan-kapal').getContext('2d');
        if (charts.perizinan) charts.perizinan.destroy();
        charts.perizinan = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Izin Daerah', 'Izin Pusat'],
            datasets: [{
              data: [daerahCount, pusatCount],
              backgroundColor: ['#4bc0c0', '#ff9f40'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });
      } catch (e) { console.error('Perizinan error:', e); }
    }

    // === 3. Detail Perizinan Pusat ===
    async function loadPerizinanDetail() {
      try {
        const data = await fetchSheetData(GIDS.PERIZINAN_PUSAT);
        const jenisCount = {};
        data.forEach(row => {
          const jenis = findValue(row, ['jenis', 'kategori', 'type']) || 'Lainnya';
          jenisCount[jenis] = (jenisCount[jenis] || 0) + 1;
        });

        const labels = Object.keys(jenisCount);
        const values = Object.values(jenisCount);

        const ctx = document.getElementById('chart-perizinan-detail').getContext('2d');
        if (charts.perizinanDetail) charts.perizinanDetail.destroy();
        charts.perizinanDetail = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: { font: { size: 10 } }
              }
            }
          }
        });
      } catch (e) { console.error('Perizinan Detail error:', e); }
    }

    // === 4. Top 10 Alat Tangkap (SHTI) ===
    async function loadAlatTangkap() {
      try {
        const data = await fetchSheetData(GIDS.SHTI);
        const grouped = {};
        data.forEach(row => {
          const alat = findValue(row, ['alat', 'tangkap']);
          const gt = parseFloat(findValue(row, ['gt'])) || 0;
          if (alat && gt > 0) {
            grouped[alat] = (grouped[alat] || 0) + gt;
          }
        });

        const sorted = Object.entries(grouped)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const labels = sorted.map(x => x[0]);
        const values = sorted.map(x => x[1]);

        const ctx = document.getElementById('chart-alat-tangkap').getContext('2d');
        if (charts.alatTangkap) charts.alatTangkap.destroy();
        charts.alatTangkap = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'Total GT', data: values, backgroundColor: '#9966ff' }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        });
      } catch (e) { console.error('Alat Tangkap error:', e); }
    }

    // === 5. SKKP ===
    async function loadSKKP() {
      try {
        const data = await fetchSheetData(GIDS.SKKP);
        const labels = data.map(row => findValue(row, ['bulan', 'month']) || '');
        const values = data.map(row => parseInt(findValue(row, ['jumlah', 'total', 'skkp']) || 0));

        const ctx = document.getElementById('chart-skkp').getContext('2d');
        if (charts.skkp) charts.skkp.destroy();
        charts.skkp = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'SKKP Diterbitkan',
              data: values,
              borderColor: '#ff6384',
              backgroundColor: 'rgba(255,99,132,0.2)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } catch (e) { console.error('SKKP error:', e); }
    }

    // === 6. Tabel Izin Habis (dari PKL) ===
    async function loadIzinHabis() {
      try {
        const data = await fetchSheetData(GIDS.PKL);
        const tbody = document.querySelector('#table-izin-habis tbody');
        tbody.innerHTML = '';

        data.slice(0, 10).forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${findValue(row, ['nama kapal', 'kapal']) || '-'}</td>
            <td>${findValue(row, ['nomor izin', 'izin']) || '-'}</td>
            <td>${findValue(row, ['tanggal akhir', 'akhir', 'expired']) || '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) { console.error('Izin Habis error:', e); }
    }

    // === 7. Tabel PKL Lengkap ===
    async function loadPKLTable() {
      try {
        const data = await fetchSheetData(GIDS.PKL);
        const tbody = document.querySelector('#kb-table tbody');
        tbody.innerHTML = '';

        data.forEach((row, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${findValue(row, ['nomor pkl']) || '-'}</td>
            <td>${findValue(row, ['tanggal pkl']) || '-'}</td>
            <td>${findValue(row, ['nama kapal']) || '-'}</td>
            <td>${findValue(row, ['gt']) || '-'}</td>
            <td>${findValue(row, ['nama pemilik']) || '-'}</td>
            <td>${findValue(row, ['nama awak']) || '-'}</td>
            <td>${findValue(row, ['jabatan']) || '-'}</td>
            <td>${findValue(row, ['jenis pengupahan']) || '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) { console.error('PKL Table error:', e); }
    }

    // === Muat Semua Data ===
    async function loadAllData() {
      const loadingEl = document.getElementById('global-loading');
      const errorEl = document.getElementById('global-error');

      try {
        await Promise.allSettled([
          loadAktivitasKapal(),
          loadPerizinanKapal(),
          loadPerizinanDetail(),
          loadAlatTangkap(),
          loadSKKP(),
          loadIzinHabis(),
          loadPKLTable()
        ]);
        loadingEl.style.display = 'none';
      } catch (err) {
        errorEl.textContent = 'Gagal memuat data: ' + err.message;
        errorEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    // Jalankan saat halaman dimuat
    window.addEventListener('load', loadAllData);
  </script>
</body>
</html>
