<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kesyahbandaran 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: white;
      background: #0d5f8a;
      padding: 12px 24px;
      border-radius: 10px;
      margin: 0;
      display: inline-block;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .kb-controls button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .kb-controls button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40,167,69,0.4);
    }
    .kb-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .loading, .error {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d5f8a;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .kb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .kb-table thead {
      background: #0d5f8a;
      color: white;
      position: sticky;
      top: 0;
    }
    .kb-table th, .kb-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    .kb-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .kb-table tbody tr:hover {
      background: #e9ecef;
    }
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Kinerja Kesyahbandaran 2025</h2>
      <div class="kb-controls">
        <button id="btn-load-gsheets">Muat Data dari Google Sheets</button>
      </div>
    </div>

    <div id="loading-indicator" class="loading" style="display:none;">Memuat data dari Google Sheets...</div>
    <div id="error-message" class="error" style="display:none;"></div>
    <div id="success-message" class="success" style="display:none;"></div>
    <div id="debug-info" style="display:none; background:#f0f0f0; padding:15px; border-radius:8px; margin:15px 0; font-size:12px; max-height:200px; overflow:auto;"></div>

    <!-- Grid Layout 3 kolom untuk baris pertama -->
    <div class="grid-3">
      <!-- Aktivitas Kapal -->
      <div class="chart-container">
        <div class="chart-title">Aktivitas Kapal</div>
        <canvas id="chart-aktivitas-kapal" style="max-height:220px;"></canvas>
      </div>

      <!-- Perizinan Kapal (Izin Daerah vs Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Perizinan Kapal (Daerah vs Pusat)</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-kapal"></canvas>
        </div>
      </div>

      <!-- Perizinan Kapal (Detail Izin Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Detail Perizinan Pusat</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-detail"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Layout 3 kolom untuk baris kedua -->
    <div class="grid-3">
      <!-- Top 10 Alat Tangkap -->
      <div class="chart-container">
        <div class="chart-title">Top 10 Alat Tangkap</div>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;">Sebaran GT Kapal</div>
        <canvas id="chart-alat-tangkap" style="max-height:280px;"></canvas>
      </div>

      <!-- Jumlah SKKP Diterbitkan -->
      <div class="chart-container">
        <div class="chart-title">Jumlah SKKP Diterbitkan</div>
        <canvas id="chart-skkp" style="max-height:280px;"></canvas>
      </div>

      <!-- Masa Berlaku Izin Akan Habis -->
      <div class="chart-container">
        <div class="chart-title">Masa Berlaku Izin Akan Habis</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table class="kb-table" id="table-izin-habis">
            <thead>
              <tr>
                <th>Nama Kapal</th>
                <th>Nomor Izin</th>
                <th>Tanggal Akhir</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center; color:#999;">Belum ada data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tabel Detail PKL (Full width di bawah) -->
    <div class="chart-container" style="margin-top:16px;">
      <div class="chart-title">Tabel Data PKL</div>
      <div style="max-height:360px; overflow:auto;">
        <table class="kb-table" id="kb-table">
          <thead>
            <tr>
              <th>No.</th><th>NOMOR PKL</th><th>TANGGAL PKL</th><th>NAMA KAPAL</th><th>GT</th><th>NAMA PEMILIK</th><th>NAMA AWAK</th><th>JABATAN</th><th>JENIS PENGUPAHAN</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center; color:#999;">Belum ada data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ✅ MAPPING GID YANG BENAR
    const SPREADSHEET_ID = '1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254';
    const SHEETS = {
      aktivitas: '1397215787',     // STBLKK → Aktivitas Kapal
      perizinanDaerah: '583377591', // Perizinan Kapal (Daerah)
      perizinanPusat: '264793408',  // Perizinan Kapal (Pusat)
      alatTangkap: '566117585',     // SHTI → Top 10 Alat Tangkap
      skkp: '1309011826',           // SKKP → Jumlah SKKP Diterbitkan
      pkl: '2099648587'             // PKL → Masa Berlaku Izin & Tabel PKL
    };

    let charts = {};

    // Fungsi untuk mengambil data dari Google Sheets via gviz
    async function fetchSheetData(gid) {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
        const response = await fetch(url);
        const text = await response.text();
        
        // Parse JSON dari respons Google
        const jsonStr = text.substring(47, text.length - 2);
        const data = JSON.parse(jsonStr);
        
        // Ekstrak header dan data
        const headers = data.table.cols.map(col => col.label);
        const rows = data.table.rows.map(row => {
          const obj = {};
          row.c.forEach((cell, i) => {
            obj[headers[i]] = cell ? cell.v : '';
          });
          return obj;
        });
        
        console.log(`Data dari GID ${gid}:`, rows.slice(0, 2));
        return rows;
      } catch (error) {
        console.error(`Error fetching GID ${gid}:`, error);
        return [];
      }
    }

    // === 1. Aktivitas Kapal (STBLKK) ===
    function createAktivitasChart(data) {
      const ctx = document.getElementById('chart-aktivitas-kapal').getContext('2d');
      if (charts.aktivitas) charts.aktivitas.destroy();
      
      // Gunakan nama kolom eksplisit berdasarkan screenshot
      const labels = [];
      const masuk = [];
      const keluar = [];
      
      data.forEach(row => {
        // Coba ambil dari kolom yang mungkin ada
        const bulan = row['Bulan'] || row['bulan'] || row['Month'] || row['month'] || 'Bulan';
        const masukVal = parseInt(row['Kapal Masuk'] || row['masuk'] || row['In'] || 0);
        const keluarVal = parseInt(row['Kapal Keluar'] || row['keluar'] || row['Out'] || 0);
        
        labels.push(bulan);
        masuk.push(masukVal);
        keluar.push(keluarVal);
      });
      
      // Jika tidak ada data, gunakan dummy
      if (labels.length === 0) {
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
        masuk = [45, 52, 48, 55, 60, 58];
        keluar = [42, 50, 46, 53, 58, 56];
      }
      
      charts.aktivitas = new Chart(ctx, {
        type: 'bar',
         {
          labels: labels,
          datasets: [
            { label: 'Kapal Masuk',  masuk, backgroundColor: '#36a2eb' },
            { label: 'Kapal Keluar',  keluar, backgroundColor: '#ff6384' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // === 2. Perizinan Kapal (Daerah vs Pusat) ===
    function createPerizinanChart(daerahData, pusatData) {
      const ctx = document.getElementById('chart-perizinan-kapal').getContext('2d');
      if (charts.perizinan) charts.perizinan.destroy();
      
      const daerahCount = daerahData.length;
      const pusatCount = pusatData.length;
      
      charts.perizinan = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Izin Daerah', 'Izin Pusat'],
          datasets: [{
             [daerahCount, pusatCount],
            backgroundColor: ['#4bc0c0', '#ff9f40'],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    // === 3. Detail Perizinan Pusat ===
    function createPerizinanDetailChart(data) {
      const ctx = document.getElementById('chart-perizinan-detail').getContext('2d');
      if (charts.perizinanDetail) charts.perizinanDetail.destroy();
      
      // Ambil jenis izin dari kolom pertama atau kolom spesifik
      const jenisCount = {};
      data.forEach(row => {
        // Coba cari kolom "Jenis Izin", "Nama Kapal", atau kolom pertama
        let jenis = row['Jenis Izin'] || row['Nama Kapal'] || Object.values(row)[0] || 'Lainnya';
        if (!jenis || jenis.trim() === '') jenis = 'Lainnya';
        jenisCount[jenis] = (jenisCount[jenis] || 0) + 1;
      });
      
      // Ambil 5 kategori teratas
      const sorted = Object.entries(jenisCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      const labels = sorted.map(x => x[0]);
      const values = sorted.map(x => x[1]);
      
      // Warna
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];
      
      charts.perizinanDetail = new Chart(ctx, {
        type: 'doughnut',
         {
          labels: labels,
          datasets: [{
             values,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { font: { size: 10 } }
            }
          }
        }
      });
    }

    // === 4. Top 10 Alat Tangkap (SHTI) ===
    function createAlatTangkapChart(data) {
      const ctx = document.getElementById('chart-alat-tangkap').getContext('2d');
      if (charts.alatTangkap) charts.alatTangkap.destroy();
      
      const grouped = {};
      
      data.forEach(row => {
        // Coba ambil nama alat tangkap dari kolom pertama atau "Alat Tangkap"
        const alat = row['Alat Tangkap'] || row['alat'] || Object.values(row)[0] || '';
        // Coba ambil GT dari kolom "GT" atau "GT Kapal"
        const gtStr = row['GT'] || row['GT Kapal'] || Object.values(row)[1] || '0';
        const gt = parseFloat(gtStr) || 0;
        
        if (alat && gt > 0) {
          grouped[alat] = (grouped[alat] || 0) + gt;
        }
      });
      
      // Urutkan dan ambil 10 teratas
      const sorted = Object.entries(grouped)
        .filter(([k, v]) => v > 0 && k.trim() !== '')
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      const labels = sorted.map(x => x[0]);
      const values = sorted.map(x => x[1]);
      
      // Gunakan data dummy jika tidak ada data
      if (labels.length === 0) {
        labels = ['Purse Seine', 'Gillnet', 'Pancing', 'Jaring Insang', 'Bubu'];
        values = [1500, 1200, 800, 600, 450];
      }
      
      charts.alatTangkap = new Chart(ctx, {
        type: 'bar',
         {
          labels: labels,
          datasets: [{
            label: 'Total GT',
            data: values,
            backgroundColor: '#9966ff'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { beginAtZero: true } }
        }
      });
    }

    // === 5. Jumlah SKKP Diterbitkan ===
    function createSKKPChart(data) {
      const ctx = document.getElementById('chart-skkp').getContext('2d');
      if (charts.skkp) charts.skkp.destroy();
      
      const labels = [];
      const values = [];
      
      data.forEach(row => {
        // Coba ambil bulan dari kolom "Bulan" atau "Month"
        const bulan = row['Bulan'] || row['Month'] || row['bulan'] || 'Bulan';
        // Coba ambil jumlah dari kolom "Jumlah", "Total", "SKKP"
        const jumlah = parseInt(row['Jumlah'] || row['Total'] || row['SKKP'] || 0);
        
        labels.push(bulan);
        values.push(jumlah);
      });
      
      // Gunakan data dummy jika tidak ada data
      if (labels.length === 0) {
        labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
        values = [85, 92, 88, 95, 100, 98];
      }
      
      charts.skkp = new Chart(ctx, {
        type: 'line',
         {
          labels: labels,
          datasets: [{
            label: 'SKKP Diterbitkan',
             values,
            borderColor: '#ff6384',
            backgroundColor: 'rgba(255,99,132,0.2)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // === 6. Tabel Izin Habis (dari PKL) ===
    function fillIzinHabisTable(data) {
      const tbody = document.querySelector('#table-izin-habis tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      // Ambil 10 data pertama
      data.slice(0, 10).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row['NAMA KAPAL'] || row['Nama Kapal'] || '-'}</td>
          <td>${row['NOMOR IZIN'] || row['Nomor Izin'] || '-'}</td>
          <td>${row['TANGGAL AKHIR'] || row['Tanggal Akhir'] || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === 7. Tabel PKL Lengkap ===
    function fillPKLTable(data) {
      const tbody = document.querySelector('#kb-table tbody');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">Tidak ada data</td></tr>';
        return;
      }
      
      data.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${row['NOMOR PKL'] || row['Nomor PKL'] || '-'}</td>
          <td>${row['TANGGAL PKL'] || row['Tanggal PKL'] || '-'}</td>
          <td>${row['NAMA KAPAL'] || row['Nama Kapal'] || '-'}</td>
          <td>${row['GT'] || '-'}</td>
          <td>${row['NAMA PEMILIK'] || row['Nama Pemilik'] || '-'}</td>
          <td>${row['NAMA AWAK'] || row['Nama Awak'] || '-'}</td>
          <td>${row['JABATAN'] || row['Jabatan'] || '-'}</td>
          <td>${row['JENIS PENGUPAHAN'] || row['Jenis Pengupahan'] || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === Muat Semua Data ===
    async function loadAllData() {
      const loadingEl = document.getElementById('loading-indicator');
      const errorEl = document.getElementById('error-message');
      const successEl = document.getElementById('success-message');
      const debugEl = document.getElementById('debug-info');
      const btn = document.getElementById('btn-load-gsheets');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      debugEl.style.display = 'none';
      btn.disabled = true;
      
      let debugInfo = '<strong>DEBUG - Struktur Data yang Terdeteksi:</strong><br><br>';
      
      try {
        // Fetch semua data secara paralel
        const [
          aktivitasData,
          perizinanDaerahData,
          perizinanPusatData,
          alatTangkapData,
          skkpData,
          pklData
        ] = await Promise.all([
          fetchSheetData(SHEETS.aktivitas),
          fetchSheetData(SHEETS.perizinanDaerah),
          fetchSheetData(SHEETS.perizinanPusat),
          fetchSheetData(SHEETS.alatTangkap),
          fetchSheetData(SHEETS.skkp),
          fetchSheetData(SHEETS.pkl)
        ]);
        
        // Debug info
        const sheetsInfo = [
          { name: 'Aktivitas Kapal', data: aktivitasData },
          { name: 'Perizinan Daerah', data: perizinanDaerahData },
          { name: 'Perizinan Pusat', data: perizinanPusatData },
          { name: 'Alat Tangkap', data: alatTangkapData },
          { name: 'SKKP', data: skkpData },
          { name: 'PKL', data: pklData }
        ];
        
        sheetsInfo.forEach(sheet => {
          if (sheet.data.length > 0) {
            const headers = Object.keys(sheet.data[0]);
            debugInfo += `<strong>${sheet.name}:</strong> ${headers.join(', ')}<br>`;
            debugInfo += `Sample: ${JSON.stringify(sheet.data[0])}<br><br>`;
          } else {
            debugInfo += `<strong>${sheet.name}:</strong> <span style="color:red;">Tidak ada data</span><br><br>`;
          }
        });
        
        debugEl.innerHTML = debugInfo;
        debugEl.style.display = 'block';
        
        // Render semua komponen
        createAktivitasChart(aktivitasData);
        createPerizinanChart(perizinanDaerahData, perizinanPusatData);
        createPerizinanDetailChart(perizinanPusatData);
        createAlatTangkapChart(alatTangkapData);
        createSKKPChart(skkpData);
        fillIzinHabisTable(pklData);
        fillPKLTable(pklData);
        
        loadingEl.style.display = 'none';
        successEl.textContent = `Data berhasil dimuat! Total: Aktivitas(${aktivitasData.length}), Perizinan Daerah(${perizinanDaerahData.length}), Pusat(${perizinanPusatData.length}), Alat Tangkap(${alatTangkapData.length}), SKKP(${skkpData.length}), PKL(${pklData.length})`;
        successEl.style.display = 'block';
        
        setTimeout(() => successEl.style.display = 'none', 5000);
        
      } catch (error) {
        console.error('Error:', error);
        loadingEl.style.display = 'none';
        errorEl.textContent = 'Gagal memuat  ' + (error.message || 'Kesalahan tidak dikenal');
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    }

    // Event listener
    document.getElementById('btn-load-gsheets').addEventListener('click', loadAllData);
    
    // Muat otomatis saat halaman dibuka
    window.addEventListener('load', () => setTimeout(loadAllData, 500));
  </script>
</body>
</html>
