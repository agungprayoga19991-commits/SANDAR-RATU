<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Kesyahbandaran 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: white;
      background: #0d5f8a;
      padding: 12px 24px;
      border-radius: 10px;
      margin: 0;
      display: inline-block;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .kb-controls button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .kb-controls button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40,167,69,0.4);
    }
    .kb-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .loading, .error {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
    }
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 2px solid #0d5f8a;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .kb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .kb-table thead {
      background: #0d5f8a;
      color: white;
      position: sticky;
      top: 0;
    }
    .kb-table th, .kb-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ddd;
    }
    .kb-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .kb-table tbody tr:hover {
      background: #e9ecef;
    }
    @media (max-width: 1200px) {
      .grid-3 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Kinerja Kesyahbandaran 2025</h2>
      <div class="kb-controls">
        <button id="btn-load-gsheets">Muat Data dari Google Sheets</button>
      </div>
    </div>

    <div id="loading-indicator" class="loading" style="display:none;">Memuat data dari Google Sheets...</div>
    <div id="error-message" class="error" style="display:none;"></div>
    <div id="success-message" class="success" style="display:none;"></div>

    <!-- Grid Layout 3 kolom untuk baris pertama -->
    <div class="grid-3">
      <!-- Aktivitas Kapal -->
      <div class="chart-container">
        <div class="chart-title">Aktivitas Kapal</div>
        <canvas id="chart-aktivitas-kapal" style="max-height:220px;"></canvas>
      </div>

      <!-- Perizinan Kapal (Izin Daerah vs Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Perizinan Kapal (Daerah vs Pusat)</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-kapal"></canvas>
        </div>
      </div>

      <!-- Perizinan Kapal (Detail Izin Pusat) -->
      <div class="chart-container">
        <div class="chart-title">Detail Perizinan Pusat</div>
        <div style="position:relative; width:200px; height:200px; margin:0 auto;">
          <canvas id="chart-perizinan-detail"></canvas>
        </div>
      </div>
    </div>

    <!-- Grid Layout 3 kolom untuk baris kedua -->
    <div class="grid-3">
      <!-- Top 10 Alat Tangkap -->
      <div class="chart-container">
        <div class="chart-title">Top 10 Alat Tangkap</div>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:8px;">Sebaran GT Kapal</div>
        <canvas id="chart-alat-tangkap" style="max-height:280px;"></canvas>
      </div>

      <!-- Jumlah SKKP Diterbitkan -->
      <div class="chart-container">
        <div class="chart-title">Jumlah SKKP Diterbitkan</div>
        <canvas id="chart-skkp" style="max-height:280px;"></canvas>
      </div>

      <!-- Masa Berlaku Izin Akan Habis -->
      <div class="chart-container">
        <div class="chart-title">Masa Berlaku Izin Akan Habis</div>
        <div style="max-height:280px; overflow-y:auto;">
          <table class="kb-table" id="table-izin-habis">
            <thead>
              <tr>
                <th>Nama Kapal</th>
                <th>Nomor Izin</th>
                <th>Tanggal Akhir</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3" style="text-align:center; color:#999;">Belum ada data</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tabel Detail PKL (Full width di bawah) -->
    <div class="chart-container" style="margin-top:16px;">
      <div class="chart-title">Tabel Data PKL</div>
      <div style="max-height:360px; overflow:auto;">
        <table class="kb-table" id="kb-table">
          <thead>
            <tr>
              <th>No.</th><th>NOMOR PKL</th><th>TANGGAL PKL</th><th>NAMA KAPAL</th><th>GT</th><th>NAMA PEMILIK</th><th>NAMA AWAK</th><th>JABATAN</th><th>JENIS PENGUPAHAN</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align:center; color:#999;">Belum ada data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = '1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254';
    const SHEETS = {
      aktivitas: '1397215787',
      perizinan: '698992828',
      alatTangkap: '1309011826',
      skkp: '566117585',
      izinHabis: '583377591',
      pkl: '264793408',
      perizinanDetail: '2099648587'
    };

    let charts = {};

    // Fungsi untuk mengambil data dari Google Sheets
    async function fetchSheetData(gid) {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csv = await response.text();
        return parseCSV(csv);
      } catch (error) {
        console.error(`Error fetching GID ${gid}:`, error);
        throw error;
      }
    }

    // Parse CSV yang lebih robust
    function parseCSV(csv) {
      const lines = csv.trim().split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      // Parse header
      const headers = parseCSVLine(lines[0]);
      const data = [];
      
      // Parse data rows
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length > 0) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          data.push(row);
        }
      }
      
      return data;
    }

    // Parse single CSV line (handle quotes)
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      return result;
    }

    // Fungsi untuk membuat chart Aktivitas Kapal
    function createAktivitasChart(data) {
      const ctx = document.getElementById('chart-aktivitas-kapal').getContext('2d');
      
      if (charts.aktivitas) {
        charts.aktivitas.destroy();
      }
      
      if (data.length === 0) {
        // Jika tidak ada data, gunakan data dummy
        charts.aktivitas = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
            datasets: [
              {
                label: 'Kapal Masuk',
                data: [45, 52, 48, 55, 60, 58],
                backgroundColor: '#36a2eb',
                borderColor: '#2589d6',
                borderWidth: 1
              },
              {
                label: 'Kapal Keluar',
                data: [42, 50, 46, 53, 58, 56],
                backgroundColor: '#ff6384',
                borderColor: '#e5506e',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
        return;
      }
      
      // Cari kolom yang tepat (case insensitive dan flexible
