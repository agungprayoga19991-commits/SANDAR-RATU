<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Grafik Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chart-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chart-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .chart-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .instructions {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .instructions ol {
            margin-left: 20px;
            color: #666;
            line-height: 2;
            font-size: 1.05em;
        }

        .instructions code {
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #667eea;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }

        .data-table {
            width: 100%;
            margin-top: 20px;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Dashboard Grafik Data</h1>
            <p class="subtitle">Visualisasi Data STBLKK, SPB, SKKP, SHTI, Perizinan & PKL</p>
            <button class="refresh-btn" onclick="loadAllData()">ðŸ”„ Refresh Data</button>
        </header>

        <div class="instructions">
            <h3>ðŸ“‹ Cara Menggunakan Dashboard ini dengan Google Sheets:</h3>
            <ol>
                <li>Buka Google Sheets Anda</li>
                <li>Klik <strong>File</strong> â†’ <strong>Share</strong> â†’ <strong>Publish to web</strong></li>
                <li>Pilih sheet yang ingin dipublikasikan (contoh: STBLKK)</li>
                <li>Pilih format: <code>Comma-separated values (.csv)</code></li>
                <li>Klik <strong>Publish</strong> dan copy URL yang diberikan</li>
                <li>Paste URL tersebut di bagian script (lihat kode di bawah pada bagian <code>sheetUrls</code>)</li>
                <li>Ulangi untuk setiap sheet lainnya</li>
            </ol>
            <p style="margin-top: 15px; color: #999; font-size: 0.95em;">
                ðŸ’¡ <strong>Catatan:</strong> Saat ini menggunakan data contoh. Ganti URL di script dengan URL published CSV dari Google Sheets Anda.
            </p>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Memuat data dari Google Sheets...</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showChart('stblkk')">STBLKK</button>
            <button class="tab" onclick="showChart('spb')">SPB</button>
            <button class="tab" onclick="showChart('skkp')">SKKP</button>
            <button class="tab" onclick="showChart('shti')">SHTI</button>
            <button class="tab" onclick="showChart('perizinan')">Perizinan</button>
            <button class="tab" onclick="showChart('pkl')">PKL</button>
        </div>

        <div id="stblkk" class="chart-container active">
            <h2 class="chart-title">Data STBLKK (Surat Tanda Bukti Lapor Ketenagakerjaan)</h2>
            <div class="chart-wrapper">
                <canvas id="chartSTBLKK"></canvas>
            </div>
            <div class="stats-grid" id="statsSTBLKK"></div>
            <div class="data-table" id="tableSTBLKK"></div>
        </div>

        <div id="spb" class="chart-container">
            <h2 class="chart-title">Data SPB (Surat Pemberitahuan)</h2>
            <div class="chart-wrapper">
                <canvas id="chartSPB"></canvas>
            </div>
            <div class="stats-grid" id="statsSPB"></div>
            <div class="data-table" id="tableSPB"></div>
        </div>

        <div id="skkp" class="chart-container">
            <h2 class="chart-title">Data SKKP</h2>
            <div class="chart-wrapper">
                <canvas id="chartSKKP"></canvas>
            </div>
            <div class="stats-grid" id="statsSKKP"></div>
            <div class="data-table" id="tableSKKP"></div>
        </div>

        <div id="shti" class="chart-container">
            <h2 class="chart-title">Data SHTI</h2>
            <div class="chart-wrapper">
                <canvas id="chartSHTI"></canvas>
            </div>
            <div class="stats-grid" id="statsSHTI"></div>
            <div class="data-table" id="tableSHTI"></div>
        </div>

        <div id="perizinan" class="chart-container">
            <h2 class="chart-title">Data Perizinan Pusat dan Daerah</h2>
            <div class="chart-wrapper">
                <canvas id="chartPerizinan"></canvas>
            </div>
            <div class="stats-grid" id="statsPerizinan"></div>
            <div class="data-table" id="tablePerizinan"></div>
        </div>

        <div id="pkl" class="chart-container">
            <h2 class="chart-title">Data PKL (Praktik Kerja Lapangan)</h2>
            <div class="chart-wrapper">
                <canvas id="chartPKL"></canvas>
            </div>
            <div class="stats-grid" id="statsPKL"></div>
            <div class="data-table" id="tablePKL"></div>
        </div>
    </div>

    <script>
        // KONFIGURASI URL GOOGLE SHEETS
        // Ganti URL di bawah dengan URL published CSV dari Google Sheets Anda
        const sheetUrls = {
            stblkk: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=1397215787',
            spb: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=698992828',
            skkp: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=1309011826',
            shti: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=566117585',
            perizinan: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=583377591',
            pkl: 'https://docs.google.com/spreadsheets/d/1eqJs6dkRA_kKwDzpWxLlZ83lNh1qhi5zA19gw9c6254/export?format=csv&gid=2099648587'
        };

        let charts = {};
        let dataStore = {};

        // Fungsi untuk load data dari Google Sheets
        function loadDataFromSheet(sheetName, url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log(`Data loaded for ${sheetName}:`, results.data);
                        dataStore[sheetName] = results.data;
                        resolve(results.data);
                    },
                    error: function(error) {
                        console.error(`Error loading ${sheetName}:`, error);
                        reject(error);
                    }
                });
            });
        }

        // Fungsi untuk membuat chart
        function createChart(canvasId, data, sheetName) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Destroy existing chart if exists
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            // Analisis data untuk menentukan tipe chart yang sesuai
            const headers = Object.keys(data[0] || {});
            console.log(`Headers for ${sheetName}:`, headers);

            // Ambil 10 data pertama untuk chart
            const limitedData = data.slice(0, 10);
            
            // Cari kolom yang berisi label (biasanya kolom pertama atau kolom dengan nama/tanggal)
            const labelColumn = headers[0];
            const labels = limitedData.map(row => row[labelColumn] || 'N/A');

            // Cari kolom numerik
            const numericColumns = headers.filter(header => {
                const value = data[0][header];
                return !isNaN(value) && value !== '';
            });

            let datasets = [];
            const colors = [
                '#667eea',
                '#764ba2',
                '#f093fb',
                '#4facfe',
                '#43e97b',
                '#fa709a'
            ];

            // Buat dataset untuk setiap kolom numerik
            numericColumns.slice(0, 3).forEach((column, index) => {
                datasets.push({
                    label: column,
                    data: limitedData.map(row => parseFloat(row[column]) || 0),
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '33',
                    tension: 0.4,
                    fill: true
                });
            });

            // Jika tidak ada data numerik, gunakan count
            if (datasets.length === 0) {
                datasets = [{
                    label: 'Jumlah Data',
                    data: limitedData.map((_, index) => index + 1),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    tension: 0.4,
                    fill: true
                }];
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fungsi untuk membuat tabel
        function createTable(containerId, data, limit = 10) {
            if (!data || data.length === 0) {
                document.getElementById(containerId).innerHTML = '<p>Tidak ada data untuk ditampilkan</p>';
                return;
            }

            const headers = Object.keys(data[0]);
            const limitedData = data.slice(0, limit);

            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            limitedData.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    tableHTML += `<td>${row[header] || '-'}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            document.getElementById(containerId).innerHTML = tableHTML;
        }

        // Fungsi untuk membuat statistik
        function createStats(containerId, data) {
            if (!data || data.length === 0) {
                document.getElementById(containerId).innerHTML = '';
                return;
            }

            const totalData = data.length;
            const headers = Object.keys(data[0]);
            
            // Cari kolom numerik untuk statistik
            const numericColumns = headers.filter(header => {
                const value = data[0][header];
                return !isNaN(value) && value !== '';
            });

            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Data</div>
                    <div class="stat-number">${totalData}</div>
                </div>
            `;

            // Tambahkan statistik untuk kolom numerik pertama jika ada
            if (numericColumns.length > 0) {
                const column = numericColumns[0];
                const values = data.map(row => parseFloat(row[column]) || 0);
                const sum = values.reduce((a, b) => a + b, 0);
                const avg = (sum / values.length).toFixed(2);
                const max = Math.max(...values);

                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-label">Total ${column}</div>
                        <div class="stat-number">${sum.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rata-rata ${column}</div>
                        <div class="stat-number">${avg}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Maksimum ${column}</div>
                        <div class="stat-number">${max}</div>
                    </div>
                `;
            }

            document.getElementById(containerId).innerHTML = statsHTML;
        }

        // Fungsi untuk load semua data
        async function loadAllData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            try {
                // Load data untuk setiap sheet
                for (const [key, url] of Object.entries(sheetUrls)) {
                    try {
                        const data = await loadDataFromSheet(key, url);
                        
                        // Update chart
                        const chartId = 'chart' + key.toUpperCase().replace('_', '');
                        createChart(chartId, data, key);
                        
                        // Update stats
                        const statsId = 'stats' + key.toUpperCase().replace('_', '');
                        createStats(statsId, data);
                        
                        // Update table
                        const tableId = 'table' + key.toUpperCase().replace('_', '');
                        createTable(tableId, data);
                        
                    } catch (error) {
                        console.error(`Failed to load ${key}:`, error);
                        const containerId = key.charAt(0).toUpperCase() + key.slice(1);
                        document.getElementById('stats' + key.toUpperCase()).innerHTML = 
                            `<div class="error-message">Gagal memuat data. Pastikan sheet sudah dipublikasikan sebagai CSV.</div>`;
                    }
                }
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Fungsi untuk menampilkan chart
        function showChart(chartId) {
            document.querySelectorAll('.chart-container').forEach(container => {
                container.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(chartId).classList.add('active');
            event.target.classList.add('active');
        }

        // Load data saat halaman dimuat
        window.addEventListener('load', function() {
            loadAllData();
        });
    </script>
</body>
</html>
