<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SANDAR-RATU - Sistem Administrasi & Dokumen Kesyahbandaran</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#f8f9fa;min-height:100vh;display:flex;justify-content:center;align-items:center;}

/* Login Styles */
.login-container{
  background:#fff;
  border-radius:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.1);
  max-width:400px;
  width:100%;
  overflow:hidden;
}

.logo-section{
  text-align:center;
  padding:40px 30px 20px;
  background:linear-gradient(135deg, #ffd700, #ffed4e);
}

.logo{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  font-size:24px;
  font-weight:700;
  color:#333;
  text-decoration:none;
}

.logo-icon{
  width:32px;
  height:32px;
  background:#333;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ffd700;
}

.warning-section{
  background:#fff3cd;
  border:1px solid #ffeaa7;
  margin:20px;
  border-radius:12px;
  padding:20px;
  text-align:center;
}

.warning-title{
  background:#ffd700;
  color:#333;
  padding:8px 16px;
  border-radius:8px;
  font-weight:600;
  margin-bottom:15px;
  display:inline-block;
}

.warning-text{
  color:#856404;
  font-size:14px;
  line-height:1.5;
  margin-bottom:15px;
}

.login-method-section{
  padding:20px;
  text-align:center;
}

.method-title{
  color:#6c757d;
  font-size:13px;
  margin-bottom:15px;
  font-style:italic;
}

.google-login-btn{
  width:100%;
  padding:12px 20px;
  border:2px solid #e0e0e0;
  background:#fff;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  font-size:14px;
  font-weight:500;
  color:#5f6368;
  cursor:pointer;
  transition:all 0.2s ease;
}

.google-login-btn:hover{
  border-color:#1a73e8;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
}

.google-login-btn:disabled{
  background:#f5f5f5;
  cursor:not-allowed;
  opacity:0.6;
}

.google-icon{
  width:18px;
  height:18px;
}

.loading-spinner{
  width:16px;
  height:16px;
  border:2px solid #f3f3f3;
  border-top:2px solid #1a73e8;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

.simple-login-btn{
  width:100%;
  padding:12px 20px;
  background:#2ecc71;
  border:none;
  color:white;
  border-radius:8px;
  font-size:14px;
  font-weight:500;
  cursor:pointer;
  transition:all 0.2s ease;
  margin-bottom:10px;
}

.simple-login-btn:hover{
  background:#27ae60;
}

/* Dashboard Styles */
.dashboard{display:none;flex-direction:column;height:100vh;width:100%;}
.header{background:#2c3e50;color:white;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
.header .logo-icon{background:#3498db;width:36px;height:36px;border-radius:8px;display:flex;justify-content:center;align-items:center;margin-right:10px;}
.header .user-info{display:flex;align-items:center;gap:10px;}
.header .user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid #3498db;}
.main-container{display:flex;flex:1;}
.sidebar{width:240px;background:#3498db;color:white;padding-top:20px;}
.sidebar div{padding:8px 20px;font-weight:600;opacity:0.8;font-size:13px;}
.sidebar a{display:flex;align-items:center;padding:12px 20px;color:white;text-decoration:none;transition:0.3s;cursor:pointer;}
.sidebar a:hover{background:rgba(255,255,255,0.1);}
.sidebar a.active{background:rgba(0,0,0,0.25);font-weight:bold;}
.content{flex:1;padding:25px;overflow-y:auto;background:#f5f5f5;}
.content h2{margin-bottom:20px;color:#2c3e50;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.form-row{display:flex;gap:15px;margin-bottom:15px;}
.form-row .form-control{flex:1;}
.form-control{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;}
.btn-generate{width:100%;padding:12px;background:#2ecc71;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-generate:hover{background:#27ae60;}
.btn-upload-drive{width:100%;padding:12px;background:#1a73e8;border:none;color:white;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:10px;}
.btn-upload-drive:hover{background:#1557b0;}
.btn-upload-drive:disabled{background:#ccc;cursor:not-allowed;}
.btn-logout{background:#e74c3c;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
.result-container{margin-top:15px;}
.preview-container{margin-top:8px;padding:15px;background:#fafafa;border:1px solid #ddd;border-radius:6px;display:flex;flex-direction:column;gap:10px;}
.preview-container .document-info{background:#fff;padding:10px;border-radius:5px;border-left:4px solid #3498db;}
.preview-container .document-info h4{color:#2c3e50;margin-bottom:5px;}
.preview-container .document-info p{color:#7f8c8d;font-size:12px;}
.preview-container embed,.preview-container img{width:100%;max-height:300px;border-radius:6px;object-fit:contain;border:1px solid #ddd;}
.preview-container a{align-self:flex-start;text-decoration:none;color:#2980b9;font-weight:bold;padding:5px 10px;background:#ecf0f1;border-radius:4px;}
.qr-section{background:#fff;padding:15px;border-radius:8px;text-align:center;border:2px solid #3498db;margin-bottom:15px;}
.qr-section h3{color:#2c3e50;margin-bottom:10px;}
.qr-info{background:#e8f6ff;padding:10px;border-radius:6px;margin-top:10px;border:1px solid #3498db;}
.qr-info p{margin:3px 0;font-size:12px;color:#2c3e50;}
.qr-info .qr-url{background:#fff;padding:8px;margin:5px 0;border-radius:4px;word-break:break-all;font-family:monospace;font-size:13px;border:1px solid #bdc3c7;max-height:60px;overflow-y:auto;}
.document-summary{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #27ae60;}
.document-summary h3{color:#2c3e50;margin-bottom:10px;}
.document-summary table{width:100%;border-collapse:collapse;}
.document-summary table td{padding:5px;border-bottom:1px solid #ecf0f1;}
.document-summary table td:first-child{font-weight:bold;width:30%;}
.form-type-indicator{background:#e8f4f8;border:2px solid #3498db;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;}
.form-type-indicator h3{color:#2c3e50;margin:0;}
.test-qr-btn{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;margin:5px;font-size:12px;}
.test-qr-btn:hover{background:#c0392b;}
.content-page{display:none;}
.content-page.active{display:block;}
.document-label{display:block;margin-bottom:10px;font-weight:600;color:#2c3e50;}
.document-label input{margin-top:5px;}
.upload-status{background:#e8f5e8;border:1px solid #4caf50;color:#2e7d32;padding:10px;border-radius:6px;margin:10px 0;display:none;}
.upload-error{background:#ffebee;border:1px solid #f44336;color:#c62828;padding:10px;border-radius:6px;margin:10px 0;display:none;}
.google-drive-status{background:#e3f2fd;border:1px solid #2196f3;color:#1565c0;padding:10px;border-radius:6px;margin:10px 0;text-align:center;}
.progress-bar{width:100%;background:#f0f0f0;border-radius:4px;overflow:hidden;margin:10px 0;display:none;}
.progress-fill{height:20px;background:#4caf50;border-radius:4px;transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:bold;}
.footer-login{text-align:center;padding:15px;color:#6c757d;font-size:12px;border-top:1px solid #e9ecef;}
.status-indicator{
  position:fixed;
  top:20px;
  right:20px;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
  font-size:12px;
  z-index:1000;
  display:none;
}
.status-indicator.show{display:block;}
.status-indicator.success{border-left:4px solid #4caf50;}
.status-indicator.error{border-left:4px solid #f44336;}
.status-indicator.info{border-left:4px solid #2196f3;}
</style>
</head>
<body>

<!-- Status Indicator -->
<div id="statusIndicator" class="status-indicator">
  <div id="statusContent">Ready</div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <div class="logo-section">
    <a href="#" class="logo">
      <div class="logo-icon">
        <i class="fas fa-anchor"></i>
      </div>
      SANDAR-RATU
    </a>
  </div>
  
  <div class="warning-section">
    <div class="warning-title">Peringatan</div>
    <div class="warning-text">
      Halaman ini memerlukan autentikasi.<br>
      Silahkan klik tombol login di bawah untuk melanjutkan.<br>
      Terima kasih.
    </div>
  </div>
  
  <div class="login-method-section">
    <div class="method-title">- select login method -</div>
    
    <!-- Simple Demo Login -->
    <button id="demoLoginBtn" class="simple-login-btn">
      <i class="fas fa-user"></i> Demo Login (Tanpa Google)
    </button>
    
    <!-- Google Login (akan dimuat secara lazy) -->
    <button id="googleLoginBtn" class="google-login-btn" style="display:none;">
      <div class="loading-spinner"></div>
      <span>Memuat Google APIs...</span>
    </button>
    
    <button id="enableGoogleBtn" class="google-login-btn">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Log in with Google
    </button>
  </div>
  
  <div class="footer-login">Hak Cipta ¬© 2025 Sandar-Ratu</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard">
  <div class="header">
    <div style="display:flex;align-items:center;">
      <div class="logo-icon"><i class="fas fa-anchor"></i></div>
      <strong>SANDAR-RATU</strong>
    </div>
    <div style="display:flex;align-items:center;gap:15px;">
      <div class="user-info">
        <img id="userAvatar" class="user-avatar" src="https://via.placeholder.com/32" alt="User">
        <span id="userName">User</span>
      </div>
      <button class="btn-logout" onclick="logout()">Keluar</button>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar">
      <div>üë®‚Äç‚úàÔ∏è Petugas</div>
      <a onclick="showPage('departurePetugas', this)"><i class="fas fa-anchor"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalPetugas', this)"><i class="fas fa-ship"></i>&nbsp; Kedatangan</a>
      <div>üö¢ Nelayan</div>
      <a onclick="showPage('departureNelayan', this)"><i class="fas fa-fish"></i>&nbsp; Keberangkatan</a>
      <a onclick="showPage('arrivalNelayan', this)"><i class="fas fa-water"></i>&nbsp; Kedatangan</a>
    </div>

    <div class="content" id="mainContent">
      <!-- Content pages will be generated by JavaScript -->
    </div>
  </div>
</div>

<!-- Scripts loaded at the end for faster initial loading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

<script>
// Global variables
let currentUser = null;
let isGoogleDriveReady = false;
let googleAuth = null;
let scriptsLoaded = false;
let demoMode = false;

// Configuration
const CLIENT_ID = "180722419885-tgptv8houl6ockqsjk0gqjus8cj4a6ue.apps.googleusercontent.com";
const API_KEY = "AIzaSyAWrUdv79vEKgd3YVkYsHvfwS3-vKev_lk";
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// Folder mapping
const FOLDER_MAP = {
  "Petugas-Keberangkatan": "1OtloxktgdBBSFLwh1CUqYsYk25l2fsBH",
  "Petugas-Kedatangan": "1Z6fEANltfHjUsRnluXs6j6RE31rCczIk",
  "Nelayan-Keberangkatan": "1jBtsh2mj2oF2oyiJMu_subw_qo-C1FRv",
  "Nelayan-Kedatangan": "1AYPXMwl47Uj0p8SfxlVz7VmMVUP4l521"
};

// Status indicator functions
function showStatus(message, type = 'info', duration = 3000) {
  const indicator = document.getElementById('statusIndicator');
  const content = document.getElementById('statusContent');
  
  content.textContent = message;
  indicator.className = `status-indicator show ${type}`;
  
  if (duration > 0) {
    setTimeout(() => {
      indicator.classList.remove('show');
    }, duration);
  }
}

// Demo login function
function demoLogin() {
  showStatus('Demo login berhasil', 'success');
  
  currentUser = {
    id: 'demo-user',
    name: 'Demo User',
    email: 'demo@sandar-ratu.com',
    picture: 'https://via.placeholder.com/32'
  };
  
  demoMode = true;
  showDashboard();
}

// Enable Google Login (lazy loading)
function enableGoogleLogin() {
  const enableBtn = document.getElementById('enableGoogleBtn');
  const googleBtn = document.getElementById('googleLoginBtn');
  
  enableBtn.style.display = 'none';
  googleBtn.style.display = 'flex';
  
  showStatus('Memuat Google APIs...', 'info', 0);
  
  // Load Google APIs scripts
  loadGoogleScripts().then(() => {
    initializeGoogleAPIs();
  }).catch(error => {
    showStatus('Gagal memuat Google APIs', 'error');
    console.error('Failed to load Google APIs:', error);
    enableBtn.style.display = 'flex';
    googleBtn.style.display = 'none';
  });
}

// Load Google Scripts dynamically
function loadGoogleScripts() {
  return new Promise((resolve, reject) => {
    if (window.gapi && window.google) {
      resolve();
      return;
    }
    
    let scriptsToLoad = 2;
    let scriptsLoaded = 0;
    
    function checkComplete() {
      scriptsLoaded++;
      if (scriptsLoaded >= scriptsToLoad) {
        resolve();
      }
    }
    
    // Load Google Sign-In
    const gsiScript = document.createElement('script');
    gsiScript.src = 'https://accounts.google.com/gsi/client';
    gsiScript.onload = checkComplete;
    gsiScript.onerror = reject;
    document.head.appendChild(gsiScript);
    
    // Load Google APIs
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.onload = checkComplete;
    gapiScript.onerror = reject;
    document.head.appendChild(gapiScript);
  });
}

// Initialize Google APIs
async function initializeGoogleAPIs() {
  try {
    showStatus('Inisialisasi Google APIs...', 'info', 0);
    
    // Wait for gapi to be ready
    await new Promise((resolve) => {
      gapi.load('client:auth2', resolve);
    });
    
    // Initialize the API client
    await gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: [DISCOVERY_DOC],
      scope: SCOPES
    });

    googleAuth = gapi.auth2.getAuthInstance();
    isGoogleDriveReady = true;
    
    showStatus('Google Drive siap', 'success');
    
    // Update button
    const googleBtn = document.getElementById('googleLoginBtn');
    googleBtn.innerHTML = `
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      <span>Log in with Google</span>
    `;
    googleBtn.disabled = false;
    
    // Check if already signed in
    if (googleAuth.isSignedIn.get()) {
      const user = googleAuth.currentUser.get();
      const profile = user.getBasicProfile();
      
      currentUser = {
        id: profile.getId(),
        name: profile.getName(),
        email: profile.getEmail(),
        picture: profile.getImageUrl()
      };
      
      showDashboard();
    }
    
  } catch (error) {
    showStatus('Error: ' + error.message, 'error');
    console.error('Error initializing Google APIs:', error);
  }
}

// Google Login
async function googleLogin() {
  if (!isGoogleDriveReady) {
    showStatus('Google APIs belum siap', 'error');
    return;
  }
  
  try {
    showStatus('Proses login...', 'info', 0);
    
    const user = await googleAuth.signIn();
    const profile = user.getBasicProfile();
    
    currentUser = {
      id: profile.getId(),
      name: profile.getName(),
      email: profile.getEmail(),
      picture: profile.getImageUrl()
    };
    
    showStatus('Login berhasil', 'success');
    showDashboard();
    
  } catch (error) {
    showStatus('Login gagal: ' + (error.error || 'Unknown error'), 'error');
    console.error('Sign-in failed:', error);
  }
}

// Show dashboard
function showDashboard() {
  if (!currentUser) {
    showStatus('Data user tidak tersedia', 'error');
    return;
  }
  
  // Update UI with user info
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userAvatar').src = currentUser.picture;
  
  // Show dashboard
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("dashboard").style.display = "flex";
  document.body.style.background = "white";
  
  // Initialize pages and show first page
  initializePages();
  showPage('departurePetugas', document.querySelector(".sidebar a"));
  
  showStatus('Dashboard dimuat', 'success');
}

// Update Google Drive connection status
function updateGoogleDriveStatus(errorMsg = null) {
  const statusElements = document.querySelectorAll('.google-drive-status');
  statusElements.forEach(el => {
    if (errorMsg) {
      el.style.background = '#ffebee';
      el.style.borderColor = '#f44336';
      el.style.color = '#c62828';
      el.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
    } else if (demoMode) {
      el.style.background = '#fff3e0';
      el.style.borderColor = '#ff9800';
      el.style.color = '#f57c00';
      el.innerHTML = '<i class="fas fa-info-circle"></i> Mode Demo - Upload ke Google Drive tidak aktif';
    } else if (isGoogleDriveReady && googleAuth && googleAuth.isSignedIn.get()) {
      el.style.background = '#e8f5e8';
      el.style.borderColor = '#4caf50';
      el.style.color = '#2e7d32';
      el.innerHTML = '<i class="fas fa-check-circle"></i> Google Drive terhubung dan siap digunakan';
    } else {
      el.style.background = '#e3f2fd';
      el.style.borderColor = '#2196f3';
      el.style.color = '#1565c0';
      el.innerHTML = '<i class="fas fa-info-circle"></i> Silakan login Google untuk mengaktifkan upload';
    }
  });
}

// Upload to Google Drive (simplified for demo)
async function uploadToGoogleDrive(btn) {
  if (demoMode) {
    showStatus('Mode demo - upload disimulasikan', 'info');
    simulateUpload(btn);
    return;
  }
  
  if (!isGoogleDriveReady || !googleAuth || !googleAuth.isSignedIn.get()) {
    showStatus('Anda harus login Google terlebih dahulu', 'error');
    return;
  }
  
  // Real Google Drive upload logic would go here
  showStatus('Upload ke Google Drive...', 'info');
  
  // For now, just simulate
  simulateUpload(btn);
}

// Simulate upload for demo
function simulateUpload(btn) {
  const form = btn.closest("form");
  const progressBar = form.querySelector('.progress-bar');
  const progressFill = form.querySelector('.progress-fill');
  const statusDiv = form.querySelector('.upload-status');
  
  btn.disabled = true;
  progressBar.style.display = 'block';
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 20;
    if (progress >= 100) {
      progress = 100;
      clearInterval(interval);
      
      progressFill.style.width = '100%';
      progressFill.textContent = '100%';
      
      statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Simulasi upload berhasil!';
      statusDiv.style.display = 'block';
      
      btn.disabled = false;
      
      setTimeout(() => {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
      }, 2000);
      
      showStatus('Upload selesai (demo)', 'success');
    } else {
      progressFill.style.width = progress + '%';
      progressFill.textContent = Math.round(progress) + '%';
    }
  }, 200);
}

// Logout function
function logout() {
  if (googleAuth && googleAuth.isSignedIn.get()) {
    googleAuth.signOut();
  }
  
  currentUser = null;
  demoMode = false;
  
  // Show login page
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("loginPage").style.display = "block";
  document.body.style.background = "#f8f9fa";
  
  // Clear content
  document.getElementById("mainContent").innerHTML = "";
  
  showStatus('Logout berhasil', 'success');
}

// Show page function
function showPage(pageId, el) {
  // Hide all pages
  document.querySelectorAll(".content-page").forEach(p => p.style.display = "none");
  
  // Show selected page
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
    targetPage.style.display = "block";
  }
  
  // Update active menu
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  if (el) {
    el.classList.add("active");
  }
}

// Menu configuration
const menu = [
  {id:'departurePetugas', title:'‚öì Petugas - Keberangkatan', type: 'departure', category: 'Petugas'},
  {id:'arrivalPetugas', title:'‚öì Petugas - Kedatangan', type: 'arrival', category: 'Petugas'},
  {id:'departureNelayan', title:'üö¢ Nelayan - Keberangkatan', type: 'departure', category: 'Nelayan'},
  {id:'arrivalNelayan', title:'üö¢ Nelayan - Kedatangan', type: 'arrival', category: 'Nelayan'}
];

// Document lists
const departurePetugasDocuments = [
  'SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda',
  'Kwitansi Tambat Labuh', 'Permohonan Penerbitan SPB', 'Daftar ABK', 'STBLKK', 'Faktur BBM'
];

const departureNelayanDocuments = [
  'SPB', 'Crew List', 'Perbekalan', 'SLO', 'Pernyataan Nahkoda'
];

const arrivalDocuments = [
  'STBLKK', 'Rekom Bongkar', 'SPB Asal'
];

// Initialize pages
function initializePages() {
  const contentDiv = document.getElementById("mainContent");
  contentDiv.innerHTML = "";
  
  menu.forEach(m => {
    const div = document.createElement('div');
    div.id = m.id;
    div.className = 'content-page';
    
    let documents;
    if (m.type === 'arrival') {
      documents = arrivalDocuments;
    } else if (m.id === 'departurePetugas') {
      documents = departurePetugasDocuments;
    } else if (m.id === 'departureNelayan') {
      documents = departureNelayanDocuments;
    } else {
      documents = departurePetugasDocuments;
    }
    
    const documentInputs = documents.map(doc => 
      `<label class="document-label">${doc}: 
        <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
      </label>`
    ).join('');

    div.innerHTML = `
      <h2>${m.title}</h2>
      <div class="card">
        <div class="form-type-indicator">
          <h3>üìã Form ${m.category} - ${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}</h3>
        </div>
        
        <div class="google-drive-status">
          <i class="fas fa-info-circle"></i> Status akan diperbarui setelah login
        </div>
        
        <form data-form-type="${m.category}-${m.type === 'departure' ? 'Keberangkatan' : 'Kedatangan'}">
          <input type="text" class="form-control" placeholder="Nama Kapal" required>
          <div class="form-row">
            <input type="date" class="form-control" required>
            <input type="time" class="form-control" required>
          </div>
          <input type="text" class="form-control" placeholder="Nama Nahkoda" required>
          <input type="text" class="form-control" placeholder="GT">
          <h4 style="margin:15px 0 10px;color:#2c3e50;">üìé Upload Dokumen</h4>
          ${documentInputs}
          <button type="button" class="btn-generate" onclick="generateAll(this)">Generate QR & Preview</button>
          <button type="button" class="btn-upload-drive" onclick="uploadToGoogleDrive(this)">
            <i class="fab fa-google-drive"></i> Upload ke Google Drive
          </button>
          <button type="button" class="btn-generate" onclick="downloadAll(this)">‚¨á Download Semua Dokumen + QR PDF</button>
          
          <div class="progress-bar">
            <div class="progress-fill" style="width: 0%;">0%</div>
          </div>
          <div class="upload-status"></div>
          <div class="upload-error"></div>
        </form>
        <div class="result-container"></div>
      </div>
    `;
    
    contentDiv.appendChild(div);
  });
  
  // Set default date and time
  const today = new Date().toISOString().split("T")[0];
  const now = new Date().toTimeString().slice(0, 5);
  
  document.querySelectorAll('input[type="date"]').forEach(input => {
    input.value = today;
  });
  
  document.querySelectorAll('input[type="time"]').forEach(input => {
    input.value = now;
  });
  
  // Update Google Drive status
  setTimeout(() => {
    updateGoogleDriveStatus();
  }, 100);
}

// Generate QR and preview (simplified version)
function generateAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  const formType = form.getAttribute('data-form-type');
  resultBox.innerHTML = "";

  // Get form data
  const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
  const date = form.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
  const time = form.querySelector('input[type="time"]').value || "00:00";
  const captain = form.querySelectorAll('input[type="text"]')[1].value || "Nahkoda";
  const gt = form.querySelectorAll('input[type="text"]')[2].value || "-";
  
  if (!shipName.trim()) {
    showStatus('Nama kapal harus diisi', 'error');
    return;
  }
  
  const formattedDate = date.replace(/-/g, '');
  const formattedTime = time.replace(':', '');
  const code = `SANDAR-${shipName.replace(/\s+/g, '')}-${formattedDate}-${formattedTime}`;

  // Document summary
  const summaryDiv = document.createElement("div");
  summaryDiv.className = "document-summary";
  summaryDiv.innerHTML = `
    <h3>üìã Ringkasan Dokumen</h3>
    <table>
      <tr><td>Jenis Form:</td><td><strong>${formType}</strong></td></tr>
      <tr><td>Nama Kapal:</td><td>${shipName}</td></tr>
      <tr><td>Tanggal:</td><td>${new Date(date).toLocaleDateString('id-ID')}</td></tr>
      <tr><td>Waktu:</td><td>${time}</td></tr>
      <tr><td>Nahkoda:</td><td>${captain}</td></tr>
      <tr><td>GT:</td><td>${gt}</td></tr>
      <tr><td>Kode Dokumen:</td><td><strong>${code}</strong></td></tr>
      <tr><td>Petugas:</td><td><strong>${currentUser ? currentUser.name : 'Unknown'}</strong></td></tr>
      <tr><td>Dibuat:</td><td>${new Date().toLocaleString('id-ID')}</td></tr>
    </table>
  `;
  resultBox.appendChild(summaryDiv);

  // QR Code section (simplified - will work when QRCode library loads)
  const qrSection = document.createElement("div");
  qrSection.className = "qr-section";
  qrSection.innerHTML = `<h3>üî≤ QR Code Dokumen</h3>`;
  
  const qrDiv = document.createElement("div");
  qrDiv.id = `qrcode-${Date.now()}`;
  qrDiv.style.minHeight = '200px';
  qrDiv.style.display = 'flex';
  qrDiv.style.alignItems = 'center';
  qrDiv.style.justifyContent = 'center';
  qrDiv.style.border = '2px dashed #ddd';
  qrDiv.style.borderRadius = '8px';
  
  // Create QR URL
  const baseUrl = `https://drive.google.com/drive/folders/1ZpBOs2z1OkHMWFW5Zy4D4_fd_3v62xOa`;
  const params = new URLSearchParams({
    code: code,
    type: formType,
    ship: shipName,
    date: date,
    time: time,
    captain: captain,
    gt: gt,
    officer: currentUser ? currentUser.name : 'Unknown'
  });
  const qrUrl = `${baseUrl}?${params.toString()}`;
  
  // Generate QR Code if library is available
  if (typeof QRCode !== 'undefined') {
    try {
      new QRCode(qrDiv, {
        text: qrUrl,
        width: 200,
        height: 200,
        colorDark: "#2c3e50",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M
      });
    } catch (error) {
      qrDiv.innerHTML = '<p style="color: #666;">QR Code akan muncul setelah library dimuat</p>';
    }
  } else {
    qrDiv.innerHTML = '<p style="color: #666;">QR Code akan muncul setelah library dimuat</p>';
  }
  
  qrSection.appendChild(qrDiv);
  
  // QR Info
  const qrInfo = document.createElement("div");
  qrInfo.className = "qr-info";
  qrInfo.innerHTML = `
    <p><strong>üîó URL QR Code:</strong></p>
    <div class="qr-url">${qrUrl}</div>
    <p><strong>üìè Panjang URL:</strong> ${qrUrl.length} karakter</p>
    <p><strong>üìÅ Folder:</strong> ${formType}</p>
    <p><strong>üë§ Petugas:</strong> ${currentUser ? currentUser.name : 'Unknown'}</p>
    <button class="test-qr-btn" onclick="copyToClipboard('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">üìã Copy URL</button>
    <button class="test-qr-btn" onclick="window.open('${qrUrl.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '_blank')">üîó Test URL</button>
  `;
  qrSection.appendChild(qrInfo);
  resultBox.appendChild(qrSection);

  // Preview uploaded documents
  let docCount = 0;
  const fileInputs = form.querySelectorAll('input[type="file"]');
  
  fileInputs.forEach((fileInput) => {
    if (fileInput.files[0]) {
      docCount++;
      const file = fileInput.files[0];
      const label = fileInput.parentElement.textContent.split(':')[0];
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const previewContainer = document.createElement("div");
        previewContainer.className = "preview-container";
        
        // Document info
        const docInfo = document.createElement("div");
        docInfo.className = "document-info";
        docInfo.innerHTML = `
          <h4>${label}</h4>
          <p>üìÑ ${file.name} | üìè ${(file.size/1024).toFixed(2)} KB | üìÖ ${new Date().toLocaleDateString('id-ID')}<br>
          <strong>üìã Jenis: ${formType}</strong> | üë§ <strong>Petugas: ${currentUser ? currentUser.name : 'Unknown'}</strong></p>
        `;
        previewContainer.appendChild(docInfo);
        
        // Preview element
        let previewEl;
        if (file.type.includes("pdf")) {
          previewEl = document.createElement("embed");
          previewEl.src = e.target.result;
          previewEl.type = "application/pdf";
        } else if (file.type.includes("image")) {
          previewEl = document.createElement("img");
          previewEl.src = e.target.result;
          previewEl.alt = file.name;
        } else {
          previewEl = document.createElement("div");
          previewEl.innerHTML = `<p style="text-align:center;padding:50px;color:#7f8c8d;">üìÑ ${file.name}<br><small>Preview tidak tersedia untuk tipe file ini</small></p>`;
        }
        previewContainer.appendChild(previewEl);

        // Download link
        const downloadLink = document.createElement("a");
        downloadLink.href = e.target.result;
        downloadLink.download = `[${formType}]_${code}_${label}_${file.name}`;
        downloadLink.textContent = `‚¨á Download ${label}`;
        previewContainer.appendChild(downloadLink);

        resultBox.appendChild(previewContainer);
      };
      reader.readAsDataURL(file);
    }
  });
  
  if (docCount === 0) {
    showStatus('Silakan upload minimal satu dokumen', 'error');
    return;
  }
  
  showStatus('QR Code dan preview berhasil dibuat', 'success');
}

// Helper functions
function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showStatus('URL berhasil disalin ke clipboard', 'success');
    }).catch(() => {
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}

function fallbackCopyToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-999999px";
  textArea.style.top = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    showStatus('URL berhasil disalin ke clipboard', 'success');
  } catch (err) {
    showStatus('Gagal menyalin URL', 'error');
  }
  document.body.removeChild(textArea);
}

// Download all documents as PDF (simplified)
function downloadAll(btn) {
  const form = btn.closest("form");
  const resultBox = form.nextElementSibling;
  
  if (!resultBox.innerHTML.trim()) {
    showStatus('Generate QR & Preview terlebih dahulu', 'error');
    return;
  }

  // Check if jsPDF is available
  if (typeof window.jspdf === 'undefined') {
    showStatus('PDF library sedang dimuat, silakan coba lagi', 'error');
    return;
  }

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Simple PDF content
    pdf.setFontSize(20);
    pdf.text('SANDAR-RATU', 20, 30);
    pdf.setFontSize(14);
    pdf.text('Dokumen Kesyahbandaran', 20, 45);
    
    const formType = form.getAttribute('data-form-type');
    const shipName = form.querySelector('input[type="text"]').value || "KAPAL";
    const date = form.querySelector('input[type="date"]').value;
    
    pdf.setFontSize(12);
    pdf.text(`Jenis Form: ${formType}`, 20, 65);
    pdf.text(`Nama Kapal: ${shipName}`, 20, 80);
    pdf.text(`Tanggal: ${new Date(date).toLocaleDateString('id-ID')}`, 20, 95);
    pdf.text(`Petugas: ${currentUser ? currentUser.name : 'Unknown'}`, 20, 110);
    pdf.text(`Dibuat: ${new Date().toLocaleString('id-ID')}`, 20, 125);
    
    // Add QR code if available
    const qrCanvas = resultBox.querySelector('canvas');
    if (qrCanvas) {
      const imgData = qrCanvas.toDataURL('image/png');
      pdf.addImage(imgData, 'PNG', 20, 140, 50, 50);
    }
    
    const fileName = `SANDAR_RATU_${shipName.replace(/\s+/g,'_')}_${date.replace(/-/g,'')}.pdf`;
    pdf.save(fileName);
    
    showStatus('PDF berhasil didownload', 'success');
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    showStatus('Terjadi error saat membuat PDF', 'error');
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  showStatus('Aplikasi siap digunakan', 'success');
  
  // Demo login event
  document.getElementById('demoLoginBtn').addEventListener('click', demoLogin);
  
  // Enable Google login event
  document.getElementById('enableGoogleBtn').addEventListener('click', enableGoogleLogin);
  
  // Google login event (will be attached after Google APIs load)
  document.getElementById('googleLoginBtn').addEventListener('click', googleLogin);
});

// Load external scripts after initial load for better performance
window.addEventListener('load', function() {
  // Scripts are already loaded via defer attribute
  setTimeout(() => {
    scriptsLoaded = true;
  }, 1000);
});
